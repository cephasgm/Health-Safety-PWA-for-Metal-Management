// Management Reporting Dashboard
class ReportingDashboard {
  constructor() {
    this.reportTypes = {
      'incident_trends': 'Incident Trends Analysis',
      'compliance_status': 'Compliance Status Report',
      'training_completion': 'Training Completion Report',
      'ppe_utilization': 'PPE Utilization Report',
      'safety_kpis': 'Safety KPI Dashboard',
      'audit_findings': 'Audit Findings Summary'
    };
  }

  async generateReport(type, filters = {}) {
    try {
      const reportData = await this.fetchReportData(type, filters);
      const htmlReport = this.generateHTMLReport(type, reportData);
      const pdfUrl = await this.generatePDF(htmlReport);
      
      return {
        success: true,
        type: type,
        data: reportData,
        html: htmlReport,
        pdfUrl: pdfUrl,
        generatedAt: new Date().toISOString()
      };
    } catch (error) {
      console.error('Report generation failed:', error);
      return { success: false, error: error.message };
    }
  }

  async fetchReportData(type, filters) {
    // Fetch data from Firebase based on report type
    switch(type) {
      case 'incident_trends':
        return await this.getIncidentTrends(filters);
      case 'compliance_status':
        return await this.getComplianceStatus(filters);
      case 'training_completion':
        return await this.getTrainingCompletion(filters);
      default:
        return {};
    }
  }

  async getIncidentTrends(filters) {
    const incidents = await window.mmsDB.getIncidents(filters);
    
    if (!incidents.success) return { trends: [] };
    
    // Analyze trends
    const byMonth = {};
    const byType = {};
    const byLocation = {};
    const bySeverity = {};
    
    incidents.data.forEach(incident => {
      // Monthly analysis
      const month = new Date(incident.date_time).toLocaleString('default', { month: 'short', year: 'numeric' });
      byMonth[month] = (byMonth[month] || 0) + 1;
      
      // Type analysis
      byType[incident.type] = (byType[incident.type] || 0) + 1;
      
      // Location analysis
      byLocation[incident.location] = (byLocation[incident.location] || 0) + 1;
      
      // Severity analysis
      bySeverity[incident.severity] = (bySeverity[incident.severity] || 0) + 1;
    });
    
    return {
      summary: {
        totalIncidents: incidents.data.length,
        averagePerMonth: Object.values(byMonth).reduce((a, b) => a + b, 0) / Object.keys(byMonth).length,
        mostCommonType: Object.keys(byType).reduce((a, b) => byType[a] > byType[b] ? a : b),
        highestLocation: Object.keys(byLocation).reduce((a, b) => byLocation[a] > byLocation[b] ? a : b)
      },
      trends: {
        monthly: byMonth,
        byType: byType,
        byLocation: byLocation,
        bySeverity: bySeverity
      },
      incidents: incidents.data.slice(0, 10) // Top 10 recent
    };
  }

  generateHTMLReport(type, data) {
    return `
      <!DOCTYPE html>
      <html>
      <head>
        <style>
          body { font-family: 'Segoe UI', sans-serif; margin: 2rem; }
          .header { text-align: center; margin-bottom: 2rem; }
          .logo { font-size: 2rem; color: #dc2626; font-weight: bold; }
          .report-title { color: #1e293b; margin: 1rem 0; }
          .summary-card { background: #f8fafc; padding: 1.5rem; border-radius: 8px; margin: 1rem 0; }
          .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin: 1.5rem 0; }
          .kpi-card { background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; }
          .kpi-value { font-size: 2rem; font-weight: bold; color: #dc2626; }
          .kpi-label { color: #64748b; font-size: 0.9rem; }
          table { width: 100%; border-collapse: collapse; margin: 1.5rem 0; }
          th { background: #f1f5f9; padding: 0.75rem; text-align: left; }
          td { padding: 0.75rem; border-bottom: 1px solid #e2e8f0; }
          .footer { margin-top: 3rem; color: #64748b; font-size: 0.9rem; text-align: center; }
        </style>
      </head>
      <body>
        <div class="header">
          <div class="logo">MMS</div>
          <h1 class="report-title">${this.reportTypes[type] || 'Safety Report'}</h1>
          <div>Generated: ${new Date().toLocaleDateString()} • Period: ${data.filters?.period || 'All time'}</div>
        </div>
        
        ${this.generateReportContent(type, data)}
        
        <div class="footer">
          <div>Metal Management Solutions - Safety Management System</div>
          <div>Confidential - For internal use only</div>
          <div>Page 1 of 1 • Generated by: ${window.mmsAuth?.currentUser?.email || 'System'}</div>
        </div>
      </body>
      </html>
    `;
  }

  generateReportContent(type, data) {
    if (type === 'incident_trends') {
      return `
        <div class="summary-card">
          <h3>Executive Summary</h3>
          <div class="kpi-grid">
            <div class="kpi-card">
              <div class="kpi-value">${data.summary?.totalIncidents || 0}</div>
              <div class="kpi-label">Total Incidents</div>
            </div>
            <div class="kpi-card">
              <div class="kpi-value">${data.summary?.averagePerMonth?.toFixed(1) || 0}</div>
              <div class="kpi-label">Avg/Month</div>
            </div>
            <div class="kpi-card">
              <div class="kpi-value">${data.summary?.mostCommonType || 'N/A'}</div>
              <div class="kpi-label">Most Common Type</div>
            </div>
            <div class="kpi-card">
              <div class="kpi-value">${data.summary?.highestLocation || 'N/A'}</div>
              <div class="kpi-label">Highest Location</div>
            </div>
          </div>
        </div>
        
        <h3>Recent Incidents</h3>
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Type</th>
              <th>Location</th>
              <th>Severity</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            ${(data.incidents || []).map(incident => `
              <tr>
                <td>${new Date(incident.date_time).toLocaleDateString()}</td>
                <td>${incident.type}</td>
                <td>${incident.location}</td>
                <td>${incident.severity}</td>
                <td>${incident.status}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }
    
    return '<p>Report content would be generated here.</p>';
  }

  async generatePDF(htmlContent) {
    // Use jsPDF or similar library to generate PDF
    // For now, return HTML for display
    return `data:text/html;charset=utf-8,${encodeURIComponent(htmlContent)}`;
  }
}

window.reportingDashboard = new ReportingDashboard();
