<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=5, viewport-fit=cover">
    <title>Health & Safety - MMS ERP</title>
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="./manifest.json" crossorigin="use-credentials">
    <link rel="icon" href="./icon-128x128.png" type="image/png">
    <link rel="apple-touch-icon" href="./icon-144x144.png">
    <meta name="application-name" content="MMS Safety">
    <meta name="apple-mobile-web-app-title" content="MMS Safety">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#dc2626">
    <meta name="msapplication-TileColor" content="#dc2626">
    <meta name="msapplication-TileImage" content="./icon-152x152.png">
    <meta name="msapplication-config" content="none">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary: #dc2626;
            --primary-dark: #b91c1c;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --background: #f1f5f9;
            --surface: #ffffff;
            --text: #1e293b;
            --text-light: #64748b;
            --border: #e2e8f0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--background);
            color: var(--text);
            line-height: 1.6;
            background-image: url('https://images.unsplash.com/photo-1581094794329-c8112a89af12?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80');
            background-size: cover;
            background-attachment: fixed;
            background-position: center;
            background-blend-mode: overlay;
            background-color: rgba(241, 245, 249, 0.95);
        }

        .dashboard {
            display: grid;
            grid-template-columns: 280px 1fr;
            min-height: 100vh;
        }

        .sidebar {
            background: rgba(255, 255, 255, 0.95);
            border-right: 1px solid var(--border);
            padding: 2rem 1rem;
            position: fixed;
            width: 280px;
            height: 100vh;
            overflow-y: auto;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 2rem;
            padding: 0 1rem;
            text-decoration: none;
            color: inherit;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: var(--primary);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.25rem;
            background-image: url('https://raw.githubusercontent.com/yourusername/Health-Safety-PWA-for-Metal-Management/main/icon-192.png');
            background-size: cover;
            background-position: center;
        }

        .nav-section {
            margin-bottom: 2rem;
        }

        .nav-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--text-light);
            margin-bottom: 1rem;
            padding: 0 1rem;
            letter-spacing: 0.5px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            color: var(--text-light);
            text-decoration: none;
            transition: all 0.2s;
            margin-bottom: 0.25rem;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
            font-size: 0.95rem;
        }

        .nav-item:hover, .nav-item.active {
            background: var(--primary);
            color: white;
        }

        .nav-icon {
            font-size: 1.25rem;
            width: 24px;
            text-align: center;
        }

        .main-content {
            grid-column: 2;
            padding: 2rem;
            margin-left: 280px;
            background: rgba(255, 255, 255, 0.9);
            min-height: 100vh;
            backdrop-filter: blur(5px);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
            background: rgba(255, 255, 255, 0.7);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid rgba(220, 38, 38, 0.1);
        }

        .header h1 {
            font-size: 1.875rem;
            font-weight: 700;
            color: var(--primary);
        }

        /* Enhanced Statistics Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 250, 252, 0.9) 100%);
            padding: 1.5rem;
            border-radius: 16px;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            backdrop-filter: blur(10px);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border-color: var(--primary);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), #ef4444);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 0.5rem;
            position: relative;
        }

        .stat-label {
            color: var(--text-light);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .stat-details {
            margin-top: 1rem;
            font-size: 0.85rem;
            color: var(--text-light);
            display: none;
            border-top: 1px solid var(--border);
            padding-top: 1rem;
        }

        .stat-card:hover .stat-details {
            display: block;
        }

        /* Enhanced Chart Container */
        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 1.25rem;
            border-radius: 16px;
            border: 1px solid var(--border);
            margin-bottom: 2rem;
            height: 450px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            backdrop-filter: blur(10px);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .chart-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .chart-subtitle {
            color: var(--text-light);
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        .chart-controls {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .chart-type-selector {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .chart-type-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--background);
            color: var(--text);
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .chart-type-btn:hover {
            border-color: var(--primary);
            background: var(--surface);
        }

        .chart-type-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .custom-calendar {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .date-input {
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--surface);
            font-family: inherit;
            font-size: 0.875rem;
        }

        .date-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
        }

        /* Enhanced Risk Assessment Matrix */
        .risk-matrix {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 250, 252, 0.9) 100%);
            border-radius: 16px;
            border: 1px solid var(--border);
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            backdrop-filter: blur(10px);
        }

        .matrix-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .matrix-cell {
            padding: 1.5rem 1rem;
            border-radius: 12px;
            text-align: center;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            border: 2px solid transparent;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .matrix-cell:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }

        .risk-low { 
            background: linear-gradient(135deg, #dcfce7, #bbf7d0);
            color: #166534; 
            border-color: #86efac;
        }
        .risk-medium { 
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            color: #92400e; 
            border-color: #fcd34d;
        }
        .risk-high { 
            background: linear-gradient(135deg, #fed7aa, #fdba74);
            color: #9a3412; 
            border-color: #fb923c;
        }
        .risk-very-high { 
            background: linear-gradient(135deg, #fecaca, #fca5a5);
            color: #991b1b; 
            border-color: #f87171;
        }
        .risk-extreme { 
            background: linear-gradient(135deg, #fca5a5, #f87171);
            color: #7f1d1d; 
            border-color: #ef4444;
        }

        /* Enhanced Tables with Full Edit */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .data-table th,
        .data-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .data-table th {
            background: var(--background);
            font-weight: 600;
            color: var(--text);
            position: sticky;
            top: 0;
        }

        .data-table tbody tr:hover {
            background: var(--background);
        }

        .data-table td.editable {
            cursor: pointer;
            position: relative;
            transition: background-color 0.2s;
        }

        .data-table td.editable:hover {
            background: rgba(220, 38, 38, 0.05);
        }

        .data-table td.editing {
            background: rgba(220, 38, 38, 0.1);
            border: 1px solid var(--primary);
            border-radius: 4px;
            padding: 0.5rem;
        }

        .edit-input {
            width: 100%;
            padding: 0.5rem;
            border: 2px solid var(--primary);
            border-radius: 6px;
            font-family: inherit;
            font-size: inherit;
            background: var(--surface);
            color: var(--text);
            outline: none;
        }

        .edit-input:focus {
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
        }

        .edit-select {
            width: 100%;
            padding: 0.5rem;
            border: 2px solid var(--primary);
            border-radius: 6px;
            font-family: inherit;
            font-size: inherit;
            background: var(--surface);
            color: var(--text);
            outline: none;
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.2);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
        }

        .btn-outline:hover {
            background: var(--background);
            border-color: var(--primary);
            color: var(--primary);
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2);
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            z-index: 1000;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast-success {
            border-left: 4px solid var(--success);
        }

        .toast-error {
            border-left: 4px solid var(--error);
        }

        .toast-warning {
            border-left: 4px solid var(--warning);
        }

        .toast-icon {
            font-size: 1.25rem;
        }

        .toast-success .toast-icon { color: var(--success); }
        .toast-error .toast-icon { color: var(--error); }
        .toast-warning .toast-icon { color: var(--warning); }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .toast-message {
            font-size: 0.875rem;
            color: var(--text-light);
        }

        .close-toast {
            background: none;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            font-size: 1.25rem;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-toast:hover {
            color: var(--text);
        }

        /* Confirm Dialog */
        .confirm-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .confirm-dialog.show {
            display: flex;
        }

        .confirm-content {
            background: var(--surface);
            border-radius: 12px;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .confirm-icon {
            font-size: 3rem;
            text-align: center;
            margin-bottom: 1rem;
            color: var(--error);
        }

        .confirm-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .confirm-message {
            color: var(--text-light);
            text-align: center;
            margin-bottom: 2rem;
        }

        .confirm-buttons {
            display: flex;
            gap: 1rem;
        }

        .confirm-buttons .btn {
            flex: 1;
        }

        /* Module Grid */
        .module-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .module-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 2rem;
            border-radius: 12px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            color: inherit;
            display: block;
            backdrop-filter: blur(10px);
        }

        .module-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border-color: var(--primary);
        }

        .module-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.75rem;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, var(--primary), #ef4444);
            color: white;
        }

        .module-card h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .module-card p {
            color: var(--text-light);
            font-size: 0.95rem;
        }

        /* Chart Canvas Container */
        .chart-canvas-container {
            flex: 1;
            min-height: 0;
            position: relative;
            background: var(--background);
            border-radius: 8px;
            overflow: hidden;
        }

        /* Modal Styles - UPDATED FOR FIX */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal.show {
            display: block;
            opacity: 1;
        }

        .modal-content {
            background: var(--surface);
            margin: 2% auto;
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 900px;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(-20px);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .modal.show .modal-content {
            transform: translateY(0);
            opacity: 1;
        }

        .close-modal {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
            z-index: 10;
        }

        .close-modal:hover {
            background: var(--background);
            color: var(--text);
            transform: scale(1.1);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--background);
            font-family: inherit;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .action-buttons .btn {
            flex: 1;
        }

        .success-message {
            background: #dcfce7;
            color: #166534;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            display: none;
        }

        .error-message {
            background: #fecaca;
            color: #991b1b;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            display: none;
        }

        .modal-header {
            margin-bottom: 2rem;
        }

        .modal-header h2 {
            margin-right: 2rem;
        }

        .file-upload-area {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 1rem;
        }

        .file-upload-area:hover {
            border-color: var(--primary);
            background: var(--background);
        }

        .file-list {
            margin-top: 1rem;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            margin-bottom: 0.5rem;
            background: var(--background);
        }

        /* Standards Cards Grid */
        .standards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .standard-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            position: relative;
        }

        .standard-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            border-color: var(--primary);
        }

        .standard-badge {
            position: absolute;
            top: 1rem;
            right: 1rem;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-international {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        .badge-national {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #86efac;
        }

        .badge-company {
            background: #f3e8ff;
            color: #7c3aed;
            border: 1px solid #c4b5fd;
        }

        .badge-personal {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fde68a;
        }

        .standard-card h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--primary);
        }

        .standard-code {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-bottom: 0.5rem;
            font-family: monospace;
        }

        .standard-industry {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background: var(--background);
            border-radius: 4px;
            font-size: 0.75rem;
            margin-bottom: 1rem;
        }

        .standard-status {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-bottom: 1rem;
        }

        .status-compliant {
            background: #dcfce7;
            color: #166534;
        }

        .status-noncompliant {
            background: #fecaca;
            color: #991b1b;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-inprogress {
            background: #dbeafe;
            color: #1e40af;
        }

        .standard-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        /* Tab Container */
        .tab-container {
            margin-bottom: 2rem;
        }

        .tab-buttons {
            display: flex;
            border-bottom: 1px solid var(--border);
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            overflow-x: auto;
        }

        .tab-button {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-light);
            white-space: nowrap;
        }

        .tab-button.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 2rem;
            margin-top: 3rem;
            color: var(--text-light);
            border-top: 1px solid var(--border);
            font-size: 0.9rem;
            line-height: 1.6;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 12px;
        }

        /* ==================== NEW MODULE STYLES ==================== */

        /* Emergency Wizard Steps */
        .wizard-step {
            background: white;
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .wizard-step.active {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.1);
        }

        .wizard-step-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            font-weight: bold;
            margin-right: 1rem;
        }

        /* Checklist Items */
        .checklist-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            background: white;
            transition: all 0.2s;
        }

        .checklist-item:hover {
            background: var(--background);
            border-color: var(--primary);
        }

        .checklist-item.checked {
            background: #dcfce7;
            border-color: #86efac;
        }

        /* Risk Matrix Grid */
        .risk-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.5rem;
            margin: 1rem 0;
        }

        .risk-cell {
            padding: 1rem;
            text-align: center;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .risk-cell:hover {
            transform: scale(1.05);
        }

        /* Equipment Status Badges */
        .equipment-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-overdue {
            background: #fecaca;
            color: #991b1b;
            border: 1px solid #f87171;
        }

        .badge-due-soon {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fbbf24;
        }

        .badge-ok {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #86efac;
        }

        /* Chemical Hazard Symbols */
        .hazard-symbol {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.25rem;
            color: white;
        }

        .hazard-flammable {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .hazard-toxic {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        }

        .hazard-corrosive {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        /* Observation Cards */
        .observation-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            position: relative;
        }

        .observation-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            border-radius: 4px 0 0 4px;
        }

        .observation-card.positive::before {
            background: #10b981;
        }

        .observation-card.negative::before {
            background: #ef4444;
        }

        .observation-card.neutral::before {
            background: #6b7280;
        }

        /* Investigation Timeline */
        .investigation-timeline {
            position: relative;
            padding-left: 2rem;
        }

        .timeline-item {
            position: relative;
            padding-bottom: 2rem;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -2rem;
            top: 0;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--primary);
            border: 3px solid white;
            box-shadow: 0 0 0 2px var(--primary);
        }

        /* Report Charts Container */
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin: 1.5rem 0;
        }

        .chart-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            height: 300px;
        }

        /* Quick Action Buttons */
        .quick-action {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
            background: white;
            border: 2px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .quick-action:hover {
            border-color: var(--primary);
            transform: translateY(-4px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .quick-action-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        /* Permission-based elements */
        .permission-hidden {
            display: none !important;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            .sidebar {
                transform: translateX(-100%);
            }
            .main-content {
                margin-left: 0;
                grid-column: 1;
            }
            .matrix-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            .form-row {
                grid-template-columns: 1fr;
            }
            .standards-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 1rem;
            }
            .header {
                flex-direction: column;
            }
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .matrix-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .chart-header {
                flex-direction: column;
                align-items: flex-start;
            }
            .chart-controls {
                width: 100%;
                flex-wrap: wrap;
            }
            .chart-container {
                height: 400px;
            }
            .module-grid {
                grid-template-columns: 1fr;
            }
            .standards-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            .matrix-grid {
                grid-template-columns: 1fr;
            }
            .chart-container {
                height: 350px;
            }
            .action-buttons {
                flex-direction: column;
            }
            .action-buttons .btn {
                width: 100%;
            }
        }

        /* Animation Keyframes */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-10px); }
        }
    </style>
</head>
<body>
    <!-- MMS Safety Login Screen -->
    <div id="loginScreen" style="display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); z-index: 10000; align-items: center; justify-content: center; font-family: 'Segoe UI', system-ui, sans-serif;">
      <div style="background: white; padding: 3rem; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); width: 90%; max-width: 400px; text-align: center; border-top: 6px solid #dc2626;">
        <!-- Logo -->
        <div style="width: 80px; height: 80px; background: #dc2626; border-radius: 16px; margin: 0 auto 1.5rem; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 1.8rem; box-shadow: 0 10px 25px rgba(220, 38, 38, 0.4);">MMS</div>
        
        <h1 style="color: #1e293b; margin-bottom: 0.5rem; font-size: 1.8rem;">Safety Management System</h1>
        <p style="color: #64748b; margin-bottom: 2rem; font-size: 1rem;">Metal Management Solutions - Secure Access</p>
        
        <!-- Login Form -->
        <div style="margin-bottom: 1.5rem; text-align: left;">
          <label style="display: block; margin-bottom: 0.5rem; color: #1e293b; font-weight: 500; font-size: 0.95rem;">Company Email</label>
          <input type="email" id="prodEmail" placeholder="you@mms.com" style="width: 100%; padding: 0.875rem; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 1rem; transition: all 0.3s; margin-bottom: 1.5rem; outline: none;" onfocus="this.style.borderColor='#dc2626'; this.style.boxShadow='0 0 0 3px rgba(220, 38, 38, 0.1)'" onblur="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none'">
          
          <label style="display: block; margin-bottom: 0.5rem; color: #1e293b; font-weight: 500; font-size: 0.95rem;">Password</label>
          <input type="password" id="prodPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="width: 100%; padding: 0.875rem; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 1rem; transition: all 0.3s; margin-bottom: 0.5rem; outline: none;" onfocus="this.style.borderColor='#dc2626'; this.style.boxShadow='0 0 0 3px rgba(220, 38, 38, 0.1)'" onblur="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none'">
        </div>
        
        <!-- Error Display -->
        <div id="loginError" style="display: none; background: #fee2e2; color: #991b1b; padding: 0.875rem; border-radius: 8px; margin-bottom: 1.5rem; font-size: 0.9rem; border-left: 4px solid #ef4444;"></div>
        
        <!-- Login Button -->
        <button onclick="handleMMSLogin()" style="width: 100%; padding: 1rem; background: linear-gradient(135deg, #dc2626, #ef4444); color: white; border: none; border-radius: 10px; font-size: 1.05rem; font-weight: 600; cursor: pointer; transition: all 0.3s; margin-bottom: 1.5rem; box-shadow: 0 6px 20px rgba(220, 38, 38, 0.3);" 
          onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 10px 30px rgba(220, 38, 38, 0.4)'"
          onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 6px 20px rgba(220, 38, 38, 0.3)'">
          üîê Login to Safety System
        </button>
        
        <!-- Footer -->
        <div style="font-size: 0.85rem; color: #64748b; border-top: 1px solid #f1f5f9; padding-top: 1rem;">
          <div style="margin-bottom: 0.25rem;">‚ö†Ô∏è Authorized MMS personnel only</div>
          <div>Contact IT for account access ‚Ä¢ support@mms.com</div>
        </div>
      </div>
    </div>

    <!-- Firebase Backend -->
    <script type="module" src="./firebase-config.js"></script>
    <script type="module" src="./auth-system.js"></script>
    <script type="module" src="./database-service.js"></script>
    
    <!-- Session Management -->
    <script type="module" src="./session-manager.js"></script>
    
    <!-- Enhanced PWA Installation -->
    <script type="module" src="./install-promotion.js"></script>

    <!-- Admin Panel -->
    <script type="module" src="./admin-panel.js"></script>

    <!-- Option 5: New Safety Modules -->
    <script type="module" src="./emergency-wizard.js"></script>
    <script type="module" src="./safety-checklist.js"></script>
    <script type="module" src="./risk-calculator.js"></script>
    <script type="module" src="./equipment-inspections.js"></script>
    <script type="module" src="./chemical-register.js"></script>
    <script type="module" src="./incident-investigator.js"></script>
    <script type="module" src="./safety-observations.js"></script>
    <script type="module" src="./reporting-dashboard.js"></script>

    <div id="appContent" style="display: none;">
        <div class="dashboard">
            <nav class="sidebar">
                <div class="logo">
                    <div class="logo-icon"></div>
                    <div>
                        <div style="font-weight: 700; font-size: 1.25rem;">Metal Management</div>
                        <div style="font-size: 0.875rem; color: var(--text-light);">Health & Safety System</div>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-title">Navigation</div>
                    <a href="#" class="nav-item active">
                        <span class="nav-icon">üè†</span>
                        Health & Safety Dashboard
                    </a>
                </div>

                <!-- Admin Section (Visible only to admins) -->
                <div class="nav-section" data-permission="admin">
                    <div class="nav-title">Administration</div>
                    <button class="nav-item" onclick="window.adminPanel?.startMigration()">
                        <span class="nav-icon">‚òÅÔ∏è</span>
                        Migrate to Cloud
                    </button>
                    <button class="nav-item" onclick="window.adminPanel?.manageUsers()">
                        <span class="nav-icon">üë•</span>
                        User Management
                    </button>
                    <button class="nav-item" onclick="window.adminPanel?.viewAuditLogs()">
                        <span class="nav-icon">üìã</span>
                        Audit Trail
                    </button>
                    <button class="nav-item" onclick="window.adminPanel?.backupData()">
                        <span class="nav-icon">üíæ</span>
                        Backup System
                    </button>
                </div>

                <!-- PWA App Section -->
                <div class="nav-section">
                    <div class="nav-title">App</div>
                    <button class="nav-item" id="sidebarInstallBtn" style="display: none;">
                        <span class="nav-icon">üì±</span>
                        Install App
                    </button>
                </div>

                <div class="nav-section">
                    <div class="nav-title">Safety Management</div>
                    <button class="nav-item" onclick="openModal('incidentsModal')">
                        <span class="nav-icon">üö®</span>
                        Incident Management
                    </button>
                    <button class="nav-item" onclick="openModal('riskModal')">
                        <span class="nav-icon">üìä</span>
                        Risk Assessment
                    </button>
                    <button class="nav-item" onclick="openModal('trainingModal')">
                        <span class="nav-icon">üéì</span>
                        Safety Training
                    </button>
                    <button class="nav-item" onclick="openModal('ppeModal')">
                        <span class="nav-icon">ü•Ω</span>
                        PPE Management
                    </button>
                </div>

                <!-- Safety Tools Section -->
                <div class="nav-section">
                    <div class="nav-title">Safety Tools</div>
                    <button class="nav-item" onclick="openModal('emergencyModal')">
                        <span class="nav-icon">üö®</span>
                        Emergency Procedures
                    </button>
                    <button class="nav-item" onclick="openModal('checklistModal')">
                        <span class="nav-icon">‚úÖ</span>
                        Safety Checklists
                    </button>
                    <button class="nav-item" onclick="openModal('riskCalculatorModal')">
                        <span class="nav-icon">üìä</span>
                        Risk Calculator
                    </button>
                    <button class="nav-item" onclick="openModal('observationModal')">
                        <span class="nav-icon">üëÅÔ∏è</span>
                        Safety Observations
                    </button>
                </div>

                <!-- Specialist Modules Section -->
                <div class="nav-section">
                    <div class="nav-title">Specialist Modules</div>
                    <button class="nav-item" onclick="openModal('equipmentModal')">
                        <span class="nav-icon">üîß</span>
                        Equipment Inspections
                    </button>
                    <button class="nav-item" onclick="openModal('chemicalModal')">
                        <span class="nav-icon">üß™</span>
                        Chemical Register
                    </button>
                    <button class="nav-item" onclick="openModal('investigationModal')">
                        <span class="nav-icon">üîç</span>
                        Incident Investigator
                    </button>
                    <button class="nav-item" onclick="openModal('reportsModal')">
                        <span class="nav-icon">üìà</span>
                        Management Reports
                    </button>
                </div>

                <div class="nav-section">
                    <div class="nav-title">Compliance</div>
                    <button class="nav-item" onclick="openModal('standardsModal')">
                        <span class="nav-icon">üìã</span>
                        Standards & Compliance
                    </button>
                    <button class="nav-item" onclick="openModal('auditModal')">
                        <span class="nav-icon">üîç</span>
                        Audit & Inspection
                    </button>
                    <button class="nav-item" onclick="openModal('contractorModal')">
                        <span class="nav-icon">üë∑</span>
                        Contractor Safety
                    </button>
                </div>

                <div class="nav-section">
                    <div class="nav-title">Employee Management</div>
                    <button class="nav-item" onclick="openModal('healthModal')">
                        <span class="nav-icon">üë•</span>
                        Employee Health
                    </button>
                    <button class="nav-item" onclick="openModal('settingsModal')">
                        <span class="nav-icon">‚öôÔ∏è</span>
                        System Settings
                    </button>
                </div>
            </nav>

            <main class="main-content">
                <div class="header">
                    <div>
                        <h1>Occupational Health & Safety Management</h1>
                        <div style="color: var(--text-light); margin-top: 0.5rem;">
                            Metal Management Solutions - Comprehensive OHS compliance across all operations
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                        <!-- Admin Controls (Visible only in header for admins) -->
                        <div data-permission="admin" style="display: none; margin-right: 1rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="color: #dc2626; font-weight: 500; font-size: 0.875rem; padding: 0.25rem 0.75rem; background: rgba(220, 38, 38, 0.1); border-radius: 4px;">üëë Admin</span>
                                <button class="btn btn-sm btn-outline" onclick="window.adminPanel?.startMigration()">
                                    ‚òÅÔ∏è Migrate Data
                                </button>
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: center; gap: 1rem; margin-left: auto;">
                            <div style="text-align: right;">
                                <div id="currentUserEmail" style="font-weight: 600; color: var(--text); font-size: 0.95rem;"></div>
                                <div id="currentUserRole" style="font-size: 0.8rem; color: var(--text-light);"></div>
                            </div>
                            <button class="btn btn-outline" onclick="handleMMSLogout()" style="white-space: nowrap; padding: 0.5rem 1rem;">
                                üö™ Logout
                            </button>
                        </div>
                        <button class="btn btn-outline" id="installBtn" style="display: none;">
                            üì± Install App
                        </button>
                        <button class="btn btn-outline" onclick="window.open('./deployment-checklist.html', '_blank')">
                            üìã Deployment Checklist
                        </button>
                        <button class="btn btn-outline" onclick="exportToPDF()">
                            üìÑ Export PDF
                        </button>
                        <button class="btn btn-primary" onclick="openModal('reportIncidentModal')">
                            üö® Report Incident
                        </button>
                    </div>
                </div>

                <!-- Statistics Cards -->
                <div class="stats-grid">
                    <div class="stat-card" onclick="openModal('incidentsModal')">
                        <div class="stat-number" id="lostTimeInjuries">0</div>
                        <div class="stat-label">Lost Time Injuries</div>
                        <div class="stat-details" id="ltiDetails">
                            Last 30 days: 0 incidents
                        </div>
                    </div>
                    <div class="stat-card" onclick="openModal('trainingModal')">
                        <div class="stat-number" id="safetyTrainings">156</div>
                        <div class="stat-label">Safety Trainings</div>
                        <div class="stat-details" id="trainingDetails">
                            45 completed, 12 in progress
                        </div>
                    </div>
                    <div class="stat-card" onclick="openModal('standardsModal')">
                        <div class="stat-number" id="complianceRate">92%</div>
                        <div class="stat-label">Compliance Rate</div>
                        <div class="stat-details">
                            Based on 28 standards and regulations
                        </div>
                    </div>
                    <div class="stat-card" onclick="openModal('auditModal')">
                        <div class="stat-number" id="activeAudits">8</div>
                        <div class="stat-label">Active Audits</div>
                        <div class="stat-details">
                            4 internal, 2 external, 2 regulatory
                        </div>
                    </div>
                </div>

                <!-- Quick Access Dashboard Section -->
                <div class="chart-container" style="margin-bottom: 2rem;">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">Safety Tools Quick Access</div>
                            <div class="chart-subtitle">One-click access to essential safety tools</div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
                        <div class="quick-action" onclick="openEmergencyWizard()">
                            <div class="quick-action-icon">üö®</div>
                            <div style="font-weight: 600; margin-bottom: 0.25rem;">Emergency Wizard</div>
                            <div style="font-size: 0.85rem; color: var(--text-light);">Step-by-step guidance</div>
                        </div>
                        
                        <div class="quick-action" onclick="openSafetyChecklist()">
                            <div class="quick-action-icon">‚úÖ</div>
                            <div style="font-weight: 600; margin-bottom: 0.25rem;">Safety Checklists</div>
                            <div style="font-size: 0.85rem; color: var(--text-light);">Daily inspections</div>
                        </div>
                        
                        <div class="quick-action" onclick="openRiskCalculator()">
                            <div class="quick-action-icon">üìä</div>
                            <div style="font-weight: 600; margin-bottom: 0.25rem;">Risk Calculator</div>
                            <div style="font-size: 0.85rem; color: var(--text-light);">Assess workplace risks</div>
                        </div>
                        
                        <div class="quick-action" onclick="openModal('observationModal')">
                            <div class="quick-action-icon">üëÅÔ∏è</div>
                            <div style="font-weight: 600; margin-bottom: 0.25rem;">Safety Observations</div>
                            <div style="font-size: 0.85rem; color: var(--text-light);">Record observations</div>
                        </div>
                    </div>
                </div>

                <!-- Incident Trends Chart -->
                <div class="chart-container">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">Safety Performance Trends</div>
                            <div class="chart-subtitle">Incident monitoring across all MMS locations</div>
                        </div>
                        <div class="chart-controls">
                            <div class="chart-type-selector">
                                <button class="chart-type-btn active" onclick="changeChartType('line')">üìà Line</button>
                                <button class="chart-type-btn" onclick="changeChartType('bar')">üìä Bar</button>
                                <button class="chart-type-btn" onclick="changeChartType('pie')">ü•ß Pie</button>
                            </div>
                            <div class="custom-calendar">
                                <input type="date" id="startDate" class="date-input" onchange="updateChartWithCustomRange()">
                                <span>to</span>
                                <input type="date" id="endDate" class="date-input" onchange="updateChartWithCustomRange()">
                            </div>
                        </div>
                    </div>
                    <div class="chart-canvas-container">
                        <canvas id="incidentTrendChart"></canvas>
                    </div>
                </div>

                <!-- Risk Assessment Matrix -->
                <div class="risk-matrix">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">Risk Assessment Matrix</div>
                            <div class="chart-subtitle">Current workplace risk assessment status</div>
                        </div>
                        <div>
                            <button class="btn btn-success" onclick="saveRiskMatrix()">üíæ Save Matrix</button>
                        </div>
                    </div>
                    <div class="matrix-grid" id="riskMatrix">
                        <!-- Matrix cells will be loaded by JavaScript -->
                    </div>
                </div>

                <!-- OHS Management Modules -->
                <div class="module-grid">
                    <div class="module-card" onclick="openModal('incidentsModal')">
                        <div class="module-icon">üö®</div>
                        <h3>Incident Management</h3>
                        <p>Report, track, and investigate workplace incidents with full documentation</p>
                    </div>

                    <div class="module-card" onclick="openModal('ppeModal')">
                        <div class="module-icon">ü•Ω</div>
                        <h3>PPE Management</h3>
                        <p>Track personal protective equipment issuance, maintenance, and compliance</p>
                    </div>

                    <div class="module-card" onclick="openModal('healthModal')">
                        <div class="module-icon">üë•</div>
                        <h3>Employee Health</h3>
                        <p>Employee health monitoring, medical examinations, and wellness programs</p>
                    </div>

                    <div class="module-card" onclick="openModal('contractorModal')">
                        <div class="module-icon">üë∑</div>
                        <h3>Contractor Safety</h3>
                        <p>Manage contractor safety compliance, permits, and site-specific inductions</p>
                    </div>

                    <div class="module-card" onclick="openModal('auditModal')">
                        <div class="module-icon">üîç</div>
                        <h3>Audit & Inspection</h3>
                        <p>Schedule and conduct safety audits, inspections, and compliance verifications</p>
                    </div>

                    <div class="module-card" onclick="openModal('standardsModal')">
                        <div class="module-icon">üìã</div>
                        <h3>Standards Compliance</h3>
                        <p>Manage international and national safety standards compliance</p>
                    </div>

                    <!-- Add these NEW module cards to your existing module-grid -->
                    <div class="module-card" onclick="openModal('emergencyModal')">
                        <div class="module-icon">üö®</div>
                        <h3>Emergency Procedures</h3>
                        <p>Step-by-step emergency response wizard for critical situations</p>
                    </div>

                    <div class="module-card" onclick="openModal('checklistModal')">
                        <div class="module-icon">‚úÖ</div>
                        <h3>Safety Checklists</h3>
                        <p>Interactive safety checklists for daily inspections and audits</p>
                    </div>

                    <div class="module-card" onclick="openModal('riskCalculatorModal')">
                        <div class="module-icon">üìä</div>
                        <h3>Risk Calculator</h3>
                        <p>Calculate and assess workplace risks with automated scoring</p>
                    </div>

                    <div class="module-card" onclick="openModal('equipmentModal')">
                        <div class="module-icon">üîß</div>
                        <h3>Equipment Inspections</h3>
                        <p>Track equipment maintenance, inspections, and certifications</p>
                    </div>

                    <div class="module-card" onclick="openModal('chemicalModal')">
                        <div class="module-icon">üß™</div>
                        <h3>Chemical Register</h3>
                        <p>Manage chemical inventory, SDS, and safety data sheets</p>
                    </div>

                    <div class="module-card" onclick="openModal('observationModal')">
                        <div class="module-icon">üëÅÔ∏è</div>
                        <h3>Safety Observations</h3>
                        <p>Record and track daily safety observations and near-misses</p>
                    </div>

                    <div class="module-card" onclick="openModal('investigationModal')">
                        <div class="module-icon">üîç</div>
                        <h3>Incident Investigator</h3>
                        <p>Complete investigation toolkit with root cause analysis</p>
                    </div>

                    <div class="module-card" onclick="openModal('reportsModal')">
                        <div class="module-icon">üìà</div>
                        <h3>Management Reports</h3>
                        <p>Advanced reporting dashboard with analytics and KPIs</p>
                    </div>
                </div>

                <div class="footer">
                    <div style="font-weight: 600; color: var(--primary); margin-bottom: 0.5rem;">
                        Metal Management Solutions
                    </div>
                    <div style="margin-bottom: 0.5rem;">
                        Health & Safety Management System
                    </div>
                    <div style="font-size: 0.85rem; color: var(--text-light);">
                        Copyright ¬© 2026 Metal Management Solutions. All rights reserved.
                    </div>
                    <div style="font-size: 0.85rem; color: var(--text-light); margin-top: 0.25rem;">
                        Operating in South Africa, Tanzania, Namibia, and Zambia
                    </div>
                </div>
            </main>
        </div>

        <!-- Toast Notification -->
        <div class="toast" id="toast">
            <div class="toast-icon"></div>
            <div class="toast-content">
                <div class="toast-title"></div>
                <div class="toast-message"></div>
            </div>
            <button class="close-toast" onclick="hideToast()">√ó</button>
        </div>

        <!-- Confirm Dialog -->
        <div class="confirm-dialog" id="confirmDialog">
            <div class="confirm-content">
                <div class="confirm-icon">‚ö†Ô∏è</div>
                <div class="confirm-title" id="confirmTitle">Confirm Delete</div>
                <div class="confirm-message" id="confirmMessage">Are you sure you want to delete this item? This action cannot be undone.</div>
                <div class="confirm-buttons">
                    <button class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
                    <button class="btn btn-outline" onclick="hideConfirmDialog()">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Report Incident Modal -->
        <div id="reportIncidentModal" class="modal">
            <div class="modal-content">
                <button class="close-modal" onclick="closeModal('reportIncidentModal')">√ó</button>
                <div class="modal-header">
                    <h2>Report Safety Incident</h2>
                </div>
                
                <div class="success-message" id="reportSuccess">Incident reported successfully!</div>
                <div class="error-message" id="reportError">Please fill all required fields.</div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Incident Type *</label>
                        <select id="incidentType" required>
                            <option value="">Select type</option>
                            <option value="Near Miss">Near Miss</option>
                            <option value="First Aid">First Aid</option>
                            <option value="Medical Treatment">Medical Treatment</option>
                            <option value="Lost Time Injury">Lost Time Injury</option>
                            <option value="Property Damage">Property Damage</option>
                            <option value="Environmental Incident">Environmental Incident</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Severity Level *</label>
                        <select id="incidentSeverity" required>
                            <option value="">Select severity</option>
                            <option value="Minor">Minor</option>
                            <option value="Moderate">Moderate</option>
                            <option value="Serious">Serious</option>
                            <option value="Critical">Critical</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Date & Time *</label>
                        <input type="datetime-local" id="incidentDateTime" required>
                    </div>
                    <div class="form-group">
                        <label>Location *</label>
                        <select id="incidentLocation" required>
                            <option value="">Select location</option>
                            <optgroup label="South Africa">
                                <option value="Cape Town HQ">Cape Town HQ</option>
                                <option value="Cosco Durban">Cosco Durban</option>
                                <option value="AGL Durban">AGL Durban</option>
                            </optgroup>
                            <optgroup label="Tanzania">
                                <option value="Impala Dar">Impala Dar</option>
                                <option value="Polytra Dar">Polytra Dar</option>
                                <option value="Access Dar">Access Dar</option>
                            </optgroup>
                            <optgroup label="Namibia">
                                <option value="WBCT Bulk Shed">WBCT Bulk Shed</option>
                                <option value="WBCT Quay Side Shed">WBCT Quay Side Shed</option>
                                <option value="Bridge Walvis Bay">Bridge Walvis Bay</option>
                                <option value="Pindulo Walvis Bay">Pindulo Walvis Bay</option>
                            </optgroup>
                            <optgroup label="Zambia">
                                <option value="Reload Giga Terminal">Reload Giga Terminal</option>
                                <option value="AGL Chingola Hub">AGL Chingola Hub</option>
                                <option value="Polytra Kitwe">Polytra Kitwe</option>
                                <option value="Impala Ndola">Impala Ndola</option>
                                <option value="SLS Ndola">SLS Ndola</option>
                                <option value="Poseidon Zambia">Poseidon Zambia</option>
                                <option value="Polytra Kapiri Mposhi">Polytra Kapiri Mposhi</option>
                            </optgroup>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Reported By *</label>
                        <select id="reportedBy" required>
                            <option value="">Select employee</option>
                            <!-- Employees will be populated by JavaScript -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Department *</label>
                        <select id="incidentDepartment" required>
                            <option value="">Select department</option>
                            <option value="Inventory Control">Inventory Control</option>
                            <option value="Operations">Operations</option>
                            <option value="Management">Management</option>
                            <option value="Contractor">Contractor</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Description *</label>
                    <textarea id="incidentDescription" rows="4" placeholder="Provide detailed description" required></textarea>
                </div>
                
                <div class="form-group">
                    <label>Immediate Actions Taken</label>
                    <textarea id="immediateActions" rows="3" placeholder="Describe immediate response actions"></textarea>
                </div>
                
                <div class="form-group">
                    <label>Attachments</label>
                    <div class="file-upload-area" onclick="document.getElementById('incidentFileInput').click()">
                        <input type="file" id="incidentFileInput" style="display: none;" multiple>
                        <div style="font-size: 3rem;">üìé</div>
                        <div style="margin: 1rem 0;">Click to upload incident photos or documents</div>
                        <div style="color: var(--text-light); font-size: 0.875rem;">Supported: PDF, DOC, JPG, PNG (Max 10MB each)</div>
                    </div>
                    <div class="file-list" id="incidentFilesList"></div>
                </div>
                
                <div class="form-group">
                    <label>Proposed Recommendations/Comments</label>
                    <textarea id="recommendations" rows="3" placeholder="Enter recommendations or comments"></textarea>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="submitIncidentReport()">Submit Report</button>
                    <button class="btn btn-outline" onclick="closeModal('reportIncidentModal')">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Incident Management Modal -->
        <div id="incidentsModal" class="modal">
            <div class="modal-content">
                <button class="close-modal" onclick="closeModal('incidentsModal')">√ó</button>
                <div class="modal-header">
                    <h2>Incident Management System</h2>
                    <p>Click on any cell to edit, right-click for more options</p>
                </div>
                
                <div class="tab-container">
                    <div class="tab-buttons">
                        <button class="tab-button active" onclick="switchTab('incidentsTab', 'incidentsModal')">All Incidents</button>
                        <button class="tab-button" onclick="switchTab('incidentsAnalysisTab', 'incidentsModal')">Analysis</button>
                        <button class="tab-button" onclick="switchTab('incidentsAttachmentsTab', 'incidentsModal')">Attachments</button>
                    </div>
                    
                    <div class="tab-content active" id="incidentsTab">
                        <div style="overflow-x: auto; margin-top: 1rem;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Type</th>
                                        <th>Date</th>
                                        <th>Location</th>
                                        <th>Reported By</th>
                                        <th>Severity</th>
                                        <th>Status</th>
                                        <th>Description</th>
                                        <th>Actions</th>
                                        <th>Recommendations</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="modalIncidentsTableBody">
                                    <!-- Incidents will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="incidentsAnalysisTab">
                        <div style="margin-top: 1rem;">
                            <canvas id="incidentAnalysisChart" height="300"></canvas>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="incidentsAttachmentsTab">
                        <div class="form-group">
                            <label>Select Incident</label>
                            <select id="incidentSelect" onchange="loadIncidentAttachments()">
                                <option value="">Select incident</option>
                            </select>
                        </div>
                        
                        <div class="file-upload-area" onclick="document.getElementById('incidentModalFileInput').click()">
                            <input type="file" id="incidentModalFileInput" style="display: none;" multiple onchange="uploadIncidentAttachment()">
                            <div style="font-size: 3rem;">üìé</div>
                            <div style="margin: 1rem 0;">Click to upload incident documents</div>
                        </div>
                        
                        <div class="file-list" id="incidentAttachmentsList">
                            <!-- Attachments will be listed here -->
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons" style="margin-top: 2rem;">
                    <button class="btn btn-outline" onclick="exportTableToPDF('incidentsTable')">üìÑ Export PDF</button>
                    <button class="btn btn-outline" onclick="closeModal('incidentsModal')">Close</button>
                    <button class="btn btn-primary" onclick="openModal('reportIncidentModal')">+ Report New Incident</button>
                </div>
            </div>
        </div>

        <!-- Safety Training Modal -->
        <div id="trainingModal" class="modal">
            <div class="modal-content">
                <button class="close-modal" onclick="closeModal('trainingModal')">√ó</button>
                <div class="modal-header">
                    <h2>Safety Training Management</h2>
                    <p>Track all safety training activities and certifications</p>
                </div>
                
                <div class="tab-container">
                    <div class="tab-buttons">
                        <button class="tab-button active" onclick="switchTab('trainingRecordsTab', 'trainingModal')">Training Records</button>
                        <button class="tab-button" onclick="switchTab('trainingAttachmentsTab', 'trainingModal')">Certificates</button>
                        <button class="tab-button" onclick="switchTab('trainingStatsTab', 'trainingModal')">Statistics</button>
                    </div>
                    
                    <div class="tab-content active" id="trainingRecordsTab">
                        <div style="overflow-x: auto; margin-top: 1rem;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Training ID</th>
                                        <th>Employee</th>
                                        <th>Training Type</th>
                                        <th>Provider</th>
                                        <th>Start Date</th>
                                        <th>End Date</th>
                                        <th>Status</th>
                                        <th>Score</th>
                                        <th>Expiry Date</th>
                                        <th>Notes</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="trainingTableBody">
                                    <!-- Training records will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="trainingAttachmentsTab">
                        <div class="form-group">
                            <label>Select Employee</label>
                            <select id="trainingEmployeeSelect" onchange="loadTrainingCertificates()">
                                <option value="">Select employee</option>
                            </select>
                        </div>
                        
                        <div class="file-upload-area" onclick="document.getElementById('trainingFileInput').click()">
                            <input type="file" id="trainingFileInput" style="display: none;" multiple onchange="uploadTrainingCertificate()">
                            <div style="font-size: 3rem;">üìé</div>
                            <div style="margin: 1rem 0;">Click to upload training certificates</div>
                        </div>
                        
                        <div class="file-list" id="trainingCertificatesList">
                            <!-- Certificates will be listed here -->
                        </div>
                    </div>
                    
                    <div class="tab-content" id="trainingStatsTab">
                        <div style="margin-top: 1rem;">
                            <canvas id="trainingStatsChart" height="300"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons" style="margin-top: 2rem;">
                    <button class="btn btn-outline" onclick="addTrainingRecord()">+ Add Training</button>
                    <button class="btn btn-outline" onclick="exportTableToPDF('trainingTable')">üìÑ Export PDF</button>
                    <button class="btn btn-outline" onclick="closeModal('trainingModal')">Close</button>
                </div>
            </div>
        </div>

        <!-- PPE Management Modal -->
        <div id="ppeModal" class="modal">
            <div class="modal-content">
                <button class="close-modal" onclick="closeModal('ppeModal')">√ó</button>
                <div class="modal-header">
                    <h2>PPE Management System</h2>
                    <p>Personal Protective Equipment Management</p>
                </div>
                
                <div class="tab-container">
                    <div class="tab-buttons">
                        <button class="tab-button active" onclick="switchTab('ppeRecordsTab', 'ppeModal')">PPE Records</button>
                        <button class="tab-button" onclick="switchTab('ppeIssuanceTab', 'ppeModal')">Issuance Log</button>
                        <button class="tab-button" onclick="switchTab('ppeAttachmentsTab', 'ppeModal')">Documents</button>
                    </div>
                    
                    <div class="tab-content active" id="ppeRecordsTab">
                        <div style="overflow-x: auto; margin-top: 1rem;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>PPE ID</th>
                                        <th>Equipment Type</th>
                                        <th>Size</th>
                                        <th>Brand</th>
                                        <th>Quantity</th>
                                        <th>Location</th>
                                        <th>Status</th>
                                        <th>Last Inspection</th>
                                        <th>Next Inspection</th>
                                        <th>Condition</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="ppeTableBody">
                                    <!-- PPE items will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="ppeIssuanceTab">
                        <div style="overflow-x: auto; margin-top: 1rem;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Issue ID</th>
                                        <th>PPE ID</th>
                                        <th>Employee</th>
                                        <th>Issue Date</th>
                                        <th>Expiry Date</th>
                                        <th>Issued By</th>
                                        <th>Return Date</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="ppeIssuanceTableBody">
                                    <!-- Issuance records will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="ppeAttachmentsTab">
                        <div class="form-group">
                            <label>Select PPE Item</label>
                            <select id="ppeItemSelect" onchange="loadPPEDocuments()">
                                <option value="">Select PPE item</option>
                            </select>
                        </div>
                        
                        <div class="file-upload-area" onclick="document.getElementById('ppeFileInput').click()">
                            <input type="file" id="ppeFileInput" style="display: none;" multiple onchange="uploadPPEDocument()">
                            <div style="font-size: 3rem;">üìé</div>
                            <div style="margin: 1rem 0;">Click to upload PPE documents</div>
                        </div>
                        
                        <div class="file-list" id="ppeDocumentsList">
                            <!-- Documents will be listed here -->
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons" style="margin-top: 2rem;">
                    <button class="btn btn-outline" onclick="addPPEItem()">+ Add PPE</button>
                    <button class="btn btn-outline" onclick="issuePPE()">üìù Issue PPE</button>
                    <button class="btn btn-outline" onclick="exportTableToPDF('ppeTable')">üìÑ Export PDF</button>
                    <button class="btn btn-outline" onclick="closeModal('ppeModal')">Close</button>
                </div>
            </div>
        </div>

        <!-- Health Surveillance Modal -->
        <div id="healthModal" class="modal">
            <div class="modal-content">
                <button class="close-modal" onclick="closeModal('healthModal')">√ó</button>
                <div class="modal-header">
                    <h2>Employee Health Surveillance</h2>
                    <p>Employee Health Monitoring - All MMS Employees</p>
                </div>
                
                <div class="tab-container">
                    <div class="tab-buttons">
                        <button class="tab-button active" onclick="switchTab('healthRecordsTab', 'healthModal')">Health Records</button>
                        <button class="tab-button" onclick="switchTab('healthAttachmentsTab', 'healthModal')">Medical Records</button>
                        <button class="tab-button" onclick="switchTab('healthStatsTab', 'healthModal')">Statistics</button>
                    </div>
                    
                    <div class="tab-content active" id="healthRecordsTab">
                        <div style="overflow-x: auto; margin-top: 1rem;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Employee ID</th>
                                        <th>Name</th>
                                        <th>Location</th>
                                        <th>Position</th>
                                        <th>Last Medical</th>
                                        <th>Next Due</th>
                                        <th>Blood Group</th>
                                        <th>Allergies</th>
                                        <th>Medical Status</th>
                                        <th>Emergency Contact</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="healthTableBody">
                                    <!-- Health records will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="healthAttachmentsTab">
                        <div class="form-group">
                            <label>Select Employee</label>
                            <select id="healthEmployeeSelect" onchange="loadHealthAttachments()">
                                <option value="">Select employee</option>
                            </select>
                        </div>
                        
                        <div class="file-upload-area" onclick="document.getElementById('healthFileInput').click()">
                            <input type="file" id="healthFileInput" style="display: none;" multiple onchange="uploadHealthAttachment()">
                            <div style="font-size: 3rem;">üìé</div>
                            <div style="margin: 1rem 0;">Click to upload medical records</div>
                        </div>
                        
                        <div class="file-list" id="healthAttachmentsList">
                            <!-- Attachments will be listed here -->
                        </div>
                    </div>
                    
                    <div class="tab-content" id="healthStatsTab">
                        <div style="margin-top: 1rem;">
                            <canvas id="healthStatsChart" height="300"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons" style="margin-top: 2rem;">
                    <button class="btn btn-outline" onclick="addHealthRecord()">+ Add Record</button>
                    <button class="btn btn-outline" onclick="exportTableToPDF('healthTable')">üìÑ Export PDF</button>
                    <button class="btn btn-outline" onclick="closeModal('healthModal')">Close</button>
                </div>
            </div>
        </div>

        <!-- Contractor Safety Modal -->
        <div id="contractorModal" class="modal">
            <div class="modal-content">
                <button class="close-modal" onclick="closeModal('contractorModal')">√ó</button>
                <div class="modal-header">
                    <h2>Contractor Safety Management</h2>
                    <p>Contractor Safety Compliance</p>
                </div>
                
                <div class="tab-container">
                    <div class="tab-buttons">
                        <button class="tab-button active" onclick="switchTab('contractorRecordsTab', 'contractorModal')">Contractor Records</button>
                        <button class="tab-button" onclick="switchTab('contractorPermitsTab', 'contractorModal')">Permits</button>
                        <button class="tab-button" onclick="switchTab('contractorAttachmentsTab', 'contractorModal')">Documents</button>
                    </div>
                    
                    <div class="tab-content active" id="contractorRecordsTab">
                        <div style="overflow-x: auto; margin-top: 1rem;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Contractor ID</th>
                                        <th>Company</th>
                                        <th>Contact Person</th>
                                        <th>Phone</th>
                                        <th>Email</th>
                                        <th>Work Type</th>
                                        <th>Location</th>
                                        <th>Start Date</th>
                                        <th>End Date</th>
                                        <th>Safety Rating</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="contractorTableBody">
                                    <!-- Contractor records will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="contractorPermitsTab">
                        <div style="overflow-x: auto; margin-top: 1rem;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Permit ID</th>
                                        <th>Contractor</th>
                                        <th>Work Type</th>
                                        <th>Location</th>
                                        <th>Issued Date</th>
                                        <th>Expiry Date</th>
                                        <th>Issued By</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="contractorPermitsTableBody">
                                    <!-- Permit records will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="contractorAttachmentsTab">
                        <div class="form-group">
                            <label>Select Contractor</label>
                            <select id="contractorSelect" onchange="loadContractorAttachments()">
                                <option value="">Select contractor</option>
                            </select>
                        </div>
                        
                        <div class="file-upload-area" onclick="document.getElementById('contractorFileInput').click()">
                            <input type="file" id="contractorFileInput" style="display: none;" multiple onchange="uploadContractorAttachment()">
                            <div style="font-size: 3rem;">üìé</div>
                            <div style="margin: 1rem 0;">Click to upload contractor documents</div>
                        </div>
                        
                        <div class="file-list" id="contractorAttachmentsList">
                            <!-- Attachments will be listed here -->
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons" style="margin-top: 2rem;">
                    <button class="btn btn-outline" onclick="addContractor()">+ Add Contractor</button>
                    <button class="btn btn-outline" onclick="issuePermit()">üìù Issue Permit</button>
                    <button class="btn btn-outline" onclick="exportTableToPDF('contractorTable')">üìÑ Export PDF</button>
                    <button class="btn btn-outline" onclick="closeModal('contractorModal')">Close</button>
                </div>
            </div>
        </div>

        <!-- Audit & Inspection Modal -->
        <div id="auditModal" class="modal">
            <div class="modal-content">
                <button class="close-modal" onclick="closeModal('auditModal')">√ó</button>
                <div class="modal-header">
                    <h2>Audit & Inspection Management</h2>
                    <p>Safety Audits and Inspections</p>
                </div>
                
                <div class="tab-container">
                    <div class="tab-buttons">
                        <button class="tab-button active" onclick="switchTab('auditRecordsTab', 'auditModal')">Audit Records</button>
                        <button class="tab-button" onclick="switchTab('auditScheduleTab', 'auditModal')">Schedule</button>
                        <button class="tab-button" onclick="switchTab('auditAttachmentsTab', 'auditModal')">Reports</button>
                    </div>
                    
                    <div class="tab-content active" id="auditRecordsTab">
                        <div style="overflow-x: auto; margin-top: 1rem;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Audit ID</th>
                                        <th>Type</th>
                                        <th>Location</th>
                                        <th>Audit Date</th>
                                        <th>Auditor</th>
                                        <th>Score</th>
                                        <th>Status</th>
                                        <th>Findings</th>
                                        <th>Corrective Actions</th>
                                        <th>Next Audit</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="auditTableBody">
                                    <!-- Audit records will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="auditScheduleTab">
                        <div style="overflow-x: auto; margin-top: 1rem;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Schedule ID</th>
                                        <th>Audit Type</th>
                                        <th>Location</th>
                                        <th>Scheduled Date</th>
                                        <th>Frequency</th>
                                        <th>Assigned To</th>
                                        <th>Status</th>
                                        <th>Priority</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="auditScheduleTableBody">
                                    <!-- Schedule records will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="auditAttachmentsTab">
                        <div class="form-group">
                            <label>Select Audit</label>
                            <select id="auditSelect" onchange="loadAuditAttachments()">
                                <option value="">Select audit</option>
                            </select>
                        </div>
                        
                        <div class="file-upload-area" onclick="document.getElementById('auditFileInput').click()">
                            <input type="file" id="auditFileInput" style="display: none;" multiple onchange="uploadAuditAttachment()">
                            <div style="font-size: 3rem;">üìé</div>
                            <div style="margin: 1rem 0;">Click to upload audit reports</div>
                        </div>
                        
                        <div class="file-list" id="auditAttachmentsList">
                            <!-- Attachments will be listed here -->
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons" style="margin-top: 2rem;">
                    <button class="btn btn-outline" onclick="addAudit()">+ Add Audit</button>
                    <button class="btn btn-outline" onclick="scheduleAudit()">üìÖ Schedule Audit</button>
                    <button class="btn btn-outline" onclick="exportTableToPDF('auditTable')">üìÑ Export PDF</button>
                    <button class="btn btn-outline" onclick="closeModal('auditModal')">Close</button>
                </div>
            </div>
        </div>

        <!-- Standards Compliance Modal -->
        <div id="standardsModal" class="modal">
            <div class="modal-content">
                <button class="close-modal" onclick="closeModal('standardsModal')">√ó</button>
                <div class="modal-header">
                    <h2>Standards & Compliance Management</h2>
                    <p>Manage International and National Safety Standards</p>
                </div>
                
                <div class="tab-container">
                    <div class="tab-buttons">
                        <button class="tab-button active" onclick="switchTab('standardsListTab', 'standardsModal')">Standards</button>
                        <button class="tab-button" onclick="switchTab('complianceTab', 'standardsModal')">Compliance Status</button>
                        <button class="tab-button" onclick="switchTab('standardsAttachmentsTab', 'standardsModal')">Documents</button>
                    </div>
                    
                    <div class="tab-content active" id="standardsListTab">
                        <div class="standards-grid" id="standardsGrid">
                            <!-- Standards cards will be loaded here -->
                        </div>
                    </div>
                    
                    <div class="tab-content" id="complianceTab">
                        <div style="margin-top: 1rem;">
                            <canvas id="complianceChart" height="300"></canvas>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="standardsAttachmentsTab">
                        <div class="form-group">
                            <label>Select Standard</label>
                            <select id="standardSelect" onchange="loadStandardAttachments()">
                                <option value="">Select standard</option>
                            </select>
                        </div>
                        
                        <div class="file-upload-area" onclick="document.getElementById('standardFileInput').click()">
                            <input type="file" id="standardFileInput" style="display: none;" multiple onchange="uploadStandardAttachment()">
                            <div style="font-size: 3rem;">üìé</div>
                            <div style="margin: 1rem 0;">Click to upload standard documents</div>
                        </div>
                        
                        <div class="file-list" id="standardAttachmentsList">
                            <!-- Attachments will be listed here -->
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons" style="margin-top: 2rem;">
                    <button class="btn btn-outline" onclick="addStandard()">+ Add Standard</button>
                    <button class="btn btn-outline" onclick="exportStandardsToPDF()">üìÑ Export PDF</button>
                    <button class="btn btn-outline" onclick="closeModal('standardsModal')">Close</button>
                </div>
            </div>
        </div>

        <!-- Add/Edit Standard Modal -->
        <div id="standardModal" class="modal">
            <div class="modal-content">
                <button class="close-modal" onclick="closeModal('standardModal')">√ó</button>
                <div class="modal-header">
                    <h2 id="standardModalTitle">Add New Standard</h2>
                </div>
                
                <div class="success-message" id="standardSuccess">Standard saved successfully!</div>
                <div class="error-message" id="standardError">Please fill all required fields.</div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Standard Name *</label>
                        <input type="text" id="standardName" placeholder="e.g., ISO 45001:2018" required>
                    </div>
                    <div class="form-group">
                        <label>Standard Code *</label>
                        <input type="text" id="standardCode" placeholder="e.g., ISO45001" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Standard Type *</label>
                        <select id="standardType" required onchange="toggleCountryField()">
                            <option value="">Select type</option>
                            <option value="International">International</option>
                            <option value="National">National</option>
                            <option value="Company">Company/Organizational</option>
                            <option value="Personal">Personal Certification</option>
                        </select>
                    </div>
                    <div class="form-group" id="countryField">
                        <label>Country</label>
                        <select id="standardCountry">
                            <option value="">Select country</option>
                            <option value="South Africa">South Africa</option>
                            <option value="Tanzania">Tanzania</option>
                            <option value="Namibia">Namibia</option>
                            <option value="Zambia">Zambia</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Description *</label>
                    <textarea id="standardDescription" rows="4" placeholder="Description of the standard and its requirements" required></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Status *</label>
                        <select id="standardStatus" required>
                            <option value="">Select status</option>
                            <option value="Compliant">Compliant</option>
                            <option value="Non-Compliant">Non-Compliant</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Pending Review">Pending Review</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Effective Date</label>
                        <input type="date" id="standardEffectiveDate">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Remarks</label>
                    <textarea id="standardRemarks" rows="3" placeholder="Additional remarks or notes"></textarea>
                </div>
                
                <div class="form-group">
                    <label>Upload Standard Document</label>
                    <div class="file-upload-area" onclick="document.getElementById('standardFormFileInput').click()">
                        <input type="file" id="standardFormFileInput" style="display: none;" accept=".pdf,.doc,.docx,.jpg,.png">
                        <div style="font-size: 3rem;">üìé</div>
                        <div style="margin: 1rem 0;">Click to upload standard document</div>
                    </div>
                    <div class="file-list" id="standardFormFilesList"></div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-success" onclick="saveStandard()">üíæ Save Standard</button>
                    <button class="btn btn-outline" onclick="closeModal('standardModal')">Cancel</button>
                    <button class="btn btn-danger" id="deleteStandardBtn" style="display: none;" onclick="deleteCurrentStandard()">üóëÔ∏è Delete</button>
                </div>
            </div>
        </div>

        <!-- Risk Assessment Modal -->
        <div id="riskModal" class="modal">
            <div class="modal-content">
                <button class="close-modal" onclick="closeModal('riskModal')">√ó</button>
                <div class="modal-header">
                    <h2>Risk Assessment Management</h2>
                    <p>Click on any risk cell to edit details</p>
                </div>
                
                <div class="risk-matrix">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">Risk Assessment Matrix</div>
                            <div class="chart-subtitle">Edit risk levels and departments</div>
                        </div>
                        <div>
                            <button class="btn btn-success" onclick="saveRiskMatrix()">üíæ Save Matrix</button>
                        </div>
                    </div>
                    <div class="matrix-grid" id="modalRiskMatrix">
                        <!-- Matrix cells will be loaded here -->
                    </div>
                </div>
                
                <div class="action-buttons" style="margin-top: 2rem;">
                    <button class="btn btn-outline" onclick="exportRiskMatrixToPDF()">üìÑ Export PDF</button>
                    <button class="btn btn-outline" onclick="closeModal('riskModal')">Close</button>
                </div>
            </div>
        </div>

        <!-- Settings Modal -->
        <div id="settingsModal" class="modal">
            <div class="modal-content">
                <button class="close-modal" onclick="closeModal('settingsModal')">√ó</button>
                <div class="modal-header">
                    <h2>System Settings</h2>
                    <p>Configure your Health & Safety Management System</p>
                </div>
                
                <div class="tab-container">
                    <div class="tab-buttons">
                        <button class="tab-button active" onclick="switchTab('companySettingsTab', 'settingsModal')">Company Info</button>
                        <button class="tab-button" onclick="switchTab('locationSettingsTab', 'settingsModal')">Locations</button>
                        <button class="tab-button" onclick="switchTab('notificationSettingsTab', 'settingsModal')">Notifications</button>
                        <button class="tab-button" onclick="switchTab('backupSettingsTab', 'settingsModal')">Backup & Export</button>
                    </div>
                    
                    <div class="tab-content active" id="companySettingsTab">
                        <div class="form-group">
                            <label>Company Name</label>
                            <input type="text" id="companyName" value="Metal Management Solutions">
                        </div>
                        <div class="form-group">
                            <label>Website</label>
                            <input type="url" id="companyWebsite" value="https://www.metalmanagementsolutions.com/">
                        </div>
                        <div class="form-group">
                            <label>Contact Email</label>
                            <input type="email" id="companyEmail" placeholder="safety@metalmanagementsolutions.com">
                        </div>
                        <div class="form-group">
                            <label>Contact Phone</label>
                            <input type="tel" id="companyPhone" placeholder="+27 21 123 4567">
                        </div>
                    </div>
                    
                    <div class="tab-content" id="locationSettingsTab">
                        <div class="form-group">
                            <label>Add New Location</label>
                            <div class="form-row">
                                <input type="text" id="newLocationName" placeholder="Location Name">
                                <select id="newLocationCountry">
                                    <option value="">Select Country</option>
                                    <option value="South Africa">South Africa</option>
                                    <option value="Tanzania">Tanzania</option>
                                    <option value="Namibia">Namibia</option>
                                    <option value="Zambia">Zambia</option>
                                </select>
                            </div>
                            <button class="btn btn-outline" onclick="addLocation()" style="margin-top: 0.5rem;">+ Add Location</button>
                        </div>
                        
                        <div style="margin-top: 2rem;">
                            <h4>Current Locations</h4>
                            <div id="locationsList">
                                <!-- Locations will be listed here -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="notificationSettingsTab">
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="emailNotifications" checked>
                                Email Notifications
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="incidentAlerts" checked>
                                Incident Alerts
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="trainingReminders" checked>
                                Training Reminders
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="auditReminders" checked>
                                Audit Reminders
                            </label>
                        </div>
                        <div class="form-group">
                            <label>Notification Email</label>
                            <input type="email" id="notificationEmail" placeholder="Enter notification email">
                        </div>
                    </div>
                    
                    <div class="tab-content" id="backupSettingsTab">
                        <div class="form-group">
                            <label>Backup Frequency</label>
                            <select id="backupFrequency">
                                <option value="daily">Daily</option>
                                <option value="weekly" selected>Weekly</option>
                                <option value="monthly">Monthly</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Auto-Export Reports</label>
                            <select id="autoExport">
                                <option value="none">None</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly" selected>Monthly</option>
                            </select>
                        </div>
                        <div class="action-buttons" style="margin-top: 2rem;">
                            <button class="btn btn-outline" onclick="backupData()">üíæ Backup Now</button>
                            <button class="btn btn-outline" onclick="exportAllData()">üìÑ Export All Data</button>
                            <button class="btn btn-danger" onclick="resetData()">üîÑ Reset System</button>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons" style="margin-top: 2rem;">
                    <button class="btn btn-success" onclick="saveSettings()">üíæ Save Settings</button>
                    <button class="btn btn-outline" onclick="closeModal('settingsModal')">Close</button>
                </div>
            </div>
        </div>

        <!-- ==================== NEW SAFETY MODALS ==================== -->

        <!-- Emergency Procedures Wizard -->
        <div id="emergencyModal" class="modal">
            <div class="modal-content">
                <button class="close-modal" onclick="closeModal('emergencyModal')">√ó</button>
                <div class="modal-header">
                    <h2>Emergency Response Wizard</h2>
                    <p>Step-by-step guidance for emergency situations</p>
                </div>
                <div id="emergencyContent">
                    <!-- Content will be loaded by JavaScript -->
                </div>
                <div class="action-buttons">
                    <button class="btn btn-outline" onclick="closeModal('emergencyModal')">Close</button>
                    <button class="btn btn-primary" onclick="printEmergencyProcedures()">üñ®Ô∏è Print Procedures</button>
                </div>
            </div>
        </div>

        <!-- Safety Checklists -->
        <div id="checklistModal" class="modal">
            <div class="modal-content">
                <button class="close-modal" onclick="closeModal('checklistModal')">√ó</button>
                <div class="modal-header">
                    <h2>Safety Checklists</h2>
                    <p>Interactive checklists for daily safety inspections</p>
                </div>
                <div id="checklistContent">
                    <!-- Content will be loaded by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Risk Assessment Calculator -->
        <div id="riskCalculatorModal" class="modal">
            <div class="modal-content">
                <button class="close-modal" onclick="closeModal('riskCalculatorModal')">√ó</button>
                <div class="modal-header">
                    <h2>Risk Assessment Calculator</h2>
                    <p>Calculate and score workplace risks</p>
                </div>
                <div id="riskCalculatorContent">
                    <!-- Content will be loaded by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Equipment Inspections -->
        <div id="equipmentModal" class="modal">
            <div class="modal-content">
                <button class="close-modal" onclick="closeModal('equipmentModal')">√ó</button>
                <div class="modal-header">
                    <h2>Equipment Inspection Manager</h2>
                    <p>Track equipment maintenance and inspections</p>
                </div>
                <div id="equipmentContent">
                    <!-- Content will be loaded by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Chemical Register -->
        <div id="chemicalModal" class="modal">
            <div class="modal-content">
                <button class="close-modal" onclick="closeModal('chemicalModal')">√ó</button>
                <div class="modal-header">
                    <h2>Chemical Safety Register</h2>
                    <p>Manage chemicals, SDS, and safety data</p>
                </div>
                <div id="chemicalContent">
                    <!-- Content will be loaded by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Safety Observations -->
        <div id="observationModal" class="modal">
            <div class="modal-content">
                <button class="close-modal" onclick="closeModal('observationModal')">√ó</button>
                <div class="modal-header">
                    <h2>Safety Observations</h2>
                    <p>Record and track daily safety observations</p>
                </div>
                <div id="observationContent">
                    <!-- Content will be loaded by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Incident Investigator -->
        <div id="investigationModal" class="modal">
            <div class="modal-content">
                <button class="close-modal" onclick="closeModal('investigationModal')">√ó</button>
                <div class="modal-header">
                    <h2>Incident Investigation Toolkit</h2>
                    <p>Complete investigation with root cause analysis</p>
                </div>
                <div id="investigationContent">
                    <!-- Content will be loaded by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Management Reports Dashboard -->
        <div id="reportsModal" class="modal">
            <div class="modal-content" style="max-width: 1200px;">
                <button class="close-modal" onclick="closeModal('reportsModal')">√ó</button>
                <div class="modal-header">
                    <h2>Safety Management Reports</h2>
                    <p>Advanced analytics and KPI dashboard</p>
                </div>
                <div id="reportsContent">
                    <!-- Content will be loaded by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- PWA Initialization -->
    <script src="./pwa-init.js"></script>
    
    <!-- Main Application Script -->
    <script>
        // Global Variables
        let incidents = [];
        let ppeItems = [];
        let ppeIssuance = [];
        let healthRecords = [];
        let contractors = [];
        let contractorPermits = [];
        let audits = [];
        let auditSchedule = [];
        let standards = [];
        let trainingRecords = [];
        let settings = {};
        let attachments = {
            incidents: {},
            health: {},
            contractor: {},
            audit: {},
            standards: {},
            training: {},
            ppe: {}
        };
        let incidentTrendChart = null;
        let editingCell = null;
        let editingStandardIndex = -1;
        let currentChartType = 'line';
        let locations = [
            { name: "Cape Town HQ", country: "South Africa" },
            { name: "Cosco Durban", country: "South Africa" },
            { name: "AGL Durban", country: "South Africa" },
            { name: "Impala Dar", country: "Tanzania" },
            { name: "Polytra Dar", country: "Tanzania" },
            { name: "Access Dar", country: "Tanzania" },
            { name: "WBCT Bulk Shed", country: "Namibia" },
            { name: "WBCT Quay Side Shed", country: "Namibia" },
            { name: "Bridge Walvis Bay", country: "Namibia" },
            { name: "Pindulo Walvis Bay", country: "Namibia" },
            { name: "Reload Giga Terminal", country: "Zambia" },
            { name: "AGL Chingola Hub", country: "Zambia" },
            { name: "Polytra Kitwe", country: "Zambia" },
            { name: "Impala Ndola", country: "Zambia" },
            { name: "SLS Ndola", country: "Zambia" },
            { name: "Poseidon Zambia", country: "Zambia" },
            { name: "Polytra Kapiri Mposhi", country: "Zambia" }
        ];

        // ==================== MODAL FIXES ====================

        function setupEventListeners() {
            console.log('Setting up event listeners...');
            
            // ========== 1. Close modal when clicking close button ==========
            // Use event delegation for close buttons
            document.addEventListener('click', function(event) {
                // Check if clicked element is a close button
                if (event.target.classList.contains('close-modal') || 
                    event.target.closest('.close-modal')) {
                    
                    // Find the closest modal
                    const modal = event.target.closest('.modal');
                    if (modal) {
                        closeModal(modal.id);
                        event.stopPropagation(); // Prevent event from bubbling up
                    }
                }
                
                // Check if clicked element has onclick with closeModal
                if (event.target.hasAttribute('onclick') && 
                    event.target.getAttribute('onclick').includes('closeModal')) {
                    // Let the onclick handler handle it
                    return;
                }
            });
            
            // ========== 2. Close modal when clicking outside ==========
            document.addEventListener('click', function(event) {
                // Only close if clicking directly on modal background (not its children)
                if (event.target.classList.contains('modal')) {
                    closeModal(event.target.id);
                }
            });
            
            // ========== 3. Escape key to close modal ==========
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape' || event.key === 'Esc') {
                    // Get all visible modals
                    const modals = document.querySelectorAll('.modal');
                    modals.forEach(modal => {
                        if (modal.style.display === 'block' || 
                            modal.style.display === '' ||
                            window.getComputedStyle(modal).display === 'block') {
                            closeModal(modal.id);
                        }
                    });
                }
            });
            
            // ========== 4. Fix for tab buttons ==========
            document.addEventListener('click', function(event) {
                // Check if clicked element is a tab button
                if (event.target.classList.contains('tab-button')) {
                    const modal = event.target.closest('.modal');
                    if (modal) {
                        // The switchTab function will handle the rest
                        // We just need to prevent default if needed
                        event.preventDefault();
                    }
                }
            });
            
            console.log('Event listeners setup complete');
        }

        function closeModal(modalId) {
            console.log('Closing modal:', modalId);
            
            // Get the modal element
            const modal = document.getElementById(modalId);
            if (!modal) {
                console.error('Modal not found:', modalId);
                return;
            }
            
            // Hide the modal with fade-out effect
            modal.style.opacity = '0';
            modal.style.transition = 'opacity 0.3s ease';
            
            setTimeout(() => {
                modal.style.display = 'none';
                modal.classList.remove('show');
                modal.style.opacity = '1'; // Reset for next open
                
                // Restore body scroll
                document.body.style.overflow = 'auto';
                document.body.style.height = 'auto';
                
                // Remove any active states
                const activeButtons = document.querySelectorAll('.nav-item.active');
                activeButtons.forEach(btn => {
                    if (!btn.classList.contains('always-active')) { // Keep dashboard active
                        btn.classList.remove('active');
                    }
                });
                
                // Ensure dashboard is active
                const dashboardNav = document.querySelector('.nav-item[href="#"]');
                if (dashboardNav) {
                    dashboardNav.classList.add('active');
                }
                
                // Destroy charts in modal when closing
                if (modalId === 'incidentsModal' || modalId === 'trainingModal' || 
                    modalId === 'healthModal' || modalId === 'standardsModal') {
                    destroyModalCharts(modalId);
                }
                
                console.log('Modal closed:', modalId);
            }, 300); // Match the transition time
        }

        function destroyModalCharts(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            
            const charts = modal.querySelectorAll('canvas');
            charts.forEach(canvas => {
                const chart = Chart.getChart(canvas);
                if (chart) {
                    chart.destroy();
                }
            });
        }

        function openModal(modalId) {
            console.log('Opening modal:', modalId);
            
            // Close any open modals first
            const openModals = document.querySelectorAll('.modal[style*="display: block"], .modal.show');
            openModals.forEach(modal => {
                if (modal.id !== modalId) {
                    closeModal(modal.id);
                }
            });
            
            const modal = document.getElementById(modalId);
            if (!modal) {
                console.error('Modal not found:', modalId);
                return;
            }
            
            // Show modal with fade-in effect
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
            document.body.style.height = '100vh';
            
            // Trigger animation
            setTimeout(() => {
                modal.classList.add('show');
            }, 10);
            
            // Load specific content for each modal
            switch(modalId) {
                case 'emergencyModal':
                    setTimeout(() => loadEmergencyProcedures(), 100);
                    break;
                case 'checklistModal':
                    setTimeout(() => loadSafetyChecklists(), 100);
                    break;
                case 'riskCalculatorModal':
                    setTimeout(() => loadRiskCalculator(), 100);
                    break;
                case 'equipmentModal':
                    setTimeout(() => loadEquipmentInspections(), 100);
                    break;
                case 'chemicalModal':
                    setTimeout(() => loadChemicalRegister(), 100);
                    break;
                case 'observationModal':
                    setTimeout(() => loadSafetyObservations(), 100);
                    break;
                case 'investigationModal':
                    setTimeout(() => loadIncidentInvestigator(), 100);
                    break;
                case 'reportsModal':
                    setTimeout(() => loadReportingDashboard(), 100);
                    break;
                case 'incidentsModal':
                    loadIncidentsTable();
                    break;
                case 'trainingModal':
                    loadTrainingTable();
                    break;
                case 'ppeModal':
                    loadPPETable();
                    loadPPEIssuanceTable();
                    break;
                case 'healthModal':
                    loadHealthTable();
                    break;
                case 'contractorModal':
                    loadContractorTable();
                    loadContractorPermitsTable();
                    break;
                case 'auditModal':
                    loadAuditTable();
                    loadAuditScheduleTable();
                    break;
                case 'standardsModal':
                    loadStandards();
                    break;
                case 'riskModal':
                    loadRiskMatrix();
                    break;
                case 'settingsModal':
                    loadSettings();
                    break;
            }
            
            console.log('Modal opened:', modalId);
        }

        // ==================== CHART FIXES ====================

        function initializeCharts() {
            // Wait for DOM to be ready
            setTimeout(() => {
                const ctx = document.getElementById('incidentTrendChart');
                if (!ctx) {
                    console.error('Chart canvas not found');
                    return;
                }
                
                // Check if Chart.js is loaded
                if (typeof Chart === 'undefined') {
                    console.error('Chart.js not loaded');
                    setTimeout(initializeCharts, 500); // Retry after 500ms
                    return;
                }
                
                // Destroy existing chart if it exists
                if (incidentTrendChart) {
                    incidentTrendChart.destroy();
                }
                
                // Generate data for the last 6 months
                const months = [];
                const incidentData = [];
                const nearMissData = [];
                const firstAidData = [];
                
                const endDate = new Date();
                const startDate = new Date();
                startDate.setMonth(startDate.getMonth() - 6);
                
                // Generate month labels and sample data
                let currentDate = new Date(startDate);
                while (currentDate <= endDate) {
                    const monthName = currentDate.toLocaleString('default', { month: 'short' });
                    months.push(monthName);
                    
                    // Generate sample data
                    incidentData.push(Math.floor(Math.random() * 5) + 1);
                    nearMissData.push(Math.floor(Math.random() * 8) + 2);
                    firstAidData.push(Math.floor(Math.random() * 4) + 1);
                    
                    currentDate.setMonth(currentDate.getMonth() + 1);
                }
                
                try {
                    incidentTrendChart = new Chart(ctx, {
                        type: currentChartType,
                        data: {
                            labels: months,
                            datasets: [
                                {
                                    label: 'Incidents',
                                    data: incidentData,
                                    borderColor: '#ef4444',
                                    backgroundColor: currentChartType === 'line' ? 'rgba(239, 68, 68, 0.1)' : '#ef4444',
                                    borderWidth: 2,
                                    tension: 0.3,
                                    fill: currentChartType === 'line',
                                    pointBackgroundColor: '#ef4444',
                                    pointBorderColor: '#ffffff',
                                    pointBorderWidth: 2,
                                    pointRadius: 4,
                                    pointHoverRadius: 6
                                },
                                {
                                    label: 'Near Misses',
                                    data: nearMissData,
                                    borderColor: '#f59e0b',
                                    backgroundColor: currentChartType === 'line' ? 'rgba(245, 158, 11, 0.1)' : '#f59e0b',
                                    borderWidth: 2,
                                    tension: 0.3,
                                    fill: currentChartType === 'line',
                                    pointBackgroundColor: '#f59e0b',
                                    pointBorderColor: '#ffffff',
                                    pointBorderWidth: 2,
                                    pointRadius: 4,
                                    pointHoverRadius: 6
                                },
                                {
                                    label: 'First Aid Cases',
                                    data: firstAidData,
                                    borderColor: '#10b981',
                                    backgroundColor: currentChartType === 'line' ? 'rgba(16, 185, 129, 0.1)' : '#10b981',
                                    borderWidth: 2,
                                    tension: 0.3,
                                    fill: currentChartType === 'line',
                                    pointBackgroundColor: '#10b981',
                                    pointBorderColor: '#ffffff',
                                    pointBorderWidth: 2,
                                    pointRadius: 4,
                                    pointHoverRadius: 6
                                }
                            ]
                        },
                        options: getChartOptions(currentChartType)
                    });
                    
                    console.log('Chart initialized successfully');
                } catch (error) {
                    console.error('Error initializing chart:', error);
                }
            }, 1000); // Wait 1 second to ensure everything is loaded
        }

        function getChartOptions(type) {
            const baseOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            font: {
                                size: 12
                            }
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                },
                scales: {
                    x: {
                        grid: {
                            display: true,
                            color: 'rgba(0,0,0,0.05)'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        grid: {
                            display: true,
                            color: 'rgba(0,0,0,0.05)'
                        },
                        ticks: {
                            stepSize: 1
                        }
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                animation: {
                    duration: 1000
                }
            };

            if (type === 'line' || type === 'bar') {
                return baseOptions;
            } else if (type === 'pie') {
                return {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                font: {
                                    size: 11
                                }
                            }
                        }
                    }
                };
            }
            
            return baseOptions;
        }

        // ==================== REPORTING DASHBOARD FIX ====================

        function loadReportingDashboard() {
            const reportsContent = document.getElementById('reportsContent');
            if (!reportsContent) return;
            
            let html = `
                <div style="margin-bottom: 2rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 style="color: var(--text);">Safety Management Reports</h3>
                        <div style="display: flex; gap: 0.5rem;">
                            <select id="reportPeriod" 
                                    style="padding: 0.5rem; border: 1px solid var(--border); border-radius: 6px;">
                                <option value="weekly">Weekly</option>
                                <option value="monthly" selected>Monthly</option>
                                <option value="quarterly">Quarterly</option>
                                <option value="yearly">Yearly</option>
                            </select>
                            <button onclick="generateReport()" 
                                    style="
                                        background: var(--primary);
                                        color: white;
                                        border: none;
                                        padding: 0.5rem 1rem;
                                        border-radius: 6px;
                                        cursor: pointer;
                                    ">
                                üìä Generate Report
                            </button>
                        </div>
                    </div>
                    
                    <!-- Report Stats -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                        <div style="background: white; border: 1px solid var(--border); border-radius: 8px; padding: 1.5rem; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: 600; color: var(--primary);">${incidents.length}</div>
                            <div style="font-size: 0.85rem; color: var(--text-light);">Total Incidents</div>
                        </div>
                        <div style="background: white; border: 1px solid var(--border); border-radius: 8px; padding: 1.5rem; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: 600; color: #10b981;">${trainingRecords.length}</div>
                            <div style="font-size: 0.85rem; color: var(--text-light);">Training Records</div>
                        </div>
                        <div style="background: white; border: 1px solid var(--border); border-radius: 8px; padding: 1.5rem; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: 600; color: #3b82f6;">${ppeItems.length}</div>
                            <div style="font-size: 0.85rem; color: var(--text-light);">PPE Items</div>
                        </div>
                        <div style="background: white; border: 1px solid var(--border); border-radius: 8px; padding: 1.5rem; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: 600; color: #8b5cf6;">${audits.length}</div>
                            <div style="font-size: 0.85rem; color: var(--text-light);">Completed Audits</div>
                        </div>
                    </div>
                    
                    <!-- Charts Grid -->
                    <div class="chart-grid">
                        <div class="chart-card">
                            <canvas id="reportIncidentChart" height="250"></canvas>
                        </div>
                        <div class="chart-card">
                            <canvas id="reportTrainingChart" height="250"></canvas>
                        </div>
                        <div class="chart-card">
                            <canvas id="reportComplianceChart" height="250"></canvas>
                        </div>
                        <div class="chart-card">
                            <canvas id="reportTrendChart" height="250"></canvas>
                        </div>
                    </div>
                    
                    <!-- Data Table -->
                    <div style="margin-top: 2rem;">
                        <div style="font-weight: 600; color: var(--text); margin-bottom: 1rem;">Recent Incidents</div>
                        <div style="overflow-x: auto; background: white; border: 1px solid var(--border); border-radius: 8px; padding: 1rem;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="border-bottom: 2px solid var(--border);">
                                        <th style="padding: 0.75rem; text-align: left;">ID</th>
                                        <th style="padding: 0.75rem; text-align: left;">Type</th>
                                        <th style="padding: 0.75rem; text-align: left;">Date</th>
                                        <th style="padding: 0.75rem; text-align: left;">Severity</th>
                                        <th style="padding: 0.75rem; text-align: left;">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
            `;
            
            // Show latest 5 incidents
            const recentIncidents = incidents.slice(0, 5);
            recentIncidents.forEach(incident => {
                const date = new Date(incident.date);
                const formattedDate = date.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                });
                
                html += `
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 0.75rem;">${incident.id}</td>
                        <td style="padding: 0.75rem;">${incident.type}</td>
                        <td style="padding: 0.75rem;">${formattedDate}</td>
                        <td style="padding: 0.75rem;">
                            <span style="
                                padding: 0.25rem 0.5rem;
                                border-radius: 4px;
                                font-size: 0.75rem;
                                background: ${incident.severity === 'Critical' ? '#fecaca' : 
                                            incident.severity === 'Serious' ? '#fed7aa' : 
                                            incident.severity === 'Moderate' ? '#fef3c7' : '#dcfce7'};
                                color: ${incident.severity === 'Critical' ? '#991b1b' : 
                                        incident.severity === 'Serious' ? '#9a3412' : 
                                        incident.severity === 'Moderate' ? '#92400e' : '#166534'};
                            ">
                                ${incident.severity}
                            </span>
                        </td>
                        <td style="padding: 0.75rem;">
                            <span style="
                                padding: 0.25rem 0.5rem;
                                border-radius: 4px;
                                font-size: 0.75rem;
                                background: ${incident.status === 'Resolved' ? '#dcfce7' : '#fef3c7'};
                                color: ${incident.status === 'Resolved' ? '#166534' : '#92400e'};
                            ">
                                ${incident.status}
                            </span>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Export Options -->
                    <div style="margin-top: 2rem; display: flex; gap: 1rem;">
                        <button onclick="exportReportPDF()" 
                                style="
                                    background: #ef4444;
                                    color: white;
                                    border: none;
                                    padding: 0.75rem 1.5rem;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    flex: 1;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    gap: 0.5rem;
                                ">
                            üìÑ Export PDF Report
                        </button>
                        <button onclick="exportReportExcel()" 
                                style="
                                    background: #10b981;
                                    color: white;
                                    border: none;
                                    padding: 0.75rem 1.5rem;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    flex: 1;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    gap: 0.5rem;
                                ">
                            üìä Export Excel Report
                        </button>
                    </div>
                </div>
            `;
            
            reportsContent.innerHTML = html;
            
            // Initialize report charts
            setTimeout(() => {
                initializeReportCharts();
            }, 500);
        }

        function initializeReportCharts() {
            // Incident Type Distribution
            const incidentCtx = document.getElementById('reportIncidentChart');
            if (incidentCtx && typeof Chart !== 'undefined') {
                const incidentTypes = {};
                incidents.forEach(incident => {
                    incidentTypes[incident.type] = (incidentTypes[incident.type] || 0) + 1;
                });
                
                new Chart(incidentCtx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(incidentTypes),
                        datasets: [{
                            data: Object.values(incidentTypes),
                            backgroundColor: [
                                '#ef4444', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6', '#ec4899'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            title: {
                                display: true,
                                text: 'Incident Type Distribution'
                            }
                        }
                    }
                });
            }
            
            // Training Status Chart
            const trainingCtx = document.getElementById('reportTrainingChart');
            if (trainingCtx) {
                const trainingStatus = {
                    'Completed': trainingRecords.filter(t => t.status === 'Completed').length,
                    'In Progress': trainingRecords.filter(t => t.status === 'In Progress').length,
                    'Scheduled': trainingRecords.filter(t => t.status === 'Scheduled').length
                };
                
                new Chart(trainingCtx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(trainingStatus),
                        datasets: [{
                            label: 'Training Records',
                            data: Object.values(trainingStatus),
                            backgroundColor: '#3b82f6',
                            borderColor: '#1d4ed8',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Training Status'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
            
            // Compliance Trend
            const complianceCtx = document.getElementById('reportComplianceChart');
            if (complianceCtx) {
                new Chart(complianceCtx, {
                    type: 'line',
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                        datasets: [{
                            label: 'Compliance Rate (%)',
                            data: [85, 88, 90, 92, 91, 93],
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Compliance Trend'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                min: 80,
                                max: 100
                            }
                        }
                    }
                });
            }
        }

        function generateReport() {
            const period = document.getElementById('reportPeriod')?.value || 'monthly';
            alert(`Generating ${period} safety report...`);
            // In production, this would generate and download a report
        }

        function exportReportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(20);
            doc.text('Safety Management Report', 20, 20);
            doc.setFontSize(12);
            doc.text(`Generated: ${new Date().toLocaleDateString()}`, 20, 30);
            doc.text(`Period: Monthly`, 20, 40);
            
            // Add stats
            doc.setFontSize(14);
            doc.text('Summary Statistics', 20, 55);
            doc.setFontSize(10);
            doc.text(`Total Incidents: ${incidents.length}`, 20, 65);
            doc.text(`Training Records: ${trainingRecords.length}`, 20, 72);
            doc.text(`PPE Items: ${ppeItems.length}`, 20, 79);
            doc.text(`Completed Audits: ${audits.length}`, 20, 86);
            
            doc.save(`safety-report-${new Date().toISOString().split('T')[0]}.pdf`);
            showToast('Success', 'Report exported to PDF', 'success');
        }

        function exportReportExcel() {
            const ws = XLSX.utils.json_to_sheet(incidents);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Incidents");
            
            // Add training data
            const ws2 = XLSX.utils.json_to_sheet(trainingRecords);
            XLSX.utils.book_append_sheet(wb, ws2, "Training");
            
            XLSX.writeFile(wb, `safety-report-${new Date().toISOString().split('T')[0]}.xlsx`);
            showToast('Success', 'Report exported to Excel', 'success');
        }

        // ==================== TAB SWITCHING FIX ====================

        function switchTab(tabName, modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            
            // Update tab buttons
            const tabButtons = modal.querySelectorAll('.tab-button');
            tabButtons.forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Add active class to clicked button
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            // Update tab content
            const tabContents = modal.querySelectorAll('.tab-content');
            tabContents.forEach(content => {
                content.classList.remove('active');
                content.style.display = 'none';
            });
            
            const activeTab = modal.querySelector(`#${tabName}`);
            if (activeTab) {
                activeTab.classList.add('active');
                activeTab.style.display = 'block';
            }
            
            // Load specific content for each tab
            switch(tabName) {
                case 'incidentsAnalysisTab':
                    setTimeout(() => initializeIncidentAnalysisChart(), 100);
                    break;
                case 'trainingStatsTab':
                    setTimeout(() => initializeTrainingStatsChart(), 100);
                    break;
                case 'healthStatsTab':
                    setTimeout(() => initializeHealthStatsChart(), 100);
                    break;
                case 'complianceTab':
                    setTimeout(() => initializeComplianceChart(), 100);
                    break;
            }
        }

        function initializeIncidentAnalysisChart() {
            const ctx = document.getElementById('incidentAnalysisChart');
            if (!ctx) return;
            
            const chart = Chart.getChart(ctx);
            if (chart) chart.destroy();
            
            // Create analysis chart data
            const incidentTypes = {};
            incidents.forEach(incident => {
                incidentTypes[incident.type] = (incidentTypes[incident.type] || 0) + 1;
            });
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(incidentTypes),
                    datasets: [{
                        label: 'Incidents by Type',
                        data: Object.values(incidentTypes),
                        backgroundColor: '#ef4444',
                        borderColor: '#dc2626',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Incident Analysis by Type'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function initializeTrainingStatsChart() {
            const ctx = document.getElementById('trainingStatsChart');
            if (!ctx) return;
            
            const chart = Chart.getChart(ctx);
            if (chart) chart.destroy();
            
            const statusCounts = {
                'Completed': trainingRecords.filter(t => t.status === 'Completed').length,
                'In Progress': trainingRecords.filter(t => t.status === 'In Progress').length,
                'Scheduled': trainingRecords.filter(t => t.status === 'Scheduled').length
            };
            
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: ['#10b981', '#f59e0b', '#3b82f6']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        title: {
                            display: true,
                            text: 'Training Status Distribution'
                        }
                    }
                }
            });
        }

        function initializeComplianceChart() {
            const ctx = document.getElementById('complianceChart');
            if (!ctx) return;
            
            const chart = Chart.getChart(ctx);
            if (chart) chart.destroy();
            
            const complianceData = {
                'Compliant': standards.filter(s => s.status === 'Compliant').length,
                'In Progress': standards.filter(s => s.status === 'In Progress').length,
                'Non-Compliant': standards.filter(s => s.status === 'Non-Compliant').length,
                'Pending Review': standards.filter(s => s.status === 'Pending Review').length
            };
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(complianceData),
                    datasets: [{
                        data: Object.values(complianceData),
                        backgroundColor: ['#10b981', '#3b82f6', '#ef4444', '#f59e0b']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        title: {
                            display: true,
                            text: 'Standards Compliance Status'
                        }
                    }
                }
            });
        }

        // ==================== NEW MODULE INTEGRATION ====================

        function initializeNewModules() {
            console.log('Initializing new safety modules...');
            
            // Emergency Wizard
            if (typeof EmergencyWizard !== 'undefined') {
                window.emergencyWizard = new EmergencyWizard();
                console.log('‚úÖ Emergency Wizard initialized');
            }
            
            // Safety Checklist
            if (typeof SafetyChecklistSystem !== 'undefined') {
                window.safetyChecklist = new SafetyChecklistSystem();
                console.log('‚úÖ Safety Checklist initialized');
            }
            
            // Risk Calculator
            if (typeof RiskCalculator !== 'undefined') {
                window.riskCalculator = new RiskCalculator();
                console.log('‚úÖ Risk Calculator initialized');
            }
            
            // Equipment Inspections
            if (typeof EquipmentInspections !== 'undefined') {
                window.equipmentInspections = new EquipmentInspections();
                console.log('‚úÖ Equipment Inspections initialized');
            }
            
            // Chemical Register
            if (typeof ChemicalRegister !== 'undefined') {
                window.chemicalRegister = new ChemicalRegister();
                console.log('‚úÖ Chemical Register initialized');
            }
            
            // Incident Investigator
            if (typeof IncidentInvestigator !== 'undefined') {
                window.incidentInvestigator = new IncidentInvestigator();
                console.log('‚úÖ Incident Investigator initialized');
            }
            
            // Safety Observations
            if (typeof SafetyObservations !== 'undefined') {
                window.safetyObservations = new SafetyObservations();
                console.log('‚úÖ Safety Observations initialized');
            }
            
            // Reporting Dashboard
            if (typeof SafetyReportingDashboard !== 'undefined') {
                window.safetyReports = new SafetyReportingDashboard();
                console.log('‚úÖ Reporting Dashboard initialized');
            }
        }

        // Emergency Procedures Wizard
        function loadEmergencyProcedures() {
            const emergencyContent = document.getElementById('emergencyContent');
            if (!emergencyContent || !window.emergencyWizard) {
                emergencyContent.innerHTML = `
                    <div style="text-align: center; padding: 3rem;">
                        <div style="font-size: 4rem;">üö®</div>
                        <h3>Emergency Response Procedures</h3>
                        <p>Please wait while we load emergency procedures...</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div style="margin-bottom: 1.5rem;">';
            html += '<h3 style="color: var(--primary); margin-bottom: 1rem;">Emergency Response Procedures</h3>';
            html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">';
            
            const emergencyTypes = [
                { id: 'fire', title: 'üî• Fire Emergency', icon: 'üî•', color: '#ef4444' },
                { id: 'medical', title: 'üè• Medical Emergency', icon: 'üè•', color: '#dc2626' },
                { id: 'spill', title: '‚ö†Ô∏è Chemical Spill', icon: '‚ö†Ô∏è', color: '#f59e0b' },
                { id: 'evacuation', title: 'üö™ Evacuation', icon: 'üö™', color: '#3b82f6' },
                { id: 'first-aid', title: 'ü©π First Aid', icon: 'ü©π', color: '#10b981' },
                { id: 'security', title: 'üõ°Ô∏è Security Incident', icon: 'üõ°Ô∏è', color: '#8b5cf6' }
            ];
            
            emergencyTypes.forEach(type => {
                html += `
                    <div class="emergency-type-card" 
                         onclick="openEmergencyProcedure('${type.id}')"
                         style="
                            background: white;
                            border: 2px solid var(--border);
                            border-radius: 10px;
                            padding: 1.5rem;
                            text-align: center;
                            cursor: pointer;
                            transition: all 0.3s;
                            border-left: 4px solid ${type.color};
                         ">
                        <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">${type.icon}</div>
                        <div style="font-weight: 600; color: var(--text);">${type.title}</div>
                        <div style="font-size: 0.85rem; color: var(--text-light); margin-top: 0.5rem;">Click to view procedures</div>
                    </div>
                `;
            });
            
            html += '</div>';
            html += '<div id="emergencySteps" style="display: none;"></div>';
            html += '</div>';
            emergencyContent.innerHTML = html;
        }

        function openEmergencyProcedure(type) {
            const emergencyContent = document.getElementById('emergencyContent');
            if (!window.emergencyWizard) return;
            
            const procedures = {
                'fire': {
                    title: 'Fire Emergency Response',
                    steps: [
                        '1. Raise the alarm - activate nearest fire alarm',
                        '2. Call emergency services (911/112)',
                        '3. Evacuate immediately using nearest exit',
                        '4. Do not use elevators',
                        '5. Assemble at designated muster point',
                        '6. Do not re-enter building until cleared by authorities'
                    ]
                },
                'medical': {
                    title: 'Medical Emergency Response',
                    steps: [
                        '1. Call for help and alert first aiders',
                        '2. Call emergency services if required',
                        '3. Do not move injured person unless in danger',
                        '4. Provide basic first aid if trained',
                        '5. Clear area for emergency responders',
                        '6. Complete incident report afterwards'
                    ]
                },
                'spill': {
                    title: 'Chemical Spill Response',
                    steps: [
                        '1. Alert personnel in the area',
                        '2. Identify chemical using SDS',
                        '3. Use appropriate PPE',
                        '4. Contain spill if safe to do so',
                        '5. Evacuate if toxic or flammable',
                        '6. Report to supervisor and safety officer'
                    ]
                }
            };
            
            const procedure = procedures[type] || procedures.fire;
            
            let html = `
                <div style="margin-bottom: 2rem;">
                    <button onclick="loadEmergencyProcedures()" 
                            style="
                                background: var(--background);
                                border: 1px solid var(--border);
                                padding: 0.5rem 1rem;
                                border-radius: 6px;
                                cursor: pointer;
                                margin-bottom: 1rem;
                                display: flex;
                                align-items: center;
                                gap: 0.5rem;
                            ">
                        ‚Üê Back to Procedures
                    </button>
                    <h3 style="color: var(--primary); margin-bottom: 1rem;">${procedure.title}</h3>
                    <div style="background: var(--background); border-radius: 8px; padding: 1.5rem;">
            `;
            
            procedure.steps.forEach(step => {
                html += `
                    <div class="wizard-step" style="margin-bottom: 1rem; padding: 1rem; background: white; border-radius: 8px; border: 1px solid var(--border);">
                        <div style="font-weight: 500;">${step}</div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                    <div style="margin-top: 2rem; padding: 1rem; background: #dcfce7; border-radius: 8px; border: 1px solid #86efac;">
                        <div style="font-weight: 600; color: #166534; margin-bottom: 0.5rem;">‚úÖ Important Notes:</div>
                        <div style="color: #166534;">
                            ‚Ä¢ Remain calm and follow procedures<br>
                            ‚Ä¢ Your safety comes first<br>
                            ‚Ä¢ Report all emergencies to supervisor<br>
                            ‚Ä¢ Complete incident report within 24 hours
                        </div>
                    </div>
                </div>
            `;
            
            emergencyContent.innerHTML = html;
        }

        // Safety Checklists
        function loadSafetyChecklists() {
            const checklistContent = document.getElementById('checklistContent');
            if (!checklistContent) return;
            
            let html = '<div style="margin-bottom: 1.5rem;">';
            html += '<h3 style="color: var(--text); margin-bottom: 1rem;">Safety Checklists</h3>';
            html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">';
            
            const checklists = [
                { id: 'daily', title: 'Daily Safety Inspection', icon: 'üìã', frequency: 'Daily', items: 12 },
                { id: 'ppe', title: 'PPE Inspection', icon: 'ü•Ω', frequency: 'Weekly', items: 8 },
                { id: 'equipment', title: 'Equipment Safety Check', icon: 'üîß', frequency: 'Monthly', items: 15 },
                { id: 'fire', title: 'Fire Safety Inspection', icon: 'üî•', frequency: 'Monthly', items: 10 },
                { id: 'chemical', title: 'Chemical Storage Check', icon: 'üß™', frequency: 'Weekly', items: 7 },
                { id: 'site', title: 'Site Safety Audit', icon: 'üèóÔ∏è', frequency: 'Quarterly', items: 25 }
            ];
            
            checklists.forEach(checklist => {
                html += `
                    <div class="checklist-option" 
                         onclick="startChecklist('${checklist.id}')"
                         style="
                            background: white;
                            border: 2px solid var(--border);
                            border-radius: 12px;
                            padding: 1.5rem;
                            cursor: pointer;
                            transition: all 0.3s;
                         ">
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                            <div style="
                                width: 50px;
                                height: 50px;
                                background: var(--primary);
                                border-radius: 10px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                color: white;
                                font-size: 1.5rem;
                            ">${checklist.icon}</div>
                            <div>
                                <div style="font-weight: 600; color: var(--text);">${checklist.title}</div>
                                <div style="font-size: 0.85rem; color: var(--text-light);">${checklist.frequency} ‚Ä¢ ${checklist.items} items</div>
                            </div>
                        </div>
                        <div style="margin-top: 1rem;">
                            <button onclick="startChecklist('${checklist.id}'); event.stopPropagation()"
                                    style="
                                        background: var(--primary);
                                        color: white;
                                        border: none;
                                        padding: 0.5rem 1rem;
                                        border-radius: 6px;
                                        cursor: pointer;
                                        font-weight: 500;
                                        width: 100%;
                                    ">
                                Start Checklist
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div></div>';
            checklistContent.innerHTML = html;
        }

        function startChecklist(checklistId) {
            const checklistContent = document.getElementById('checklistContent');
            const checklistItems = {
                'daily': [
                    'Fire extinguishers accessible and charged',
                    'Emergency exits clear and unobstructed',
                    'First aid kits fully stocked',
                    'Safety signage visible and legible',
                    'Walkways clear of obstructions',
                    'PPE available and in good condition',
                    'No trip hazards present',
                    'Lighting adequate in all areas',
                    'Ventilation systems operating',
                    'Spill kits available and complete',
                    'Safety guards in place on equipment',
                    'Housekeeping standards maintained'
                ],
                'ppe': [
                    'Safety helmets available and undamaged',
                    'Safety glasses/goggles available',
                    'Hearing protection available',
                    'Respirators available and filters current',
                    'Safety boots in good condition',
                    'High-visibility clothing available',
                    'Gloves appropriate for tasks',
                    'Fall protection equipment inspected'
                ]
            };
            
            const items = checklistItems[checklistId] || checklistItems.daily;
            
            let html = `
                <div style="margin-bottom: 2rem;">
                    <button onclick="loadSafetyChecklists()" 
                            style="
                                background: var(--background);
                                border: 1px solid var(--border);
                                padding: 0.5rem 1rem;
                                border-radius: 6px;
                                cursor: pointer;
                                margin-bottom: 1rem;
                                display: flex;
                                align-items: center;
                                gap: 0.5rem;
                            ">
                        ‚Üê Back to Checklists
                    </button>
                    <h3 style="color: var(--text); margin-bottom: 1rem;">Daily Safety Inspection</h3>
                    <div style="margin-bottom: 1rem;">
                        <div style="color: var(--text-light); font-size: 0.9rem;">
                            <span style="color: var(--primary); font-weight: 600;">Instructions:</span> 
                            Check each item and mark as compliant or non-compliant
                        </div>
                    </div>
                    <div id="checklistItems">
            `;
            
            items.forEach((item, index) => {
                html += `
                    <div class="checklist-item" style="margin-bottom: 0.5rem;">
                        <input type="checkbox" id="item${index}" style="width: 20px; height: 20px;">
                        <label for="item${index}" style="flex: 1; cursor: pointer;">${item}</label>
                        <select style="padding: 0.25rem 0.5rem; border-radius: 4px; border: 1px solid var(--border);">
                            <option value="compliant">‚úÖ Compliant</option>
                            <option value="non-compliant">‚ùå Non-compliant</option>
                            <option value="na">N/A</option>
                        </select>
                    </div>
                `;
            });
            
            html += `
                    </div>
                    <div style="margin-top: 2rem;">
                        <div style="display: flex; gap: 1rem;">
                            <button onclick="submitChecklist()" 
                                    style="
                                        background: var(--primary);
                                        color: white;
                                        border: none;
                                        padding: 0.75rem 1.5rem;
                                        border-radius: 8px;
                                        cursor: pointer;
                                        font-weight: 500;
                                        flex: 1;
                                    ">
                                üìã Submit Completed Checklist
                            </button>
                            <button onclick="loadSafetyChecklists()" 
                                    style="
                                        background: var(--background);
                                        border: 1px solid var(--border);
                                        padding: 0.75rem 1.5rem;
                                        border-radius: 8px;
                                        cursor: pointer;
                                        flex: 1;
                                    ">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            checklistContent.innerHTML = html;
        }

        function submitChecklist() {
            alert('‚úÖ Checklist submitted successfully! Report has been saved.');
            loadSafetyChecklists();
        }

        // Risk Calculator
        function loadRiskCalculator() {
            const riskContent = document.getElementById('riskCalculatorContent');
            if (!riskContent) return;
            
            let html = `
                <div style="margin-bottom: 2rem;">
                    <h3 style="color: var(--text); margin-bottom: 1rem;">Risk Assessment Calculator</h3>
                    <div style="background: var(--background); border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Hazard Description</label>
                            <textarea id="hazardDescription" 
                                      style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 6px; min-height: 80px;"
                                      placeholder="Describe the hazard or risk..."></textarea>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Likelihood</label>
                                <select id="likelihoodScore" 
                                        style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 6px;">
                                    <option value="">Select likelihood</option>
                                    <option value="1">1 - Rare</option>
                                    <option value="2">2 - Unlikely</option>
                                    <option value="3">3 - Possible</option>
                                    <option value="4">4 - Likely</option>
                                    <option value="5">5 - Almost Certain</option>
                                </select>
                                <div id="likelihoodDescription" style="font-size: 0.85rem; color: var(--text-light); margin-top: 0.5rem;"></div>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Consequence</label>
                                <select id="consequenceScore" 
                                        style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 6px;">
                                    <option value="">Select consequence</option>
                                    <option value="1">1 - Insignificant</option>
                                    <option value="2">2 - Minor</option>
                                    <option value="3">3 - Moderate</option>
                                    <option value="4">4 - Major</option>
                                    <option value="5">5 - Catastrophic</option>
                                </select>
                                <div id="consequenceDescription" style="font-size: 0.85rem; color: var(--text-light); margin-top: 0.5rem;"></div>
                            </div>
                        </div>
                        
                        <div id="riskResult" style="display: none; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                            <div style="font-weight: 600; margin-bottom: 0.5rem;" id="riskLevel"></div>
                            <div style="font-size: 0.9rem;" id="riskScore"></div>
                            <div style="font-size: 0.85rem; color: var(--text-light); margin-top: 0.5rem;" id="riskActions"></div>
                        </div>
                        
                        <div style="display: flex; gap: 1rem;">
                            <button onclick="calculateRisk()" 
                                    style="
                                        background: var(--primary);
                                        color: white;
                                        border: none;
                                        padding: 0.75rem 1.5rem;
                                        border-radius: 8px;
                                        cursor: pointer;
                                        font-weight: 500;
                                        flex: 1;
                                    ">
                                üìä Calculate Risk
                            </button>
                            <button onclick="saveRiskAssessment()" 
                                    style="
                                        background: var(--success);
                                        color: white;
                                        border: none;
                                        padding: 0.75rem 1.5rem;
                                        border-radius: 8px;
                                        cursor: pointer;
                                        font-weight: 500;
                                        flex: 1;
                                    ">
                                üíæ Save Assessment
                            </button>
                            <button onclick="resetCalculator()" 
                                    style="
                                        background: var(--background);
                                        border: 1px solid var(--border);
                                        padding: 0.75rem 1.5rem;
                                        border-radius: 8px;
                                        cursor: pointer;
                                        flex: 1;
                                    ">
                                üîÑ Reset
                            </button>
                        </div>
                    </div>
                    
                    <div style="background: white; border: 1px solid var(--border); border-radius: 8px; padding: 1rem;">
                        <div style="font-weight: 600; color: var(--text); margin-bottom: 0.5rem;">Risk Matrix Guide</div>
                        <div style="font-size: 0.85rem; color: var(--text-light);">
                            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.5rem; margin-top: 0.5rem;">
                                <div style="background: #dcfce7; padding: 0.5rem; text-align: center; border-radius: 4px; font-size: 0.75rem;">Low (1-4)</div>
                                <div style="background: #fef3c7; padding: 0.5rem; text-align: center; border-radius: 4px; font-size: 0.75rem;">Medium (5-9)</div>
                                <div style="background: #fed7aa; padding: 0.5rem; text-align: center; border-radius: 4px; font-size: 0.75rem;">High (10-14)</div>
                                <div style="background: #fecaca; padding: 0.5rem; text-align: center; border-radius: 4px; font-size: 0.75rem;">Very High (15-19)</div>
                                <div style="background: #fca5a5; padding: 0.5rem; text-align: center; border-radius: 4px; font-size: 0.75rem;">Extreme (20-25)</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            riskContent.innerHTML = html;
            
            // Add event listeners
            document.getElementById('likelihoodScore')?.addEventListener('change', updateRiskDescriptions);
            document.getElementById('consequenceScore')?.addEventListener('change', updateRiskDescriptions);
        }

        function updateRiskDescriptions() {
            const likelihood = document.getElementById('likelihoodScore')?.value;
            const consequence = document.getElementById('consequenceScore')?.value;
            
            const likelihoodDescriptions = {
                '1': 'Occurs only in exceptional circumstances',
                '2': 'Could occur but not expected',
                '3': 'Might occur at some time',
                '4': 'Will probably occur',
                '5': 'Expected to occur frequently'
            };
            
            const consequenceDescriptions = {
                '1': 'No injury, negligible financial loss',
                '2': 'Minor injury, minor financial loss',
                '3': 'Medical treatment required, moderate loss',
                '4': 'Serious injury, major financial loss',
                '5': 'Death, catastrophic financial loss'
            };
            
            if (likelihood && likelihoodDescriptions[likelihood]) {
                document.getElementById('likelihoodDescription').textContent = likelihoodDescriptions[likelihood];
            }
            
            if (consequence && consequenceDescriptions[consequence]) {
                document.getElementById('consequenceDescription').textContent = consequenceDescriptions[consequence];
            }
            
            if (likelihood && consequence) {
                calculateRisk();
            }
        }

        function calculateRisk() {
            const likelihood = parseInt(document.getElementById('likelihoodScore')?.value || '0');
            const consequence = parseInt(document.getElementById('consequenceScore')?.value || '0');
            
            if (!likelihood || !consequence) {
                alert('Please select both likelihood and consequence scores');
                return;
            }
            
            const riskScore = likelihood * consequence;
            let riskLevel = '';
            let riskColor = '';
            let actions = '';
            
            if (riskScore <= 4) {
                riskLevel = 'Low Risk';
                riskColor = '#dcfce7';
                actions = 'Monitor periodically. No immediate action required.';
            } else if (riskScore <= 9) {
                riskLevel = 'Medium Risk';
                riskColor = '#fef3c7';
                actions = 'Take action within 30 days. Implement controls.';
            } else if (riskScore <= 14) {
                riskLevel = 'High Risk';
                riskColor = '#fed7aa';
                actions = 'Take action within 7 days. Implement immediate controls.';
            } else if (riskScore <= 19) {
                riskLevel = 'Very High Risk';
                riskColor = '#fecaca';
                actions = 'Take immediate action. Stop work if necessary.';
            } else {
                riskLevel = 'Extreme Risk';
                riskColor = '#fca5a5';
                actions = 'Stop work immediately. Evacuate if necessary.';
            }
            
            const resultDiv = document.getElementById('riskResult');
            resultDiv.style.display = 'block';
            resultDiv.style.backgroundColor = riskColor;
            resultDiv.style.border = `2px solid ${riskColor.replace('0.8', '1')}`;
            
            document.getElementById('riskLevel').textContent = `Risk Level: ${riskLevel}`;
            document.getElementById('riskScore').textContent = `Risk Score: ${riskScore} (Likelihood: ${likelihood} √ó Consequence: ${consequence})`;
            document.getElementById('riskActions').textContent = `Recommended Actions: ${actions}`;
        }

        function saveRiskAssessment() {
            const hazard = document.getElementById('hazardDescription')?.value;
            const likelihood = document.getElementById('likelihoodScore')?.value;
            const consequence = document.getElementById('consequenceScore')?.value;
            
            if (!hazard || !likelihood || !consequence) {
                alert('Please complete all fields before saving');
                return;
            }
            
            const riskScore = parseInt(likelihood) * parseInt(consequence);
            
            // Save to localStorage
            let assessments = JSON.parse(localStorage.getItem('mmsRiskAssessments') || '[]');
            assessments.push({
                id: `RISK-${Date.now()}`,
                hazard: hazard,
                likelihood: likelihood,
                consequence: consequence,
                riskScore: riskScore,
                date: new Date().toISOString(),
                status: 'Open'
            });
            
            localStorage.setItem('mmsRiskAssessments', JSON.stringify(assessments));
            
            alert('‚úÖ Risk assessment saved successfully!');
            resetCalculator();
        }

        function resetCalculator() {
            document.getElementById('hazardDescription').value = '';
            document.getElementById('likelihoodScore').value = '';
            document.getElementById('consequenceScore').value = '';
            document.getElementById('likelihoodDescription').textContent = '';
            document.getElementById('consequenceDescription').textContent = '';
            document.getElementById('riskResult').style.display = 'none';
        }

        // Equipment Inspections
        function loadEquipmentInspections() {
            const equipmentContent = document.getElementById('equipmentContent');
            if (!equipmentContent) return;
            
            // Load from localStorage
            let equipmentList = JSON.parse(localStorage.getItem('mmsEquipment') || '[]');
            
            // If no equipment, show default
            if (equipmentList.length === 0) {
                equipmentList = [
                    {
                        id: 'EQ-001',
                        name: 'Forklift - Toyota 8FGU25',
                        type: 'Forklift',
                        location: 'Cape Town HQ',
                        serialNumber: 'FL-2023-001',
                        lastInspection: '2024-01-15',
                        nextInspection: '2024-02-15',
                        status: 'Operational',
                        inspectionDue: false
                    },
                    {
                        id: 'EQ-002',
                        name: 'Overhead Crane - 5 Ton',
                        type: 'Crane',
                        location: 'Impala Dar',
                        serialNumber: 'CR-2023-002',
                        lastInspection: '2024-01-10',
                        nextInspection: '2024-04-10',
                        status: 'Operational',
                        inspectionDue: false
                    }
                ];
            }
            
            let html = `
                <div style="margin-bottom: 2rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 style="color: var(--text);">Equipment Inspection Manager</h3>
                        <button onclick="addNewEquipment()" 
                                style="
                                    background: var(--success);
                                    color: white;
                                    border: none;
                                    padding: 0.5rem 1rem;
                                    border-radius: 6px;
                                    cursor: pointer;
                                    display: flex;
                                    align-items: center;
                                    gap: 0.5rem;
                                ">
                            + Add Equipment
                        </button>
                    </div>
            `;
            
            if (equipmentList.length === 0) {
                html += `
                    <div style="text-align: center; padding: 3rem; background: var(--background); border-radius: 10px;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üîß</div>
                        <h4 style="color: var(--text-light);">No equipment registered</h4>
                        <p>Start by adding your first piece of equipment</p>
                        <button onclick="addNewEquipment()" 
                                style="
                                    background: var(--primary);
                                    color: white;
                                    border: none;
                                    padding: 0.75rem 1.5rem;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    margin-top: 1rem;
                                ">
                            + Add First Equipment
                        </button>
                    </div>
                `;
            } else {
                // Calculate statistics
                const total = equipmentList.length;
                const overdue = equipmentList.filter(e => {
                    const nextInspection = new Date(e.nextInspection);
                    return nextInspection < new Date();
                }).length;
                const complianceRate = Math.round(((total - overdue) / total) * 100);
                
                html += `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                        <div style="background: white; border: 1px solid var(--border); border-radius: 8px; padding: 1rem; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: 600; color: var(--text);">${total}</div>
                            <div style="font-size: 0.85rem; color: var(--text-light);">Total Equipment</div>
                        </div>
                        <div style="background: white; border: 1px solid var(--border); border-radius: 8px; padding: 1rem; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: 600; color: ${overdue > 0 ? 'var(--error)' : 'var(--success)'}">${overdue}</div>
                            <div style="font-size: 0.85rem; color: var(--text-light);">Overdue Inspections</div>
                        </div>
                        <div style="background: white; border: 1px solid var(--border); border-radius: 8px; padding: 1rem; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: 600; color: var(--primary);">${complianceRate}%</div>
                            <div style="font-size: 0.85rem; color: var(--text-light);">Compliance Rate</div>
                        </div>
                    </div>
                `;
                
                // Equipment table
                html += `
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: var(--background);">
                                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid var(--border);">Equipment</th>
                                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid var(--border);">Type</th>
                                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid var(--border);">Location</th>
                                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid var(--border);">Last Inspection</th>
                                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid var(--border);">Next Due</th>
                                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid var(--border);">Status</th>
                                    <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid var(--border);">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                equipmentList.forEach(equipment => {
                    const nextInspection = new Date(equipment.nextInspection);
                    const today = new Date();
                    const isOverdue = nextInspection < today;
                    
                    html += `
                        <tr style="border-bottom: 1px solid var(--border);">
                            <td style="padding: 0.75rem;">
                                <div style="font-weight: 500;">${equipment.name}</div>
                                <div style="font-size: 0.75rem; color: var(--text-light);">${equipment.serialNumber || 'No serial'}</div>
                            </td>
                            <td style="padding: 0.75rem;">${equipment.type}</td>
                            <td style="padding: 0.75rem;">${equipment.location}</td>
                            <td style="padding: 0.75rem;">${equipment.lastInspection || 'Never'}</td>
                            <td style="padding: 0.75rem;">
                                <div style="color: ${isOverdue ? 'var(--error)' : 'var(--success)'}; font-weight: ${isOverdue ? '600' : 'normal'}">
                                    ${equipment.nextInspection || 'Not set'}
                                    ${isOverdue ? ' ‚ö†Ô∏è' : ''}
                                </div>
                            </td>
                            <td style="padding: 0.75rem;">
                                <span style="
                                    padding: 0.25rem 0.5rem;
                                    border-radius: 4px;
                                    font-size: 0.75rem;
                                    font-weight: 500;
                                    background: ${equipment.status === 'Operational' ? '#dcfce7' : '#fef3c7'};
                                    color: ${equipment.status === 'Operational' ? '#166534' : '#92400e'};
                                ">
                                    ${equipment.status}
                                </span>
                            </td>
                            <td style="padding: 0.75rem;">
                                <button onclick="scheduleEquipmentInspection('${equipment.id}')" 
                                        style="
                                            background: var(--primary);
                                            color: white;
                                            border: none;
                                            padding: 0.25rem 0.5rem;
                                            border-radius: 4px;
                                            font-size: 0.75rem;
                                            cursor: pointer;
                                            margin-right: 0.25rem;
                                        ">
                                    Schedule
                                </button>
                                <button onclick="viewEquipmentDetails('${equipment.id}')"
                                        style="
                                            background: var(--secondary);
                                            color: white;
                                            border: none;
                                            padding: 0.25rem 0.5rem;
                                            border-radius: 4px;
                                            font-size: 0.75rem;
                                            cursor: pointer;
                                        ">
                                    View
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                html += `</tbody></table></div>`;
            }
            
            html += `</div>`;
            equipmentContent.innerHTML = html;
        }

        function addNewEquipment() {
            const equipmentContent = document.getElementById('equipmentContent');
            equipmentContent.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 2rem;">
                    <h3 style="color: var(--text); margin-bottom: 1.5rem;">Add New Equipment</h3>
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Equipment Name</label>
                        <input type="text" id="newEquipmentName" 
                               style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 6px;"
                               placeholder="e.g., Forklift - Toyota 8FGU25">
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Type</label>
                        <select id="newEquipmentType" 
                                style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 6px;">
                            <option value="">Select type</option>
                            <option value="Forklift">Forklift</option>
                            <option value="Crane">Crane</option>
                            <option value="Hoist">Hoist</option>
                            <option value="Press">Press</option>
                            <option value="Welder">Welder</option>
                            <option value="Generator">Generator</option>
                            <option value="Compressor">Compressor</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Location</label>
                        <select id="newEquipmentLocation" 
                                style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 6px;">
                            <option value="">Select location</option>
                            ${locations.map(loc => 
                                `<option value="${loc.name}">${loc.name} (${loc.country})</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Serial Number (Optional)</label>
                        <input type="text" id="newEquipmentSerial" 
                               style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 6px;"
                               placeholder="Enter serial number">
                    </div>
                    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                        <button onclick="saveNewEquipment()" 
                                style="background: var(--success); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; flex: 1;">
                            Save Equipment
                        </button>
                        <button onclick="loadEquipmentInspections()" 
                                style="background: var(--secondary); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; flex: 1;">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
        }

        function saveNewEquipment() {
            const name = document.getElementById('newEquipmentName')?.value;
            const type = document.getElementById('newEquipmentType')?.value;
            const location = document.getElementById('newEquipmentLocation')?.value;
            const serial = document.getElementById('newEquipmentSerial')?.value;
            
            if (!name || !type || !location) {
                alert('Please fill all required fields');
                return;
            }
            
            // Save to localStorage
            let equipmentList = JSON.parse(localStorage.getItem('mmsEquipment') || '[]');
            
            const newEquipment = {
                id: `EQ-${Date.now().toString().slice(-6)}`,
                name: name,
                type: type,
                location: location,
                serialNumber: serial || '',
                lastInspection: new Date().toISOString().split('T')[0],
                nextInspection: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // 30 days from now
                status: 'Operational',
                inspectionDue: false
            };
            
            equipmentList.push(newEquipment);
            localStorage.setItem('mmsEquipment', JSON.stringify(equipmentList));
            
            alert('‚úÖ Equipment added successfully!');
            loadEquipmentInspections();
        }

        function scheduleEquipmentInspection(equipmentId) {
            alert(`Inspection scheduled for equipment ${equipmentId}`);
            // In a real app, this would open a scheduling modal
        }

        function viewEquipmentDetails(equipmentId) {
            alert(`Viewing details for equipment ${equipmentId}`);
            // In a real app, this would show equipment details
        }

        // Other module loaders (simplified versions)
        function loadChemicalRegister() {
            const chemicalContent = document.getElementById('chemicalContent');
            chemicalContent.innerHTML = `
                <div style="text-align: center; padding: 3rem;">
                    <div style="font-size: 4rem;">üß™</div>
                    <h3>Chemical Safety Register</h3>
                    <p>Chemical inventory and safety data sheet management</p>
                    <div style="margin-top: 2rem;">
                        <button onclick="alert('Chemical Register coming soon!')" 
                                style="background: var(--primary); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">
                            Open Chemical Register
                        </button>
                    </div>
                </div>
            `;
        }

        function loadSafetyObservations() {
            const observationContent = document.getElementById('observationContent');
            observationContent.innerHTML = `
                <div style="text-align: center; padding: 3rem;">
                    <div style="font-size: 4rem;">üëÅÔ∏è</div>
                    <h3>Safety Observations</h3>
                    <p>Record and track daily safety observations and near-misses</p>
                    <div style="margin-top: 2rem;">
                        <button onclick="alert('Safety Observations coming soon!')" 
                                style="background: var(--primary); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">
                            Record Observation
                        </button>
                    </div>
                </div>
            `;
        }

        function loadIncidentInvestigator() {
            const investigationContent = document.getElementById('investigationContent');
            investigationContent.innerHTML = `
                <div style="text-align: center; padding: 3rem;">
                    <div style="font-size: 4rem;">üîç</div>
                    <h3>Incident Investigator</h3>
                    <p>Complete investigation toolkit with root cause analysis</p>
                    <div style="margin-top: 2rem;">
                        <button onclick="alert('Incident Investigator coming soon!')" 
                                style="background: var(--primary); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">
                            Start Investigation
                        </button>
                    </div>
                </div>
            `;
        }

        // Modal open handlers for new modules
        function openEmergencyWizard() {
            openModal('emergencyModal');
            setTimeout(() => loadEmergencyProcedures(), 100);
        }

        function openSafetyChecklist() {
            openModal('checklistModal');
            setTimeout(() => loadSafetyChecklists(), 100);
        }

        function openRiskCalculator() {
            openModal('riskCalculatorModal');
            setTimeout(() => loadRiskCalculator(), 100);
        }

        // ==================== EXISTING APPLICATION CODE ====================

        // Initialize Application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupInstallButtons();
            
            // Fix for module initialization timing
            setTimeout(() => {
                initializeNewModules();
            }, 1000);
        });

        // PWA Install Button Setup
        function setupInstallButtons() {
            const headerBtn = document.getElementById('installBtn');
            const sidebarBtn = document.getElementById('sidebarInstallBtn');
            
            if (headerBtn && window.pwaInstaller) {
                headerBtn.addEventListener('click', () => window.pwaInstaller.installPWA());
            }
            if (sidebarBtn && window.pwaInstaller) {
                sidebarBtn.addEventListener('click', () => window.pwaInstaller.installPWA());
            }
        }

        function initializeApp() {
            loadAllData();
            initializeCharts();
            loadAllTables();
            loadStandards();
            loadRiskMatrix();
            setupEventListeners();
            updateStatistics();
            populateEmployeeSelects();
            
            // Set default dates for chart
            const endDate = new Date();
            const startDate = new Date();
            startDate.setMonth(startDate.getMonth() - 6);
            
            document.getElementById('startDate').valueAsDate = startDate;
            document.getElementById('endDate').valueAsDate = endDate;
            
            // Set current date/time for incident report
            const now = new Date();
            const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000)
                .toISOString()
                .slice(0, 16);
            document.getElementById('incidentDateTime').value = localDateTime;
            
            // Load settings
            loadSettings();
        }

        function loadAllData() {
            // Load incidents
            const savedIncidents = localStorage.getItem('mmsIncidents');
            incidents = savedIncidents ? JSON.parse(savedIncidents) : getDefaultIncidents();
            
            // Load other data...
            const savedPPE = localStorage.getItem('mmsPPEItems');
            ppeItems = savedPPE ? JSON.parse(savedPPE) : getDefaultPPE();
            
            const savedHealth = localStorage.getItem('mmsHealthRecords');
            healthRecords = savedHealth ? JSON.parse(savedHealth) : getDefaultHealthRecords();
            
            const savedContractors = localStorage.getItem('mmsContractors');
            contractors = savedContractors ? JSON.parse(savedContractors) : getDefaultContractors();
            
            const savedAudits = localStorage.getItem('mmsAudits');
            audits = savedAudits ? JSON.parse(savedAudits) : getDefaultAudits();
            
            const savedStandards = localStorage.getItem('mmsStandards');
            standards = savedStandards ? JSON.parse(savedStandards) : getDefaultStandards();
            
            const savedTraining = localStorage.getItem('mmsTraining');
            trainingRecords = savedTraining ? JSON.parse(savedTraining) : getDefaultTraining();
            
            console.log('üìä Loaded all data:', {
                incidents: incidents.length,
                ppe: ppeItems.length,
                health: healthRecords.length,
                contractors: contractors.length,
                audits: audits.length,
                standards: standards.length,
                training: trainingRecords.length
            });
        }

        function getDefaultIncidents() {
            return [
                {
                    id: 'INC-001',
                    type: 'Near Miss',
                    severity: 'Minor',
                    location: 'Cape Town HQ',
                    department: 'Operations',
                    reportedBy: 'John Smith',
                    description: 'Slip hazard near main entrance',
                    actions: 'Warned staff, placed warning sign',
                    status: 'Resolved',
                    date: new Date().toISOString()
                },
                {
                    id: 'INC-002',
                    type: 'First Aid',
                    severity: 'Moderate',
                    location: 'Impala Dar',
                    department: 'Inventory Control',
                    reportedBy: 'Sarah Johnson',
                    description: 'Minor cut from packaging material',
                    actions: 'Applied first aid, documented',
                    status: 'Reported',
                    date: new Date(Date.now() - 86400000).toISOString()
                }
            ];
        }

        function getDefaultPPE() {
            return [
                {
                    id: 'PPE-001',
                    type: 'Safety Helmet',
                    size: 'M',
                    brand: '3M',
                    quantity: 50,
                    location: 'Cape Town HQ',
                    status: 'Available',
                    lastInspection: '2024-01-15',
                    nextInspection: '2024-04-15',
                    condition: 'Good'
                }
            ];
        }

        function getDefaultHealthRecords() {
            return [
                {
                    id: 'EMP-001',
                    name: 'John Smith',
                    location: 'Cape Town HQ',
                    position: 'Operations Manager',
                    lastMedical: '2024-01-10',
                    nextDue: '2025-01-10',
                    bloodGroup: 'O+',
                    allergies: 'None',
                    medicalStatus: 'Fit for Duty',
                    emergencyContact: 'Jane Smith - 0821234567'
                }
            ];
        }

        function getDefaultContractors() {
            return [
                {
                    id: 'CON-001',
                    company: 'ABC Electrical',
                    contactPerson: 'Mike Johnson',
                    phone: '0829876543',
                    email: 'mike@abcelectrical.co.za',
                    workType: 'Electrical Maintenance',
                    location: 'Cape Town HQ',
                    startDate: '2024-01-01',
                    endDate: '2024-12-31',
                    safetyRating: 'A',
                    status: 'Active'
                }
            ];
        }

        function getDefaultAudits() {
            return [
                {
                    id: 'AUD-001',
                    type: 'Monthly Safety Audit',
                    location: 'Cape Town HQ',
                    auditDate: '2024-01-20',
                    auditor: 'Safety Officer',
                    score: 92,
                    status: 'Completed',
                    findings: 'Minor issues found in PPE storage',
                    correctiveActions: 'Reorganize PPE storage area',
                    nextAudit: '2024-02-20'
                }
            ];
        }

        function getDefaultStandards() {
            return [
                {
                    id: 'STD-001',
                    name: 'ISO 45001:2018',
                    code: 'ISO45001',
                    type: 'International',
                    description: 'Occupational health and safety management systems',
                    status: 'Compliant',
                    effectiveDate: '2023-01-01',
                    remarks: 'Fully implemented'
                },
                {
                    id: 'STD-002',
                    name: 'OSHA Regulations',
                    code: 'OSHA-2023',
                    type: 'National',
                    country: 'South Africa',
                    description: 'Occupational Safety and Health Administration regulations',
                    status: 'In Progress',
                    effectiveDate: '2023-06-01',
                    remarks: 'Implementation ongoing'
                }
            ];
        }

        function getDefaultTraining() {
            return [
                {
                    id: 'TRN-001',
                    employee: 'John Smith',
                    type: 'Basic Safety Induction',
                    provider: 'MMS Safety',
                    startDate: '2024-01-05',
                    endDate: '2024-01-05',
                    status: 'Completed',
                    score: 95,
                    expiryDate: '2025-01-05',
                    notes: 'Excellent performance'
                }
            ];
        }

        function loadAllTables() {
            loadIncidentsTable();
            loadPPETable();
            loadPPEIssuanceTable();
            loadHealthTable();
            loadContractorTable();
            loadContractorPermitsTable();
            loadAuditTable();
            loadAuditScheduleTable();
            loadTrainingTable();
        }

        function loadIncidentsTable() {
            const tableBody = document.getElementById('modalIncidentsTableBody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            incidents.forEach(incident => {
                const row = document.createElement('tr');
                const date = new Date(incident.date);
                const formattedDate = date.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                });
                
                row.innerHTML = `
                    <td class="editable" onclick="startEditing(this, 'id')">${incident.id}</td>
                    <td class="editable" onclick="startEditing(this, 'type')">${incident.type}</td>
                    <td class="editable" onclick="startEditing(this, 'date')">${formattedDate}</td>
                    <td class="editable" onclick="startEditing(this, 'location')">${incident.location}</td>
                    <td class="editable" onclick="startEditing(this, 'reportedBy')">${incident.reportedBy}</td>
                    <td class="editable" onclick="startEditing(this, 'severity')">${incident.severity}</td>
                    <td class="editable" onclick="startEditing(this, 'status')">${incident.status}</td>
                    <td class="editable" onclick="startEditing(this, 'description')">${incident.description}</td>
                    <td class="editable" onclick="startEditing(this, 'actions')">${incident.actions}</td>
                    <td class="editable" onclick="startEditing(this, 'recommendations')">${incident.recommendations || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteIncident('${incident.id}')">Delete</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        function loadPPETable() {
            const tableBody = document.getElementById('ppeTableBody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            ppeItems.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="editable" onclick="startEditing(this, 'id')">${item.id}</td>
                    <td class="editable" onclick="startEditing(this, 'type')">${item.type}</td>
                    <td class="editable" onclick="startEditing(this, 'size')">${item.size}</td>
                    <td class="editable" onclick="startEditing(this, 'brand')">${item.brand}</td>
                    <td class="editable" onclick="startEditing(this, 'quantity')">${item.quantity}</td>
                    <td class="editable" onclick="startEditing(this, 'location')">${item.location}</td>
                    <td class="editable" onclick="startEditing(this, 'status')">${item.status}</td>
                    <td class="editable" onclick="startEditing(this, 'lastInspection')">${item.lastInspection}</td>
                    <td class="editable" onclick="startEditing(this, 'nextInspection')">${item.nextInspection}</td>
                    <td class="editable" onclick="startEditing(this, 'condition')">${item.condition}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deletePPEItem('${item.id}')">Delete</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        function loadPPEIssuanceTable() {
            const tableBody = document.getElementById('ppeIssuanceTableBody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            ppeIssuance.forEach(issue => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${issue.id}</td>
                    <td>${issue.ppeId}</td>
                    <td>${issue.employee}</td>
                    <td>${issue.issueDate}</td>
                    <td>${issue.expiryDate}</td>
                    <td>${issue.issuedBy}</td>
                    <td>${issue.returnDate || '-'}</td>
                    <td>${issue.status}</td>
                    <td>
                        <button class="btn btn-sm btn-success" onclick="returnPPE('${issue.id}')">Return</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        function loadHealthTable() {
            const tableBody = document.getElementById('healthTableBody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            healthRecords.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="editable" onclick="startEditing(this, 'id')">${record.id}</td>
                    <td class="editable" onclick="startEditing(this, 'name')">${record.name}</td>
                    <td class="editable" onclick="startEditing(this, 'location')">${record.location}</td>
                    <td class="editable" onclick="startEditing(this, 'position')">${record.position}</td>
                    <td class="editable" onclick="startEditing(this, 'lastMedical')">${record.lastMedical}</td>
                    <td class="editable" onclick="startEditing(this, 'nextDue')">${record.nextDue}</td>
                    <td class="editable" onclick="startEditing(this, 'bloodGroup')">${record.bloodGroup}</td>
                    <td class="editable" onclick="startEditing(this, 'allergies')">${record.allergies}</td>
                    <td class="editable" onclick="startEditing(this, 'medicalStatus')">${record.medicalStatus}</td>
                    <td class="editable" onclick="startEditing(this, 'emergencyContact')">${record.emergencyContact}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteHealthRecord('${record.id}')">Delete</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        function loadContractorTable() {
            const tableBody = document.getElementById('contractorTableBody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            contractors.forEach(contractor => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="editable" onclick="startEditing(this, 'id')">${contractor.id}</td>
                    <td class="editable" onclick="startEditing(this, 'company')">${contractor.company}</td>
                    <td class="editable" onclick="startEditing(this, 'contactPerson')">${contractor.contactPerson}</td>
                    <td class="editable" onclick="startEditing(this, 'phone')">${contractor.phone}</td>
                    <td class="editable" onclick="startEditing(this, 'email')">${contractor.email}</td>
                    <td class="editable" onclick="startEditing(this, 'workType')">${contractor.workType}</td>
                    <td class="editable" onclick="startEditing(this, 'location')">${contractor.location}</td>
                    <td class="editable" onclick="startEditing(this, 'startDate')">${contractor.startDate}</td>
                    <td class="editable" onclick="startEditing(this, 'endDate')">${contractor.endDate}</td>
                    <td class="editable" onclick="startEditing(this, 'safetyRating')">${contractor.safetyRating}</td>
                    <td class="editable" onclick="startEditing(this, 'status')">${contractor.status}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteContractor('${contractor.id}')">Delete</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        function loadContractorPermitsTable() {
            const tableBody = document.getElementById('contractorPermitsTableBody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            contractorPermits.forEach(permit => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${permit.id}</td>
                    <td>${permit.contractorId}</td>
                    <td>${permit.workType}</td>
                    <td>${permit.location}</td>
                    <td>${permit.issuedDate}</td>
                    <td>${permit.expiryDate}</td>
                    <td>${permit.issuedBy}</td>
                    <td>${permit.status}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="revokePermit('${permit.id}')">Revoke</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        function loadAuditTable() {
            const tableBody = document.getElementById('auditTableBody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            audits.forEach(audit => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="editable" onclick="startEditing(this, 'id')">${audit.id}</td>
                    <td class="editable" onclick="startEditing(this, 'type')">${audit.type}</td>
                    <td class="editable" onclick="startEditing(this, 'location')">${audit.location}</td>
                    <td class="editable" onclick="startEditing(this, 'auditDate')">${audit.auditDate}</td>
                    <td class="editable" onclick="startEditing(this, 'auditor')">${audit.auditor}</td>
                    <td class="editable" onclick="startEditing(this, 'score')">${audit.score}</td>
                    <td class="editable" onclick="startEditing(this, 'status')">${audit.status}</td>
                    <td class="editable" onclick="startEditing(this, 'findings')">${audit.findings}</td>
                    <td class="editable" onclick="startEditing(this, 'correctiveActions')">${audit.correctiveActions}</td>
                    <td class="editable" onclick="startEditing(this, 'nextAudit')">${audit.nextAudit}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteAudit('${audit.id}')">Delete</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        function loadAuditScheduleTable() {
            const tableBody = document.getElementById('auditScheduleTableBody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            auditSchedule.forEach(schedule => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${schedule.id}</td>
                    <td>${schedule.auditType}</td>
                    <td>${schedule.location}</td>
                    <td>${schedule.scheduledDate}</td>
                    <td>${schedule.frequency}</td>
                    <td>${schedule.assignedTo}</td>
                    <td>${schedule.status}</td>
                    <td>${schedule.priority}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="cancelSchedule('${schedule.id}')">Cancel</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        function loadTrainingTable() {
            const tableBody = document.getElementById('trainingTableBody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            trainingRecords.forEach(training => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="editable" onclick="startEditing(this, 'id')">${training.id}</td>
                    <td class="editable" onclick="startEditing(this, 'employee')">${training.employee}</td>
                    <td class="editable" onclick="startEditing(this, 'type')">${training.type}</td>
                    <td class="editable" onclick="startEditing(this, 'provider')">${training.provider}</td>
                    <td class="editable" onclick="startEditing(this, 'startDate')">${training.startDate}</td>
                    <td class="editable" onclick="startEditing(this, 'endDate')">${training.endDate}</td>
                    <td class="editable" onclick="startEditing(this, 'status')">${training.status}</td>
                    <td class="editable" onclick="startEditing(this, 'score')">${training.score}</td>
                    <td class="editable" onclick="startEditing(this, 'expiryDate')">${training.expiryDate}</td>
                    <td class="editable" onclick="startEditing(this, 'notes')">${training.notes}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteTraining('${training.id}')">Delete</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        function loadStandards() {
            const standardsGrid = document.getElementById('standardsGrid');
            if (!standardsGrid) return;
            
            standardsGrid.innerHTML = '';
            
            standards.forEach(standard => {
                const card = document.createElement('div');
                card.className = 'standard-card';
                
                // Determine badge class
                let badgeClass = 'badge-international';
                if (standard.type === 'National') badgeClass = 'badge-national';
                if (standard.type === 'Company') badgeClass = 'badge-company';
                if (standard.type === 'Personal') badgeClass = 'badge-personal';
                
                // Determine status class
                let statusClass = 'status-compliant';
                if (standard.status === 'Non-Compliant') statusClass = 'status-noncompliant';
                if (standard.status === 'In Progress') statusClass = 'status-inprogress';
                if (standard.status === 'Pending Review') statusClass = 'status-pending';
                
                card.innerHTML = `
                    <span class="standard-badge ${badgeClass}">${standard.type}</span>
                    <h3>${standard.name}</h3>
                    <div class="standard-code">${standard.code}</div>
                    ${standard.country ? `<span class="standard-industry">${standard.country}</span>` : ''}
                    <div class="standard-status ${statusClass}">${standard.status}</div>
                    <p>${standard.description}</p>
                    ${standard.effectiveDate ? `<div style="font-size: 0.85rem; color: var(--text-light); margin-top: 0.5rem;">Effective: ${standard.effectiveDate}</div>` : ''}
                    ${standard.remarks ? `<div style="font-size: 0.85rem; color: var(--text-light); margin-top: 0.5rem;">${standard.remarks}</div>` : ''}
                    <div class="standard-actions">
                        <button class="btn btn-sm btn-outline" onclick="editStandard('${standard.id}')">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteStandard('${standard.id}')">Delete</button>
                    </div>
                `;
                
                standardsGrid.appendChild(card);
            });
        }

        function loadRiskMatrix() {
            const matrixContainer = document.getElementById('riskMatrix');
            const modalMatrix = document.getElementById('modalRiskMatrix');
            
            if (!matrixContainer && !modalMatrix) return;
            
            const riskLevels = [
                { level: 1, label: 'Low', class: 'risk-low' },
                { level: 2, label: 'Low-Medium', class: 'risk-low' },
                { level: 3, label: 'Medium', class: 'risk-medium' },
                { level: 4, label: 'Medium-High', class: 'risk-medium' },
                { level: 5, label: 'High', class: 'risk-high' },
                { level: 6, label: 'High', class: 'risk-high' },
                { level: 7, label: 'High-Very High', class: 'risk-high' },
                { level: 8, label: 'Very High', class: 'risk-very-high' },
                { level: 9, label: 'Very High', class: 'risk-very-high' },
                { level: 10, label: 'Extreme', class: 'risk-extreme' }
            ];
            
            const matrixHTML = riskLevels.map(risk => `
                <div class="matrix-cell ${risk.class}" onclick="editRiskCell(this)">
                    <div style="font-size: 1.25rem; margin-bottom: 0.5rem;">${risk.level}</div>
                    <div>${risk.label}</div>
                    <div style="font-size: 0.75rem; margin-top: 0.5rem; opacity: 0.8;">Click to edit</div>
                </div>
            `).join('');
            
            if (matrixContainer) {
                matrixContainer.innerHTML = matrixHTML;
            }
            
            if (modalMatrix) {
                modalMatrix.innerHTML = matrixHTML;
            }
        }

        function updateStatistics() {
            // Update LTI count
            const ltiCount = incidents.filter(i => i.type === 'Lost Time Injury').length;
            document.getElementById('lostTimeInjuries').textContent = ltiCount;
            document.getElementById('ltiDetails').textContent = `Last 30 days: ${ltiCount} incidents`;
            
            // Update training count
            const trainingCount = trainingRecords.length;
            document.getElementById('safetyTrainings').textContent = trainingCount;
            
            // Update compliance rate
            const compliantStandards = standards.filter(s => s.status === 'Compliant').length;
            const complianceRate = standards.length > 0 ? Math.round((compliantStandards / standards.length) * 100) : 0;
            document.getElementById('complianceRate').textContent = `${complianceRate}%`;
            
            // Update audit count
            const activeAuditCount = audits.filter(a => a.status === 'In Progress' || a.status === 'Scheduled').length;
            document.getElementById('activeAudits').textContent = activeAuditCount;
        }

        function populateEmployeeSelects() {
            const select = document.getElementById('reportedBy');
            if (!select) return;
            
            // Clear existing options except first
            select.innerHTML = '<option value="">Select employee</option>';
            
            // Add employees from health records
            healthRecords.forEach(employee => {
                const option = document.createElement('option');
                option.value = employee.name;
                option.textContent = employee.name;
                select.appendChild(option);
            });
            
            // Also add some default options if no health records
            if (healthRecords.length === 0) {
                const defaultEmployees = [
                    'John Smith',
                    'Sarah Johnson',
                    'Mike Brown',
                    'Lisa Davis',
                    'Robert Wilson'
                ];
                
                defaultEmployees.forEach(employee => {
                    const option = document.createElement('option');
                    option.value = employee;
                    option.textContent = employee;
                    select.appendChild(option);
                });
            }
        }

        function submitIncidentReport() {
            const type = document.getElementById('incidentType').value;
            const severity = document.getElementById('incidentSeverity').value;
            const dateTime = document.getElementById('incidentDateTime').value;
            const location = document.getElementById('incidentLocation').value;
            const reportedBy = document.getElementById('reportedBy').value;
            const department = document.getElementById('incidentDepartment').value;
            const description = document.getElementById('incidentDescription').value;
            const actions = document.getElementById('immediateActions').value;
            const recommendations = document.getElementById('recommendations').value;
            
            // Validation
            if (!type || !severity || !dateTime || !location || !reportedBy || !department || !description) {
                document.getElementById('reportError').style.display = 'block';
                return;
            }
            
            // Generate ID
            const incidentId = `INC-${Date.now().toString().slice(-6)}`;
            
            // Create incident object
            const newIncident = {
                id: incidentId,
                type: type,
                severity: severity,
                date: new Date(dateTime).toISOString(),
                location: location,
                reportedBy: reportedBy,
                department: department,
                description: description,
                actions: actions,
                recommendations: recommendations,
                status: 'Reported'
            };
            
            // Add to incidents array
            incidents.unshift(newIncident);
            
            // Save to localStorage
            localStorage.setItem('mmsIncidents', JSON.stringify(incidents));
            
            // Update statistics
            updateStatistics();
            
            // Show success message
            document.getElementById('reportSuccess').style.display = 'block';
            document.getElementById('reportError').style.display = 'none';
            
            // Reset form
            setTimeout(() => {
                closeModal('reportIncidentModal');
                document.getElementById('reportSuccess').style.display = 'none';
                
                // Clear form
                document.getElementById('incidentType').value = '';
                document.getElementById('incidentSeverity').value = '';
                document.getElementById('incidentDateTime').value = '';
                document.getElementById('incidentLocation').value = '';
                document.getElementById('reportedBy').value = '';
                document.getElementById('incidentDepartment').value = '';
                document.getElementById('incidentDescription').value = '';
                document.getElementById('immediateActions').value = '';
                document.getElementById('recommendations').value = '';
                
                // Refresh incidents table if modal is open
                if (document.getElementById('incidentsModal').style.display === 'block') {
                    loadIncidentsTable();
                }
            }, 2000);
        }

        function startEditing(cell, field) {
            // If already editing, save first
            if (editingCell) {
                saveEditing();
            }
            
            // Get current value
            const currentValue = cell.textContent;
            const row = cell.parentElement;
            const rowIndex = Array.from(row.parentElement.children).indexOf(row);
            
            // Create input based on field type
            let input;
            if (field === 'type' || field === 'severity' || field === 'status' || field === 'location') {
                input = document.createElement('select');
                input.className = 'edit-select';
                
                const options = {
                    'type': ['Near Miss', 'First Aid', 'Medical Treatment', 'Lost Time Injury', 'Property Damage', 'Environmental Incident'],
                    'severity': ['Minor', 'Moderate', 'Serious', 'Critical'],
                    'status': ['Reported', 'In Progress', 'Resolved', 'Closed'],
                    'location': ['Cape Town HQ', 'Cosco Durban', 'AGL Durban', 'Impala Dar', 'Polytra Dar', 'Access Dar']
                };
                
                options[field].forEach(optionText => {
                    const option = document.createElement('option');
                    option.value = optionText;
                    option.textContent = optionText;
                    if (optionText === currentValue) option.selected = true;
                    input.appendChild(option);
                });
            } else {
                input = document.createElement('input');
                input.type = 'text';
                input.className = 'edit-input';
                input.value = currentValue;
            }
            
            // Replace cell content with input
            cell.innerHTML = '';
            cell.appendChild(input);
            cell.classList.add('editing');
            
            // Focus input
            input.focus();
            
            // Set editing context
            editingCell = {
                cell: cell,
                field: field,
                rowIndex: rowIndex,
                originalValue: currentValue
            };
            
            // Add save on Enter, cancel on Escape
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    saveEditing();
                } else if (e.key === 'Escape') {
                    cancelEditing();
                }
            });
            
            // Save on blur
            input.addEventListener('blur', function() {
                setTimeout(saveEditing, 100);
            });
        }

        function saveEditing() {
            if (!editingCell) return;
            
            const cell = editingCell.cell;
            const input = cell.querySelector('input, select');
            const newValue = input ? input.value : '';
            
            // Update cell content
            cell.textContent = newValue;
            cell.classList.remove('editing');
            
            // Update data array based on which table we're in
            const table = cell.closest('table');
            const tableId = table ? table.id : '';
            
            if (tableId.includes('incidents')) {
                // Update incidents array
                incidents[editingCell.rowIndex][editingCell.field] = newValue;
                localStorage.setItem('mmsIncidents', JSON.stringify(incidents));
                updateStatistics();
            }
            
            // Clear editing context
            editingCell = null;
        }

        function cancelEditing() {
            if (!editingCell) return;
            
            const cell = editingCell.cell;
            cell.textContent = editingCell.originalValue;
            cell.classList.remove('editing');
            editingCell = null;
        }

        function deleteIncident(id) {
            if (confirm('Are you sure you want to delete this incident?')) {
                incidents = incidents.filter(i => i.id !== id);
                localStorage.setItem('mmsIncidents', JSON.stringify(incidents));
                loadIncidentsTable();
                updateStatistics();
                showToast('Incident deleted', 'success');
            }
        }

        function deletePPEItem(id) {
            if (confirm('Are you sure you want to delete this PPE item?')) {
                ppeItems = ppeItems.filter(p => p.id !== id);
                localStorage.setItem('mmsPPEItems', JSON.stringify(ppeItems));
                loadPPETable();
                showToast('PPE item deleted', 'success');
            }
        }

        function deleteHealthRecord(id) {
            if (confirm('Are you sure you want to delete this health record?')) {
                healthRecords = healthRecords.filter(h => h.id !== id);
                localStorage.setItem('mmsHealthRecords', JSON.stringify(healthRecords));
                loadHealthTable();
                showToast('Health record deleted', 'success');
            }
        }

        function deleteContractor(id) {
            if (confirm('Are you sure you want to delete this contractor?')) {
                contractors = contractors.filter(c => c.id !== id);
                localStorage.setItem('mmsContractors', JSON.stringify(contractors));
                loadContractorTable();
                showToast('Contractor deleted', 'success');
            }
        }

        function deleteAudit(id) {
            if (confirm('Are you sure you want to delete this audit?')) {
                audits = audits.filter(a => a.id !== id);
                localStorage.setItem('mmsAudits', JSON.stringify(audits));
                loadAuditTable();
                updateStatistics();
                showToast('Audit deleted', 'success');
            }
        }

        function deleteTraining(id) {
            if (confirm('Are you sure you want to delete this training record?')) {
                trainingRecords = trainingRecords.filter(t => t.id !== id);
                localStorage.setItem('mmsTraining', JSON.stringify(trainingRecords));
                loadTrainingTable();
                updateStatistics();
                showToast('Training record deleted', 'success');
            }
        }

        function deleteStandard(id) {
            if (confirm('Are you sure you want to delete this standard?')) {
                standards = standards.filter(s => s.id !== id);
                localStorage.setItem('mmsStandards', JSON.stringify(standards));
                loadStandards();
                updateStatistics();
                showToast('Standard deleted', 'success');
            }
        }

        function addPPEItem() {
            const newItem = {
                id: `PPE-${Date.now().toString().slice(-6)}`,
                type: 'New PPE Item',
                size: 'M',
                brand: 'Brand',
                quantity: 1,
                location: 'Cape Town HQ',
                status: 'Available',
                lastInspection: new Date().toISOString().split('T')[0],
                nextInspection: new Date(Date.now() + 90 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                condition: 'New'
            };
            
            ppeItems.push(newItem);
            localStorage.setItem('mmsPPEItems', JSON.stringify(ppeItems));
            loadPPETable();
            showToast('PPE item added', 'success');
        }

        function addHealthRecord() {
            const newRecord = {
                id: `EMP-${Date.now().toString().slice(-6)}`,
                name: 'New Employee',
                location: 'Cape Town HQ',
                position: 'Position',
                lastMedical: new Date().toISOString().split('T')[0],
                nextDue: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                bloodGroup: 'Unknown',
                allergies: 'None',
                medicalStatus: 'Pending',
                emergencyContact: 'N/A'
            };
            
            healthRecords.push(newRecord);
            localStorage.setItem('mmsHealthRecords', JSON.stringify(healthRecords));
            loadHealthTable();
            populateEmployeeSelects();
            showToast('Health record added', 'success');
        }

        function addContractor() {
            const newContractor = {
                id: `CON-${Date.now().toString().slice(-6)}`,
                company: 'New Contractor',
                contactPerson: 'Contact Person',
                phone: '000-000-0000',
                email: 'contact@contractor.com',
                workType: 'General',
                location: 'Cape Town HQ',
                startDate: new Date().toISOString().split('T')[0],
                endDate: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                safetyRating: 'B',
                status: 'Active'
            };
            
            contractors.push(newContractor);
            localStorage.setItem('mmsContractors', JSON.stringify(contractors));
            loadContractorTable();
            showToast('Contractor added', 'success');
        }

        function addAudit() {
            const newAudit = {
                id: `AUD-${Date.now().toString().slice(-6)}`,
                type: 'Monthly Safety Audit',
                location: 'Cape Town HQ',
                auditDate: new Date().toISOString().split('T')[0],
                auditor: 'Safety Officer',
                score: 0,
                status: 'Scheduled',
                findings: 'Pending',
                correctiveActions: 'Pending',
                nextAudit: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
            };
            
            audits.push(newAudit);
            localStorage.setItem('mmsAudits', JSON.stringify(audits));
            loadAuditTable();
            updateStatistics();
            showToast('Audit added', 'success');
        }

        function addTrainingRecord() {
            const newTraining = {
                id: `TRN-${Date.now().toString().slice(-6)}`,
                employee: 'New Employee',
                type: 'Safety Induction',
                provider: 'MMS Safety',
                startDate: new Date().toISOString().split('T')[0],
                endDate: new Date().toISOString().split('T')[0],
                status: 'Scheduled',
                score: 0,
                expiryDate: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                notes: 'New training record'
            };
            
            trainingRecords.push(newTraining);
            localStorage.setItem('mmsTraining', JSON.stringify(trainingRecords));
            loadTrainingTable();
            updateStatistics();
            showToast('Training record added', 'success');
        }

        function addStandard() {
            openModal('standardModal');
            document.getElementById('standardModalTitle').textContent = 'Add New Standard';
            document.getElementById('deleteStandardBtn').style.display = 'none';
            
            // Clear form
            document.getElementById('standardName').value = '';
            document.getElementById('standardCode').value = '';
            document.getElementById('standardType').value = '';
            document.getElementById('standardCountry').value = '';
            document.getElementById('standardDescription').value = '';
            document.getElementById('standardStatus').value = '';
            document.getElementById('standardEffectiveDate').value = '';
            document.getElementById('standardRemarks').value = '';
        }

        function editStandard(id) {
            const standard = standards.find(s => s.id === id);
            if (!standard) return;
            
            editingStandardIndex = standards.findIndex(s => s.id === id);
            
            openModal('standardModal');
            document.getElementById('standardModalTitle').textContent = 'Edit Standard';
            document.getElementById('deleteStandardBtn').style.display = 'inline-block';
            
            // Fill form
            document.getElementById('standardName').value = standard.name;
            document.getElementById('standardCode').value = standard.code;
            document.getElementById('standardType').value = standard.type;
            document.getElementById('standardCountry').value = standard.country || '';
            document.getElementById('standardDescription').value = standard.description;
            document.getElementById('standardStatus').value = standard.status;
            document.getElementById('standardEffectiveDate').value = standard.effectiveDate || '';
            document.getElementById('standardRemarks').value = standard.remarks || '';
            
            // Show/hide country field
            toggleCountryField();
        }

        function saveStandard() {
            const name = document.getElementById('standardName').value;
            const code = document.getElementById('standardCode').value;
            const type = document.getElementById('standardType').value;
            const country = document.getElementById('standardCountry').value;
            const description = document.getElementById('standardDescription').value;
            const status = document.getElementById('standardStatus').value;
            const effectiveDate = document.getElementById('standardEffectiveDate').value;
            const remarks = document.getElementById('standardRemarks').value;
            
            if (!name || !code || !type || !description || !status) {
                document.getElementById('standardError').style.display = 'block';
                return;
            }
            
            const standardData = {
                id: editingStandardIndex >= 0 ? standards[editingStandardIndex].id : `STD-${Date.now().toString().slice(-6)}`,
                name: name,
                code: code,
                type: type,
                description: description,
                status: status,
                effectiveDate: effectiveDate,
                remarks: remarks
            };
            
            // Add country only for national standards
            if (type === 'National' && country) {
                standardData.country = country;
            }
            
            if (editingStandardIndex >= 0) {
                // Update existing standard
                standards[editingStandardIndex] = standardData;
            } else {
                // Add new standard
                standards.push(standardData);
            }
            
            // Save to localStorage
            localStorage.setItem('mmsStandards', JSON.stringify(standards));
            
            // Show success message
            document.getElementById('standardSuccess').style.display = 'block';
            document.getElementById('standardError').style.display = 'none';
            
            // Refresh and close
            setTimeout(() => {
                closeModal('standardModal');
                loadStandards();
                updateStatistics();
                editingStandardIndex = -1;
            }, 2000);
        }

        function deleteCurrentStandard() {
            if (editingStandardIndex >= 0) {
                if (confirm('Are you sure you want to delete this standard?')) {
                    standards.splice(editingStandardIndex, 1);
                    localStorage.setItem('mmsStandards', JSON.stringify(standards));
                    closeModal('standardModal');
                    loadStandards();
                    updateStatistics();
                    editingStandardIndex = -1;
                    showToast('Standard deleted', 'success');
                }
            }
        }

        function toggleCountryField() {
            const type = document.getElementById('standardType').value;
            const countryField = document.getElementById('countryField');
            
            if (type === 'National') {
                countryField.style.display = 'block';
            } else {
                countryField.style.display = 'none';
            }
        }

        function editRiskCell(cell) {
            const currentText = cell.textContent.trim();
            const level = parseInt(currentText.split('\n')[0]);
            
            const newRisk = prompt('Enter new risk description:', currentText);
            if (newRisk !== null) {
                cell.innerHTML = `
                    <div style="font-size: 1.25rem; margin-bottom: 0.5rem;">${level}</div>
                    <div>${newRisk}</div>
                    <div style="font-size: 0.75rem; margin-top: 0.5rem; opacity: 0.8;">Click to edit</div>
                `;
                showToast('Risk cell updated', 'success');
            }
        }

        function saveRiskMatrix() {
            // In a real app, this would save to server
            showToast('Risk matrix saved successfully!', 'success');
        }

        function loadSettings() {
            // Load saved settings or use defaults
            const savedSettings = localStorage.getItem('mmsSettings');
            settings = savedSettings ? JSON.parse(savedSettings) : {
                companyName: 'Metal Management Solutions',
                companyWebsite: 'https://www.metalmanagementsolutions.com/',
                companyEmail: '',
                companyPhone: '',
                emailNotifications: true,
                incidentAlerts: true,
                trainingReminders: true,
                auditReminders: true,
                notificationEmail: '',
                backupFrequency: 'weekly',
                autoExport: 'monthly'
            };
            
            // Apply settings to form
            document.getElementById('companyName').value = settings.companyName || '';
            document.getElementById('companyWebsite').value = settings.companyWebsite || '';
            document.getElementById('companyEmail').value = settings.companyEmail || '';
            document.getElementById('companyPhone').value = settings.companyPhone || '';
            document.getElementById('emailNotifications').checked = settings.emailNotifications || false;
            document.getElementById('incidentAlerts').checked = settings.incidentAlerts || false;
            document.getElementById('trainingReminders').checked = settings.trainingReminders || false;
            document.getElementById('auditReminders').checked = settings.auditReminders || false;
            document.getElementById('notificationEmail').value = settings.notificationEmail || '';
            document.getElementById('backupFrequency').value = settings.backupFrequency || 'weekly';
            document.getElementById('autoExport').value = settings.autoExport || 'monthly';
            
            // Load locations
            loadLocationsList();
        }

        function loadLocationsList() {
            const locationsList = document.getElementById('locationsList');
            if (!locationsList) return;
            
            locationsList.innerHTML = '';
            
            locations.forEach(location => {
                const locationItem = document.createElement('div');
                locationItem.className = 'file-item';
                locationItem.innerHTML = `
                    <div>
                        <strong>${location.name}</strong>
                        <div style="font-size: 0.85rem; color: var(--text-light);">${location.country}</div>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="removeLocation('${location.name}')">Remove</button>
                `;
                locationsList.appendChild(locationItem);
            });
        }

        function addLocation() {
            const name = document.getElementById('newLocationName').value;
            const country = document.getElementById('newLocationCountry').value;
            
            if (!name || !country) {
                alert('Please enter both location name and country');
                return;
            }
            
            locations.push({ name: name, country: country });
            loadLocationsList();
            
            // Clear inputs
            document.getElementById('newLocationName').value = '';
            document.getElementById('newLocationCountry').value = '';
            
            showToast('Location added', 'success');
        }

        function removeLocation(locationName) {
            if (confirm(`Are you sure you want to remove ${locationName}?`)) {
                locations = locations.filter(l => l.name !== locationName);
                loadLocationsList();
                showToast('Location removed', 'success');
            }
        }

        function saveSettings() {
            // Gather settings from form
            settings = {
                companyName: document.getElementById('companyName').value,
                companyWebsite: document.getElementById('companyWebsite').value,
                companyEmail: document.getElementById('companyEmail').value,
                companyPhone: document.getElementById('companyPhone').value,
                emailNotifications: document.getElementById('emailNotifications').checked,
                incidentAlerts: document.getElementById('incidentAlerts').checked,
                trainingReminders: document.getElementById('trainingReminders').checked,
                auditReminders: document.getElementById('auditReminders').checked,
                notificationEmail: document.getElementById('notificationEmail').value,
                backupFrequency: document.getElementById('backupFrequency').value,
                autoExport: document.getElementById('autoExport').value
            };
            
            // Save to localStorage
            localStorage.setItem('mmsSettings', JSON.stringify(settings));
            
            showToast('Settings saved successfully!', 'success');
            
            // Close modal after delay
            setTimeout(() => {
                closeModal('settingsModal');
            }, 1500);
        }

        function backupData() {
            // Create backup object
            const backup = {
                timestamp: new Date().toISOString(),
                incidents: incidents,
                ppeItems: ppeItems,
                healthRecords: healthRecords,
                contractors: contractors,
                audits: audits,
                standards: standards,
                trainingRecords: trainingRecords
            };
            
            // Convert to JSON
            const backupJSON = JSON.stringify(backup, null, 2);
            
            // Create download link
            const blob = new Blob([backupJSON], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mms-safety-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('Backup created successfully!', 'success');
        }

        function exportAllData() {
            // Combine all data
            const allData = {
                incidents: incidents,
                ppeItems: ppeItems,
                healthRecords: healthRecords,
                contractors: contractors,
                audits: audits,
                standards: standards,
                trainingRecords: trainingRecords
            };
            
            // Create Excel workbook
            const wb = XLSX.utils.book_new();
            
            // Add each sheet
            Object.keys(allData).forEach(key => {
                if (allData[key].length > 0) {
                    const ws = XLSX.utils.json_to_sheet(allData[key]);
                    XLSX.utils.book_append_sheet(wb, ws, key);
                }
            });
            
            // Generate filename
            const filename = `mms-safety-export-${new Date().toISOString().split('T')[0]}.xlsx`;
            
            // Download
            XLSX.writeFile(wb, filename);
            
            showToast('All data exported to Excel!', 'success');
        }

        function exportToPDF() {
            // Simple PDF export of dashboard
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(20);
            doc.text('MMS Safety Dashboard Report', 20, 20);
            doc.setFontSize(12);
            doc.text(`Generated: ${new Date().toLocaleDateString()}`, 20, 30);
            
            // Add some stats
            doc.setFontSize(14);
            doc.text('Current Statistics', 20, 45);
            doc.setFontSize(10);
            doc.text(`Total Incidents: ${incidents.length}`, 20, 55);
            doc.text(`Training Records: ${trainingRecords.length}`, 20, 62);
            doc.text(`PPE Items: ${ppeItems.length}`, 20, 69);
            doc.text(`Compliance Rate: ${document.getElementById('complianceRate')?.textContent || '0%'}`, 20, 76);
            
            doc.save(`mms-safety-dashboard-${new Date().toISOString().split('T')[0]}.pdf`);
            showToast('Dashboard exported to PDF', 'success');
        }

        function resetData() {
            if (confirm('‚ö†Ô∏è WARNING: This will reset ALL data in the system. This action cannot be undone. Are you sure?')) {
                // Clear all localStorage data
                localStorage.clear();
                
                // Reload page
                location.reload();
            }
        }

        function showToast(title, message, type = 'success') {
            const toast = document.getElementById('toast');
            if (!toast) return;
            
            // Set content
            toast.querySelector('.toast-title').textContent = title;
            toast.querySelector('.toast-message').textContent = message;
            
            // Set type
            toast.className = 'toast';
            toast.classList.add(`toast-${type}`);
            
            // Set icon
            const icon = toast.querySelector('.toast-icon');
            if (type === 'success') {
                icon.textContent = '‚úÖ';
            } else if (type === 'error') {
                icon.textContent = '‚ùå';
            } else if (type === 'warning') {
                icon.textContent = '‚ö†Ô∏è';
            }
            
            // Show toast
            toast.classList.add('show');
            
            // Auto-hide after 5 seconds
            setTimeout(hideToast, 5000);
        }

        function hideToast() {
            const toast = document.getElementById('toast');
            if (toast) {
                toast.classList.remove('show');
            }
        }

        function hideConfirmDialog() {
            document.getElementById('confirmDialog').classList.remove('show');
        }

        function showConfirmDialog(title, message, onConfirm) {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            
            const confirmBtn = document.getElementById('confirmDeleteBtn');
            confirmBtn.onclick = function() {
                onConfirm();
                hideConfirmDialog();
            };
            
            document.getElementById('confirmDialog').classList.add('show');
        }

        function changeChartType(type) {
            currentChartType = type;
            
            // Update button states
            document.querySelectorAll('.chart-type-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Reinitialize chart
            initializeCharts();
        }

        function updateChartWithCustomRange() {
            // In a real app, this would fetch data for the selected date range
            console.log('Updating chart with custom range');
            initializeCharts();
        }

        // ==================== INITIALIZATION ====================

        window.addEventListener('load', function() {
            // Double-check module initialization
            setTimeout(() => {
                if (!window.emergencyWizard && typeof EmergencyWizard !== 'undefined') {
                    window.emergencyWizard = new EmergencyWizard();
                }
                if (!window.safetyChecklist && typeof SafetyChecklistSystem !== 'undefined') {
                    window.safetyChecklist = new SafetyChecklistSystem();
                }
                if (!window.riskCalculator && typeof RiskCalculator !== 'undefined') {
                    window.riskCalculator = new RiskCalculator();
                }
                if (!window.equipmentInspections && typeof EquipmentInspections !== 'undefined') {
                    window.equipmentInspections = new EquipmentInspections();
                }
                if (!window.chemicalRegister && typeof ChemicalRegister !== 'undefined') {
                    window.chemicalRegister = new ChemicalRegister();
                }
                if (!window.incidentInvestigator && typeof IncidentInvestigator !== 'undefined') {
                    window.incidentInvestigator = new IncidentInvestigator();
                }
                if (!window.safetyObservations && typeof SafetyObservations !== 'undefined') {
                    window.safetyObservations = new SafetyObservations();
                }
                if (!window.safetyReports && typeof SafetyReportingDashboard !== 'undefined') {
                    window.safetyReports = new SafetyReportingDashboard();
                }
            }, 2000);
        });

        console.log('‚úÖ MMS Safety System Initialized');
    </script>

    <!-- PWA Debug Panel (Remove in production) -->
    <div id="pwa-debug" style="display: none; position: fixed; bottom: 10px; right: 10px; background: white; border: 1px solid #ccc; padding: 10px; z-index: 9999; border-radius: 5px;">
        <button onclick="toggleDebug()">Toggle PWA Debug</button>
        <div id="debug-info"></div>
    </div>

    <script>
        // Debug function
        function toggleDebug() {
            const debug = document.getElementById('pwa-debug');
            debug.style.display = debug.style.display === 'none' ? 'block' : 'none';
            
            if (debug.style.display === 'block') {
                const info = {
                    url: window.location.href,
                    https: window.location.protocol === 'https:',
                    manifest: !!document.querySelector('link[rel="manifest"]'),
                    serviceWorker: 'serviceWorker' in navigator,
                    beforeInstallPrompt: 'BeforeInstallPromptEvent' in window,
                    displayMode: window.matchMedia('(display-mode: standalone)').matches ? 'standalone' : 'browser',
                    userAgent: navigator.userAgent
                };
                
                document.getElementById('debug-info').innerHTML = `
                    <h4>PWA Debug Info</h4>
                    <pre>${JSON.stringify(info, null, 2)}</pre>
                    <button onclick="checkPWA()">Check PWA Status</button>
                    <button onclick="testInstall()">Test Install</button>
                `;
            }
        }

        function checkPWA() {
            if (window.debugPWA) {
                const pwaInfo = window.debugPWA();
                alert(JSON.stringify(pwaInfo, null, 2));
            } else {
                alert('PWA Installer not loaded');
            }
        }

        function testInstall() {
            if (window.pwaInstaller) {
                window.pwaInstaller.installPWA();
            } else {
                alert('PWA Installer not available');
            }
        }

        // Auto-check PWA status
        setTimeout(() => {
            if (window.pwaInstaller) {
                const status = window.pwaInstaller.checkPWARequirements();
                console.log('PWA Status Check:', status);
            }
        }, 3000);
    </script>
</body>
</html>
