<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health & Safety - MMS ERP</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary: #dc2626;
            --primary-dark: #b91c1c;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --background: #f8fafc;
            --surface: #ffffff;
            --text: #1e293b;
            --text-light: #64748b;
            --border: #e2e8f0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--background);
            color: var(--text);
            line-height: 1.6;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 280px 1fr;
            min-height: 100vh;
        }

        .sidebar {
            background: var(--surface);
            border-right: 1px solid var(--border);
            padding: 2rem 1rem;
            position: fixed;
            width: 280px;
            height: 100vh;
            overflow-y: auto;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 2rem;
            padding: 0 1rem;
            text-decoration: none;
            color: inherit;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: var(--primary);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.25rem;
        }

        .nav-section {
            margin-bottom: 2rem;
        }

        .nav-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--text-light);
            margin-bottom: 1rem;
            padding: 0 1rem;
            letter-spacing: 0.5px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            color: var(--text-light);
            text-decoration: none;
            transition: all 0.2s;
            margin-bottom: 0.25rem;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
            font-size: 0.95rem;
        }

        .nav-item:hover, .nav-item.active {
            background: var(--primary);
            color: white;
        }

        .nav-icon {
            font-size: 1.25rem;
            width: 24px;
            text-align: center;
        }

        .main-content {
            grid-column: 2;
            padding: 2rem;
            margin-left: 280px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .header h1 {
            font-size: 1.875rem;
            font-weight: 700;
        }

        /* Enhanced Statistics Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--surface) 0%, #f8fafc 100%);
            padding: 1.5rem;
            border-radius: 16px;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border-color: var(--primary);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), #ef4444);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 0.5rem;
            position: relative;
        }

        .stat-label {
            color: var(--text-light);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .stat-details {
            margin-top: 1rem;
            font-size: 0.85rem;
            color: var(--text-light);
            display: none;
            border-top: 1px solid var(--border);
            padding-top: 1rem;
        }

        .stat-card:hover .stat-details {
            display: block;
        }

        /* Enhanced Chart Container */
        .chart-container {
            background: var(--surface);
            padding: 1.25rem;
            border-radius: 16px;
            border: 1px solid var(--border);
            margin-bottom: 2rem;
            height: 450px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .chart-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .chart-subtitle {
            color: var(--text-light);
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        .chart-controls {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .chart-type-selector {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .chart-type-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--background);
            color: var(--text);
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .chart-type-btn:hover {
            border-color: var(--primary);
            background: var(--surface);
        }

        .chart-type-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .custom-calendar {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .date-input {
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--surface);
            font-family: inherit;
            font-size: 0.875rem;
        }

        .date-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
        }

        /* Enhanced Risk Assessment Matrix */
        .risk-matrix {
            background: linear-gradient(135deg, var(--surface) 0%, #f8fafc 100%);
            border-radius: 16px;
            border: 1px solid var(--border);
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .matrix-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .matrix-cell {
            padding: 1.5rem 1rem;
            border-radius: 12px;
            text-align: center;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            border: 2px solid transparent;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .matrix-cell:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }

        .risk-low { 
            background: linear-gradient(135deg, #dcfce7, #bbf7d0);
            color: #166534; 
            border-color: #86efac;
        }
        .risk-medium { 
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            color: #92400e; 
            border-color: #fcd34d;
        }
        .risk-high { 
            background: linear-gradient(135deg, #fed7aa, #fdba74);
            color: #9a3412; 
            border-color: #fb923c;
        }
        .risk-very-high { 
            background: linear-gradient(135deg, #fecaca, #fca5a5);
            color: #991b1b; 
            border-color: #f87171;
        }
        .risk-extreme { 
            background: linear-gradient(135deg, #fca5a5, #f87171);
            color: #7f1d1d; 
            border-color: #ef4444;
        }

        /* Enhanced Tables with Full Edit */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .data-table th,
        .data-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .data-table th {
            background: var(--background);
            font-weight: 600;
            color: var(--text);
            position: sticky;
            top: 0;
        }

        .data-table tbody tr:hover {
            background: var(--background);
        }

        .data-table td.editable {
            cursor: pointer;
            position: relative;
            transition: background-color 0.2s;
        }

        .data-table td.editable:hover {
            background: rgba(220, 38, 38, 0.05);
        }

        .data-table td.editing {
            background: rgba(220, 38, 38, 0.1);
            border: 1px solid var(--primary);
            border-radius: 4px;
            padding: 0.5rem;
        }

        .edit-input {
            width: 100%;
            padding: 0.5rem;
            border: 2px solid var(--primary);
            border-radius: 6px;
            font-family: inherit;
            font-size: inherit;
            background: var(--surface);
            color: var(--text);
            outline: none;
        }

        .edit-input:focus {
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
        }

        .edit-select {
            width: 100%;
            padding: 0.5rem;
            border: 2px solid var(--primary);
            border-radius: 6px;
            font-family: inherit;
            font-size: inherit;
            background: var(--surface);
            color: var(--text);
            outline: none;
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.2);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
        }

        .btn-outline:hover {
            background: var(--background);
            border-color: var(--primary);
            color: var(--primary);
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2);
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            z-index: 1000;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast-success {
            border-left: 4px solid var(--success);
        }

        .toast-error {
            border-left: 4px solid var(--error);
        }

        .toast-warning {
            border-left: 4px solid var(--warning);
        }

        .toast-icon {
            font-size: 1.25rem;
        }

        .toast-success .toast-icon { color: var(--success); }
        .toast-error .toast-icon { color: var(--error); }
        .toast-warning .toast-icon { color: var(--warning); }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .toast-message {
            font-size: 0.875rem;
            color: var(--text-light);
        }

        .close-toast {
            background: none;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            font-size: 1.25rem;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-toast:hover {
            color: var(--text);
        }

        /* Confirm Dialog */
        .confirm-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .confirm-dialog.show {
            display: flex;
        }

        .confirm-content {
            background: var(--surface);
            border-radius: 12px;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .confirm-icon {
            font-size: 3rem;
            text-align: center;
            margin-bottom: 1rem;
            color: var(--error);
        }

        .confirm-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .confirm-message {
            color: var(--text-light);
            text-align: center;
            margin-bottom: 2rem;
        }

        .confirm-buttons {
            display: flex;
            gap: 1rem;
        }

        .confirm-buttons .btn {
            flex: 1;
        }

        /* Module Grid */
        .module-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .module-card {
            background: var(--surface);
            padding: 2rem;
            border-radius: 12px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            color: inherit;
            display: block;
        }

        .module-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border-color: var(--primary);
        }

        .module-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.75rem;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, var(--primary), #ef4444);
            color: white;
        }

        .module-card h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .module-card p {
            color: var(--text-light);
            font-size: 0.95rem;
        }

        /* Chart Canvas Container */
        .chart-canvas-container {
            flex: 1;
            min-height: 0;
            position: relative;
            background: var(--background);
            border-radius: 8px;
            overflow: hidden;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal-content {
            background: var(--surface);
            margin: 2% auto;
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 900px;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }

        .close-modal {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--background);
            font-family: inherit;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .action-buttons .btn {
            flex: 1;
        }

        .success-message {
            background: #dcfce7;
            color: #166534;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            display: none;
        }

        .error-message {
            background: #fecaca;
            color: #991b1b;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            display: none;
        }

        .modal-header {
            margin-bottom: 2rem;
        }

        .modal-header h2 {
            margin-right: 2rem;
        }

        .file-upload-area {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 1rem;
        }

        .file-upload-area:hover {
            border-color: var(--primary);
            background: var(--background);
        }

        .file-list {
            margin-top: 1rem;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            margin-bottom: 0.5rem;
            background: var(--background);
        }

        /* Standards Cards Grid */
        .standards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .standard-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            position: relative;
        }

        .standard-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            border-color: var(--primary);
        }

        .standard-badge {
            position: absolute;
            top: 1rem;
            right: 1rem;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-international {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        .badge-national {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #86efac;
        }

        .standard-card h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--primary);
        }

        .standard-code {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-bottom: 0.5rem;
            font-family: monospace;
        }

        .standard-industry {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background: var(--background);
            border-radius: 4px;
            font-size: 0.75rem;
            margin-bottom: 1rem;
        }

        .standard-status {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-bottom: 1rem;
        }

        .status-compliant {
            background: #dcfce7;
            color: #166534;
        }

        .status-noncompliant {
            background: #fecaca;
            color: #991b1b;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-inprogress {
            background: #dbeafe;
            color: #1e40af;
        }

        .standard-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        /* Tab Container */
        .tab-container {
            margin-bottom: 2rem;
        }

        .tab-buttons {
            display: flex;
            border-bottom: 1px solid var(--border);
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            overflow-x: auto;
        }

        .tab-button {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-light);
            white-space: nowrap;
        }

        .tab-button.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 2rem;
            margin-top: 3rem;
            color: var(--text-light);
            border-top: 1px solid var(--border);
            font-size: 0.9rem;
            line-height: 1.6;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            .sidebar {
                transform: translateX(-100%);
            }
            .main-content {
                margin-left: 0;
                grid-column: 1;
            }
            .matrix-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            .form-row {
                grid-template-columns: 1fr;
            }
            .standards-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 1rem;
            }
            .header {
                flex-direction: column;
            }
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .matrix-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .chart-header {
                flex-direction: column;
                align-items: flex-start;
            }
            .chart-controls {
                width: 100%;
                flex-wrap: wrap;
            }
            .chart-container {
                height: 400px;
            }
            .module-grid {
                grid-template-columns: 1fr;
            }
            .standards-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            .matrix-grid {
                grid-template-columns: 1fr;
            }
            .chart-container {
                height: 350px;
            }
            .action-buttons {
                flex-direction: column;
            }
            .action-buttons .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <nav class="sidebar">
            <div class="logo">
                <div class="logo-icon">MMS</div>
                <div>
                    <div style="font-weight: 700; font-size: 1.25rem;">Metal Management</div>
                    <div style="font-size: 0.875rem; color: var(--text-light);">Health & Safety System</div>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-title">Navigation</div>
                <a href="#" class="nav-item" onclick="showDashboard()">
                    <span class="nav-icon">üè†</span>
                    Home Dashboard
                </a>
                <a href="#" class="nav-item active">
                    <span class="nav-icon">üõ°Ô∏è</span>
                    Health & Safety
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-title">Safety Management</div>
                <button class="nav-item" onclick="openModal('incidentsModal')">
                    <span class="nav-icon">üö®</span>
                    Incident Management
                </button>
                <button class="nav-item" onclick="openModal('riskModal')">
                    <span class="nav-icon">üìä</span>
                    Risk Assessment
                </button>
                <button class="nav-item" onclick="openModal('trainingModal')">
                    <span class="nav-icon">üéì</span>
                    Safety Training
                </button>
                <button class="nav-item" onclick="openModal('ppeModal')">
                    <span class="nav-icon">ü•Ω</span>
                    PPE Management
                </button>
            </div>

            <div class="nav-section">
                <div class="nav-title">Compliance</div>
                <button class="nav-item" onclick="openModal('standardsModal')">
                    <span class="nav-icon">üìã</span>
                    Standards & Compliance
                </button>
                <button class="nav-item" onclick="openModal('auditModal')">
                    <span class="nav-icon">üîç</span>
                    Audit & Inspection
                </button>
                <button class="nav-item" onclick="openModal('contractorModal')">
                    <span class="nav-icon">üë∑</span>
                    Contractor Safety
                </button>
            </div>

            <div class="nav-section">
                <div class="nav-title">Employee Management</div>
                <button class="nav-item" onclick="openModal('healthModal')">
                    <span class="nav-icon">üë•</span>
                    Employee Health
                </button>
                <button class="nav-item" onclick="openModal('settingsModal')">
                    <span class="nav-icon">‚öôÔ∏è</span>
                    System Settings
                </button>
            </div>
        </nav>

        <main class="main-content">
            <div class="header">
                <div>
                    <h1>Occupational Health & Safety Management</h1>
                    <div style="color: var(--text-light); margin-top: 0.5rem;">
                        Metal Management Solutions - Comprehensive OHS compliance across all operations
                    </div>
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn btn-outline" onclick="exportToPDF()">
                        üìÑ Export PDF
                    </button>
                    <button class="btn btn-primary" onclick="openModal('reportIncidentModal')">
                        üö® Report Incident
                    </button>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="stats-grid">
                <div class="stat-card" onclick="openModal('incidentsModal')">
                    <div class="stat-number" id="lostTimeInjuries">0</div>
                    <div class="stat-label">Lost Time Injuries</div>
                    <div class="stat-details" id="ltiDetails">
                        Last 30 days: 0 incidents
                    </div>
                </div>
                <div class="stat-card" onclick="openModal('trainingModal')">
                    <div class="stat-number" id="safetyTrainings">156</div>
                    <div class="stat-label">Safety Trainings</div>
                    <div class="stat-details" id="trainingDetails">
                        45 completed, 12 in progress
                    </div>
                </div>
                <div class="stat-card" onclick="openModal('standardsModal')">
                    <div class="stat-number" id="complianceRate">92%</div>
                    <div class="stat-label">Compliance Rate</div>
                    <div class="stat-details">
                        Based on 28 standards and regulations
                    </div>
                </div>
                <div class="stat-card" onclick="openModal('auditModal')">
                    <div class="stat-number" id="activeAudits">8</div>
                    <div class="stat-label">Active Audits</div>
                    <div class="stat-details">
                        4 internal, 2 external, 2 regulatory
                    </div>
                </div>
            </div>

            <!-- Incident Trends Chart -->
            <div class="chart-container">
                <div class="chart-header">
                    <div>
                        <div class="chart-title">Safety Performance Trends</div>
                        <div class="chart-subtitle">Incident monitoring across all MMS locations</div>
                    </div>
                    <div class="chart-controls">
                        <div class="chart-type-selector">
                            <button class="chart-type-btn active" onclick="changeChartType('line')">üìà Line</button>
                            <button class="chart-type-btn" onclick="changeChartType('bar')">üìä Bar</button>
                            <button class="chart-type-btn" onclick="changeChartType('pie')">ü•ß Pie</button>
                        </div>
                        <div class="custom-calendar">
                            <input type="date" id="startDate" class="date-input" onchange="updateChartWithCustomRange()">
                            <span>to</span>
                            <input type="date" id="endDate" class="date-input" onchange="updateChartWithCustomRange()">
                        </div>
                    </div>
                </div>
                <div class="chart-canvas-container">
                    <canvas id="incidentTrendChart"></canvas>
                </div>
            </div>

            <!-- Risk Assessment Matrix -->
            <div class="risk-matrix">
                <div class="chart-header">
                    <div>
                        <div class="chart-title">Risk Assessment Matrix</div>
                        <div class="chart-subtitle">Current workplace risk assessment status</div>
                    </div>
                    <div>
                        <button class="btn btn-success" onclick="saveRiskMatrix()">üíæ Save Matrix</button>
                    </div>
                </div>
                <div class="matrix-grid" id="riskMatrix">
                    <!-- Matrix cells will be loaded by JavaScript -->
                </div>
            </div>

            <!-- OHS Management Modules -->
            <div class="module-grid">
                <div class="module-card" onclick="openModal('incidentsModal')">
                    <div class="module-icon">üö®</div>
                    <h3>Incident Management</h3>
                    <p>Report, track, and investigate workplace incidents with full documentation</p>
                </div>

                <div class="module-card" onclick="openModal('ppeModal')">
                    <div class="module-icon">ü•Ω</div>
                    <h3>PPE Management</h3>
                    <p>Track personal protective equipment issuance, maintenance, and compliance</p>
                </div>

                <div class="module-card" onclick="openModal('healthModal')">
                    <div class="module-icon">üë•</div>
                    <h3>Employee Health</h3>
                    <p>Employee health monitoring, medical examinations, and wellness programs</p>
                </div>

                <div class="module-card" onclick="openModal('contractorModal')">
                    <div class="module-icon">üë∑</div>
                    <h3>Contractor Safety</h3>
                    <p>Manage contractor safety compliance, permits, and site-specific inductions</p>
                </div>

                <div class="module-card" onclick="openModal('auditModal')">
                    <div class="module-icon">üîç</div>
                    <h3>Audit & Inspection</h3>
                    <p>Schedule and conduct safety audits, inspections, and compliance verifications</p>
                </div>

                <div class="module-card" onclick="openModal('standardsModal')">
                    <div class="module-icon">üìã</div>
                    <h3>Standards Compliance</h3>
                    <p>Manage international and national safety standards compliance</p>
                </div>
            </div>

            <div class="footer">
                <div style="font-weight: 600; color: var(--primary); margin-bottom: 0.5rem;">
                    Metal Management Solutions
                </div>
                <div style="margin-bottom: 0.5rem;">
                    Health & Safety Management System
                </div>
                <div style="font-size: 0.85rem; color: var(--text-light);">
                    Copyright ¬© 2026 Metal Management Solutions. All rights reserved.
                </div>
                <div style="font-size: 0.85rem; color: var(--text-light); margin-top: 0.25rem;">
                    Operating in South Africa, Tanzania, Namibia, and Zambia
                </div>
            </div>
        </main>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <div class="toast-icon"></div>
        <div class="toast-content">
            <div class="toast-title"></div>
            <div class="toast-message"></div>
        </div>
        <button class="close-toast" onclick="hideToast()">√ó</button>
    </div>

    <!-- Confirm Dialog -->
    <div class="confirm-dialog" id="confirmDialog">
        <div class="confirm-content">
            <div class="confirm-icon">‚ö†Ô∏è</div>
            <div class="confirm-title" id="confirmTitle">Confirm Delete</div>
            <div class="confirm-message" id="confirmMessage">Are you sure you want to delete this item? This action cannot be undone.</div>
            <div class="confirm-buttons">
                <button class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
                <button class="btn btn-outline" onclick="hideConfirmDialog()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Report Incident Modal -->
    <div id="reportIncidentModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('reportIncidentModal')">√ó</button>
            <div class="modal-header">
                <h2>Report Safety Incident</h2>
            </div>
            
            <div class="success-message" id="reportSuccess">Incident reported successfully!</div>
            <div class="error-message" id="reportError">Please fill all required fields.</div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Incident Type *</label>
                    <select id="incidentType" required>
                        <option value="">Select type</option>
                        <option value="Near Miss">Near Miss</option>
                        <option value="First Aid">First Aid</option>
                        <option value="Medical Treatment">Medical Treatment</option>
                        <option value="Lost Time Injury">Lost Time Injury</option>
                        <option value="Property Damage">Property Damage</option>
                        <option value="Environmental Incident">Environmental Incident</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Severity Level *</label>
                    <select id="incidentSeverity" required>
                        <option value="">Select severity</option>
                        <option value="Minor">Minor</option>
                        <option value="Moderate">Moderate</option>
                        <option value="Serious">Serious</option>
                        <option value="Critical">Critical</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Date & Time *</label>
                    <input type="datetime-local" id="incidentDateTime" required>
                </div>
                <div class="form-group">
                    <label>Location *</label>
                    <select id="incidentLocation" required>
                        <option value="">Select location</option>
                        <optgroup label="South Africa">
                            <option value="Cape Town HQ">Cape Town HQ</option>
                            <option value="Cosco Durban">Cosco Durban</option>
                            <option value="AGL Durban">AGL Durban</option>
                        </optgroup>
                        <optgroup label="Tanzania">
                            <option value="Impala Dar">Impala Dar</option>
                            <option value="Polytra Dar">Polytra Dar</option>
                            <option value="Access Dar">Access Dar</option>
                        </optgroup>
                        <optgroup label="Namibia">
                            <option value="WBCT Bulk Shed">WBCT Bulk Shed</option>
                            <option value="WBCT Quay Side Shed">WBCT Quay Side Shed</option>
                            <option value="Bridge Walvis Bay">Bridge Walvis Bay</option>
                            <option value="Pindulo Walvis Bay">Pindulo Walvis Bay</option>
                        </optgroup>
                        <optgroup label="Zambia">
                            <option value="Reload Giga Terminal">Reload Giga Terminal</option>
                            <option value="AGL Chingola Hub">AGL Chingola Hub</option>
                            <option value="Polytra Kitwe">Polytra Kitwe</option>
                            <option value="Impala Ndola">Impala Ndola</option>
                            <option value="SLS Ndola">SLS Ndola</option>
                            <option value="Poseidon Zambia">Poseidon Zambia</option>
                            <option value="Polytra Kapiri Mposhi">Polytra Kapiri Mposhi</option>
                        </optgroup>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Reported By *</label>
                    <select id="reportedBy" required>
                        <option value="">Select employee</option>
                        <!-- Employees will be populated by JavaScript -->
                    </select>
                </div>
                <div class="form-group">
                    <label>Department *</label>
                    <select id="incidentDepartment" required>
                        <option value="">Select department</option>
                        <option value="Inventory Control">Inventory Control</option>
                        <option value="Operations">Operations</option>
                        <option value="Management">Management</option>
                        <option value="Contractor">Contractor</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label>Description *</label>
                <textarea id="incidentDescription" rows="4" placeholder="Provide detailed description" required></textarea>
            </div>
            
            <div class="form-group">
                <label>Immediate Actions Taken</label>
                <textarea id="immediateActions" rows="3" placeholder="Describe immediate response actions"></textarea>
            </div>
            
            <div class="form-group">
                <label>Attachments</label>
                <div class="file-upload-area" onclick="document.getElementById('incidentFileInput').click()">
                    <input type="file" id="incidentFileInput" style="display: none;" multiple>
                    <div style="font-size: 3rem;">üìé</div>
                    <div style="margin: 1rem 0;">Click to upload incident photos or documents</div>
                    <div style="color: var(--text-light); font-size: 0.875rem;">Supported: PDF, DOC, JPG, PNG (Max 10MB each)</div>
                </div>
                <div class="file-list" id="incidentFilesList"></div>
            </div>
            
            <div class="form-group">
                <label>Proposed Recommendations/Comments</label>
                <textarea id="recommendations" rows="3" placeholder="Enter recommendations or comments"></textarea>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="submitIncidentReport()">Submit Report</button>
                <button class="btn btn-outline" onclick="closeModal('reportIncidentModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Incident Management Modal -->
    <div id="incidentsModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('incidentsModal')">√ó</button>
            <div class="modal-header">
                <h2>Incident Management System</h2>
                <p>Click on any cell to edit, right-click for more options</p>
            </div>
            
            <div class="tab-container">
                <div class="tab-buttons">
                    <button class="tab-button active" onclick="switchTab('incidentsTab', 'incidentsModal')">All Incidents</button>
                    <button class="tab-button" onclick="switchTab('incidentsAnalysisTab', 'incidentsModal')">Analysis</button>
                    <button class="tab-button" onclick="switchTab('incidentsAttachmentsTab', 'incidentsModal')">Attachments</button>
                </div>
                
                <div class="tab-content active" id="incidentsTab">
                    <div style="overflow-x: auto; margin-top: 1rem;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Type</th>
                                    <th>Date</th>
                                    <th>Location</th>
                                    <th>Reported By</th>
                                    <th>Severity</th>
                                    <th>Status</th>
                                    <th>Description</th>
                                    <th>Actions</th>
                                    <th>Recommendations</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="modalIncidentsTableBody">
                                <!-- Incidents will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="tab-content" id="incidentsAnalysisTab">
                    <div style="margin-top: 1rem;">
                        <canvas id="incidentAnalysisChart" height="300"></canvas>
                    </div>
                </div>
                
                <div class="tab-content" id="incidentsAttachmentsTab">
                    <div class="form-group">
                        <label>Select Incident</label>
                        <select id="incidentSelect" onchange="loadIncidentAttachments()">
                            <option value="">Select incident</option>
                        </select>
                    </div>
                    
                    <div class="file-upload-area" onclick="document.getElementById('incidentModalFileInput').click()">
                        <input type="file" id="incidentModalFileInput" style="display: none;" multiple onchange="uploadIncidentAttachment()">
                        <div style="font-size: 3rem;">üìé</div>
                        <div style="margin: 1rem 0;">Click to upload incident documents</div>
                    </div>
                    
                    <div class="file-list" id="incidentAttachmentsList">
                        <!-- Attachments will be listed here -->
                    </div>
                </div>
            </div>
            
            <div class="action-buttons" style="margin-top: 2rem;">
                <button class="btn btn-outline" onclick="exportTableToPDF('incidentsTable')">üìÑ Export PDF</button>
                <button class="btn btn-outline" onclick="closeModal('incidentsModal')">Close</button>
                <button class="btn btn-primary" onclick="openModal('reportIncidentModal')">+ Report New Incident</button>
            </div>
        </div>
    </div>

    <!-- Safety Training Modal -->
    <div id="trainingModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('trainingModal')">√ó</button>
            <div class="modal-header">
                <h2>Safety Training Management</h2>
                <p>Track all safety training activities and certifications</p>
            </div>
            
            <div class="tab-container">
                <div class="tab-buttons">
                    <button class="tab-button active" onclick="switchTab('trainingRecordsTab', 'trainingModal')">Training Records</button>
                    <button class="tab-button" onclick="switchTab('trainingAttachmentsTab', 'trainingModal')">Certificates</button>
                    <button class="tab-button" onclick="switchTab('trainingStatsTab', 'trainingModal')">Statistics</button>
                </div>
                
                <div class="tab-content active" id="trainingRecordsTab">
                    <div style="overflow-x: auto; margin-top: 1rem;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Training ID</th>
                                    <th>Employee</th>
                                    <th>Training Type</th>
                                    <th>Provider</th>
                                    <th>Start Date</th>
                                    <th>End Date</th>
                                    <th>Status</th>
                                    <th>Score</th>
                                    <th>Expiry Date</th>
                                    <th>Notes</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="trainingTableBody">
                                <!-- Training records will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="tab-content" id="trainingAttachmentsTab">
                    <div class="form-group">
                        <label>Select Employee</label>
                        <select id="trainingEmployeeSelect" onchange="loadTrainingCertificates()">
                            <option value="">Select employee</option>
                        </select>
                    </div>
                    
                    <div class="file-upload-area" onclick="document.getElementById('trainingFileInput').click()">
                        <input type="file" id="trainingFileInput" style="display: none;" multiple onchange="uploadTrainingCertificate()">
                        <div style="font-size: 3rem;">üìé</div>
                        <div style="margin: 1rem 0;">Click to upload training certificates</div>
                    </div>
                    
                    <div class="file-list" id="trainingCertificatesList">
                        <!-- Certificates will be listed here -->
                    </div>
                </div>
                
                <div class="tab-content" id="trainingStatsTab">
                    <div style="margin-top: 1rem;">
                        <canvas id="trainingStatsChart" height="300"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="action-buttons" style="margin-top: 2rem;">
                <button class="btn btn-outline" onclick="addTrainingRecord()">+ Add Training</button>
                <button class="btn btn-outline" onclick="exportTableToPDF('trainingTable')">üìÑ Export PDF</button>
                <button class="btn btn-outline" onclick="closeModal('trainingModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- PPE Management Modal -->
    <div id="ppeModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('ppeModal')">√ó</button>
            <div class="modal-header">
                <h2>PPE Management System</h2>
                <p>Personal Protective Equipment Management</p>
            </div>
            
            <div class="tab-container">
                <div class="tab-buttons">
                    <button class="tab-button active" onclick="switchTab('ppeRecordsTab', 'ppeModal')">PPE Records</button>
                    <button class="tab-button" onclick="switchTab('ppeIssuanceTab', 'ppeModal')">Issuance Log</button>
                    <button class="tab-button" onclick="switchTab('ppeAttachmentsTab', 'ppeModal')">Documents</button>
                </div>
                
                <div class="tab-content active" id="ppeRecordsTab">
                    <div style="overflow-x: auto; margin-top: 1rem;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>PPE ID</th>
                                    <th>Equipment Type</th>
                                    <th>Size</th>
                                    <th>Brand</th>
                                    <th>Quantity</th>
                                    <th>Location</th>
                                    <th>Status</th>
                                    <th>Last Inspection</th>
                                    <th>Next Inspection</th>
                                    <th>Condition</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="ppeTableBody">
                                <!-- PPE items will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="tab-content" id="ppeIssuanceTab">
                    <div style="overflow-x: auto; margin-top: 1rem;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Issue ID</th>
                                    <th>PPE ID</th>
                                    <th>Employee</th>
                                    <th>Issue Date</th>
                                    <th>Expiry Date</th>
                                    <th>Issued By</th>
                                    <th>Return Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="ppeIssuanceTableBody">
                                <!-- Issuance records will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="tab-content" id="ppeAttachmentsTab">
                    <div class="form-group">
                        <label>Select PPE Item</label>
                        <select id="ppeItemSelect" onchange="loadPPEDocuments()">
                            <option value="">Select PPE item</option>
                        </select>
                    </div>
                    
                    <div class="file-upload-area" onclick="document.getElementById('ppeFileInput').click()">
                        <input type="file" id="ppeFileInput" style="display: none;" multiple onchange="uploadPPEDocument()">
                        <div style="font-size: 3rem;">üìé</div>
                        <div style="margin: 1rem 0;">Click to upload PPE documents</div>
                    </div>
                    
                    <div class="file-list" id="ppeDocumentsList">
                        <!-- Documents will be listed here -->
                    </div>
                </div>
            </div>
            
            <div class="action-buttons" style="margin-top: 2rem;">
                <button class="btn btn-outline" onclick="addPPEItem()">+ Add PPE</button>
                <button class="btn btn-outline" onclick="issuePPE()">üìù Issue PPE</button>
                <button class="btn btn-outline" onclick="exportTableToPDF('ppeTable')">üìÑ Export PDF</button>
                <button class="btn btn-outline" onclick="closeModal('ppeModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Health Surveillance Modal -->
    <div id="healthModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('healthModal')">√ó</button>
            <div class="modal-header">
                <h2>Employee Health Surveillance</h2>
                <p>Employee Health Monitoring - All MMS Employees</p>
            </div>
            
            <div class="tab-container">
                <div class="tab-buttons">
                    <button class="tab-button active" onclick="switchTab('healthRecordsTab', 'healthModal')">Health Records</button>
                    <button class="tab-button" onclick="switchTab('healthAttachmentsTab', 'healthModal')">Medical Records</button>
                    <button class="tab-button" onclick="switchTab('healthStatsTab', 'healthModal')">Statistics</button>
                </div>
                
                <div class="tab-content active" id="healthRecordsTab">
                    <div style="overflow-x: auto; margin-top: 1rem;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Employee ID</th>
                                    <th>Name</th>
                                    <th>Location</th>
                                    <th>Position</th>
                                    <th>Last Medical</th>
                                    <th>Next Due</th>
                                    <th>Blood Group</th>
                                    <th>Allergies</th>
                                    <th>Medical Status</th>
                                    <th>Emergency Contact</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="healthTableBody">
                                <!-- Health records will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="tab-content" id="healthAttachmentsTab">
                    <div class="form-group">
                        <label>Select Employee</label>
                        <select id="healthEmployeeSelect" onchange="loadHealthAttachments()">
                            <option value="">Select employee</option>
                        </select>
                    </div>
                    
                    <div class="file-upload-area" onclick="document.getElementById('healthFileInput').click()">
                        <input type="file" id="healthFileInput" style="display: none;" multiple onchange="uploadHealthAttachment()">
                        <div style="font-size: 3rem;">üìé</div>
                        <div style="margin: 1rem 0;">Click to upload medical records</div>
                    </div>
                    
                    <div class="file-list" id="healthAttachmentsList">
                        <!-- Attachments will be listed here -->
                    </div>
                </div>
                
                <div class="tab-content" id="healthStatsTab">
                    <div style="margin-top: 1rem;">
                        <canvas id="healthStatsChart" height="300"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="action-buttons" style="margin-top: 2rem;">
                <button class="btn btn-outline" onclick="addHealthRecord()">+ Add Record</button>
                <button class="btn btn-outline" onclick="exportTableToPDF('healthTable')">üìÑ Export PDF</button>
                <button class="btn btn-outline" onclick="closeModal('healthModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Contractor Safety Modal -->
    <div id="contractorModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('contractorModal')">√ó</button>
            <div class="modal-header">
                <h2>Contractor Safety Management</h2>
                <p>Contractor Safety Compliance</p>
            </div>
            
            <div class="tab-container">
                <div class="tab-buttons">
                    <button class="tab-button active" onclick="switchTab('contractorRecordsTab', 'contractorModal')">Contractor Records</button>
                    <button class="tab-button" onclick="switchTab('contractorPermitsTab', 'contractorModal')">Permits</button>
                    <button class="tab-button" onclick="switchTab('contractorAttachmentsTab', 'contractorModal')">Documents</button>
                </div>
                
                <div class="tab-content active" id="contractorRecordsTab">
                    <div style="overflow-x: auto; margin-top: 1rem;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Contractor ID</th>
                                    <th>Company</th>
                                    <th>Contact Person</th>
                                    <th>Phone</th>
                                    <th>Email</th>
                                    <th>Work Type</th>
                                    <th>Location</th>
                                    <th>Start Date</th>
                                    <th>End Date</th>
                                    <th>Safety Rating</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="contractorTableBody">
                                <!-- Contractor records will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="tab-content" id="contractorPermitsTab">
                    <div style="overflow-x: auto; margin-top: 1rem;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Permit ID</th>
                                    <th>Contractor</th>
                                    <th>Work Type</th>
                                    <th>Location</th>
                                    <th>Issued Date</th>
                                    <th>Expiry Date</th>
                                    <th>Issued By</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="contractorPermitsTableBody">
                                <!-- Permit records will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="tab-content" id="contractorAttachmentsTab">
                    <div class="form-group">
                        <label>Select Contractor</label>
                        <select id="contractorSelect" onchange="loadContractorAttachments()">
                            <option value="">Select contractor</option>
                        </select>
                    </div>
                    
                    <div class="file-upload-area" onclick="document.getElementById('contractorFileInput').click()">
                        <input type="file" id="contractorFileInput" style="display: none;" multiple onchange="uploadContractorAttachment()">
                        <div style="font-size: 3rem;">üìé</div>
                        <div style="margin: 1rem 0;">Click to upload contractor documents</div>
                    </div>
                    
                    <div class="file-list" id="contractorAttachmentsList">
                        <!-- Attachments will be listed here -->
                    </div>
                </div>
            </div>
            
            <div class="action-buttons" style="margin-top: 2rem;">
                <button class="btn btn-outline" onclick="addContractor()">+ Add Contractor</button>
                <button class="btn btn-outline" onclick="issuePermit()">üìù Issue Permit</button>
                <button class="btn btn-outline" onclick="exportTableToPDF('contractorTable')">üìÑ Export PDF</button>
                <button class="btn btn-outline" onclick="closeModal('contractorModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Audit & Inspection Modal -->
    <div id="auditModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('auditModal')">√ó</button>
            <div class="modal-header">
                <h2>Audit & Inspection Management</h2>
                <p>Safety Audits and Inspections</p>
            </div>
            
            <div class="tab-container">
                <div class="tab-buttons">
                    <button class="tab-button active" onclick="switchTab('auditRecordsTab', 'auditModal')">Audit Records</button>
                    <button class="tab-button" onclick="switchTab('auditScheduleTab', 'auditModal')">Schedule</button>
                    <button class="tab-button" onclick="switchTab('auditAttachmentsTab', 'auditModal')">Reports</button>
                </div>
                
                <div class="tab-content active" id="auditRecordsTab">
                    <div style="overflow-x: auto; margin-top: 1rem;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Audit ID</th>
                                    <th>Type</th>
                                    <th>Location</th>
                                    <th>Audit Date</th>
                                    <th>Auditor</th>
                                    <th>Score</th>
                                    <th>Status</th>
                                    <th>Findings</th>
                                    <th>Corrective Actions</th>
                                    <th>Next Audit</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="auditTableBody">
                                <!-- Audit records will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="tab-content" id="auditScheduleTab">
                    <div style="overflow-x: auto; margin-top: 1rem;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Schedule ID</th>
                                    <th>Audit Type</th>
                                    <th>Location</th>
                                    <th>Scheduled Date</th>
                                    <th>Frequency</th>
                                    <th>Assigned To</th>
                                    <th>Status</th>
                                    <th>Priority</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="auditScheduleTableBody">
                                <!-- Schedule records will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="tab-content" id="auditAttachmentsTab">
                    <div class="form-group">
                        <label>Select Audit</label>
                        <select id="auditSelect" onchange="loadAuditAttachments()">
                            <option value="">Select audit</option>
                        </select>
                    </div>
                    
                    <div class="file-upload-area" onclick="document.getElementById('auditFileInput').click()">
                        <input type="file" id="auditFileInput" style="display: none;" multiple onchange="uploadAuditAttachment()">
                        <div style="font-size: 3rem;">üìé</div>
                        <div style="margin: 1rem 0;">Click to upload audit reports</div>
                    </div>
                    
                    <div class="file-list" id="auditAttachmentsList">
                        <!-- Attachments will be listed here -->
                    </div>
                </div>
            </div>
            
            <div class="action-buttons" style="margin-top: 2rem;">
                <button class="btn btn-outline" onclick="addAudit()">+ Add Audit</button>
                <button class="btn btn-outline" onclick="scheduleAudit()">üìÖ Schedule Audit</button>
                <button class="btn btn-outline" onclick="exportTableToPDF('auditTable')">üìÑ Export PDF</button>
                <button class="btn btn-outline" onclick="closeModal('auditModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Standards Compliance Modal -->
    <div id="standardsModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('standardsModal')">√ó</button>
            <div class="modal-header">
                <h2>Standards & Compliance Management</h2>
                <p>Manage International and National Safety Standards</p>
            </div>
            
            <div class="tab-container">
                <div class="tab-buttons">
                    <button class="tab-button active" onclick="switchTab('standardsListTab', 'standardsModal')">Standards</button>
                    <button class="tab-button" onclick="switchTab('complianceTab', 'standardsModal')">Compliance Status</button>
                    <button class="tab-button" onclick="switchTab('standardsAttachmentsTab', 'standardsModal')">Documents</button>
                </div>
                
                <div class="tab-content active" id="standardsListTab">
                    <div class="standards-grid" id="standardsGrid">
                        <!-- Standards cards will be loaded here -->
                    </div>
                </div>
                
                <div class="tab-content" id="complianceTab">
                    <div style="margin-top: 1rem;">
                        <canvas id="complianceChart" height="300"></canvas>
                    </div>
                </div>
                
                <div class="tab-content" id="standardsAttachmentsTab">
                    <div class="form-group">
                        <label>Select Standard</label>
                        <select id="standardSelect" onchange="loadStandardAttachments()">
                            <option value="">Select standard</option>
                        </select>
                    </div>
                    
                    <div class="file-upload-area" onclick="document.getElementById('standardFileInput').click()">
                        <input type="file" id="standardFileInput" style="display: none;" multiple onchange="uploadStandardAttachment()">
                        <div style="font-size: 3rem;">üìé</div>
                        <div style="margin: 1rem 0;">Click to upload standard documents</div>
                    </div>
                    
                    <div class="file-list" id="standardAttachmentsList">
                        <!-- Attachments will be listed here -->
                    </div>
                </div>
            </div>
            
            <div class="action-buttons" style="margin-top: 2rem;">
                <button class="btn btn-outline" onclick="addStandard()">+ Add Standard</button>
                <button class="btn btn-outline" onclick="exportStandardsToPDF()">üìÑ Export PDF</button>
                <button class="btn btn-outline" onclick="closeModal('standardsModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Standard Modal -->
    <div id="standardModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('standardModal')">√ó</button>
            <div class="modal-header">
                <h2 id="standardModalTitle">Add New Standard</h2>
            </div>
            
            <div class="success-message" id="standardSuccess">Standard saved successfully!</div>
            <div class="error-message" id="standardError">Please fill all required fields.</div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Standard Name *</label>
                    <input type="text" id="standardName" placeholder="e.g., ISO 45001:2018" required>
                </div>
                <div class="form-group">
                    <label>Standard Code *</label>
                    <input type="text" id="standardCode" placeholder="e.g., ISO45001" required>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Standard Type *</label>
                    <select id="standardType" required>
                        <option value="">Select type</option>
                        <option value="International">International</option>
                        <option value="National">National</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Country</label>
                    <select id="standardCountry">
                        <option value="">Select country</option>
                        <option value="South Africa">South Africa</option>
                        <option value="Tanzania">Tanzania</option>
                        <option value="Namibia">Namibia</option>
                        <option value="Zambia">Zambia</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label>Description *</label>
                <textarea id="standardDescription" rows="4" placeholder="Description of the standard and its requirements" required></textarea>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Status *</label>
                    <select id="standardStatus" required>
                        <option value="">Select status</option>
                        <option value="Compliant">Compliant</option>
                        <option value="Non-Compliant">Non-Compliant</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Pending Review">Pending Review</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Effective Date</label>
                    <input type="date" id="standardEffectiveDate">
                </div>
            </div>
            
            <div class="form-group">
                <label>Remarks</label>
                <textarea id="standardRemarks" rows="3" placeholder="Additional remarks or notes"></textarea>
            </div>
            
            <div class="form-group">
                <label>Upload Standard Document</label>
                <div class="file-upload-area" onclick="document.getElementById('standardFormFileInput').click()">
                    <input type="file" id="standardFormFileInput" style="display: none;" accept=".pdf,.doc,.docx,.jpg,.png">
                    <div style="font-size: 3rem;">üìé</div>
                    <div style="margin: 1rem 0;">Click to upload standard document</div>
                </div>
                <div class="file-list" id="standardFormFilesList"></div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-success" onclick="saveStandard()">üíæ Save Standard</button>
                <button class="btn btn-outline" onclick="closeModal('standardModal')">Cancel</button>
                <button class="btn btn-danger" id="deleteStandardBtn" style="display: none;" onclick="deleteCurrentStandard()">üóëÔ∏è Delete</button>
            </div>
        </div>
    </div>

    <!-- Risk Assessment Modal -->
    <div id="riskModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('riskModal')">√ó</button>
            <div class="modal-header">
                <h2>Risk Assessment Management</h2>
                <p>Click on any risk cell to edit details</p>
            </div>
            
            <div class="risk-matrix">
                <div class="chart-header">
                    <div>
                        <div class="chart-title">Risk Assessment Matrix</div>
                        <div class="chart-subtitle">Edit risk levels and departments</div>
                    </div>
                    <div>
                        <button class="btn btn-success" onclick="saveRiskMatrix()">üíæ Save Matrix</button>
                    </div>
                </div>
                <div class="matrix-grid" id="modalRiskMatrix">
                    <!-- Matrix cells will be loaded here -->
                </div>
            </div>
            
            <div class="action-buttons" style="margin-top: 2rem;">
                <button class="btn btn-outline" onclick="exportRiskMatrixToPDF()">üìÑ Export PDF</button>
                <button class="btn btn-outline" onclick="closeModal('riskModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('settingsModal')">√ó</button>
            <div class="modal-header">
                <h2>System Settings</h2>
                <p>Configure your Health & Safety Management System</p>
            </div>
            
            <div class="tab-container">
                <div class="tab-buttons">
                    <button class="tab-button active" onclick="switchTab('companySettingsTab', 'settingsModal')">Company Info</button>
                    <button class="tab-button" onclick="switchTab('locationSettingsTab', 'settingsModal')">Locations</button>
                    <button class="tab-button" onclick="switchTab('notificationSettingsTab', 'settingsModal')">Notifications</button>
                    <button class="tab-button" onclick="switchTab('backupSettingsTab', 'settingsModal')">Backup & Export</button>
                </div>
                
                <div class="tab-content active" id="companySettingsTab">
                    <div class="form-group">
                        <label>Company Name</label>
                        <input type="text" id="companyName" value="Metal Management Solutions">
                    </div>
                    <div class="form-group">
                        <label>Website</label>
                        <input type="url" id="companyWebsite" value="https://www.metalmanagementsolutions.com/">
                    </div>
                    <div class="form-group">
                        <label>Contact Email</label>
                        <input type="email" id="companyEmail" placeholder="safety@metalmanagementsolutions.com">
                    </div>
                    <div class="form-group">
                        <label>Contact Phone</label>
                        <input type="tel" id="companyPhone" placeholder="+27 21 123 4567">
                    </div>
                </div>
                
                <div class="tab-content" id="locationSettingsTab">
                    <div class="form-group">
                        <label>Add New Location</label>
                        <div class="form-row">
                            <input type="text" id="newLocationName" placeholder="Location Name">
                            <select id="newLocationCountry">
                                <option value="">Select Country</option>
                                <option value="South Africa">South Africa</option>
                                <option value="Tanzania">Tanzania</option>
                                <option value="Namibia">Namibia</option>
                                <option value="Zambia">Zambia</option>
                            </select>
                        </div>
                        <button class="btn btn-outline" onclick="addLocation()" style="margin-top: 0.5rem;">+ Add Location</button>
                    </div>
                    
                    <div style="margin-top: 2rem;">
                        <h4>Current Locations</h4>
                        <div id="locationsList">
                            <!-- Locations will be listed here -->
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="notificationSettingsTab">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="emailNotifications" checked>
                            Email Notifications
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="incidentAlerts" checked>
                            Incident Alerts
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="trainingReminders" checked>
                            Training Reminders
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="auditReminders" checked>
                            Audit Reminders
                        </label>
                    </div>
                    <div class="form-group">
                        <label>Notification Email</label>
                        <input type="email" id="notificationEmail" placeholder="Enter notification email">
                    </div>
                </div>
                
                <div class="tab-content" id="backupSettingsTab">
                    <div class="form-group">
                        <label>Backup Frequency</label>
                        <select id="backupFrequency">
                            <option value="daily">Daily</option>
                            <option value="weekly" selected>Weekly</option>
                            <option value="monthly">Monthly</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Auto-Export Reports</label>
                        <select id="autoExport">
                            <option value="none">None</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly" selected>Monthly</option>
                        </select>
                    </div>
                    <div class="action-buttons" style="margin-top: 2rem;">
                        <button class="btn btn-outline" onclick="backupData()">üíæ Backup Now</button>
                        <button class="btn btn-outline" onclick="exportAllData()">üìÑ Export All Data</button>
                        <button class="btn btn-danger" onclick="resetData()">üîÑ Reset System</button>
                    </div>
                </div>
            </div>
            
            <div class="action-buttons" style="margin-top: 2rem;">
                <button class="btn btn-success" onclick="saveSettings()">üíæ Save Settings</button>
                <button class="btn btn-outline" onclick="closeModal('settingsModal')">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        let incidents = [];
        let ppeItems = [];
        let ppeIssuance = [];
        let healthRecords = [];
        let contractors = [];
        let contractorPermits = [];
        let audits = [];
        let auditSchedule = [];
        let standards = [];
        let trainingRecords = [];
        let settings = {};
        let attachments = {
            incidents: {},
            health: {},
            contractor: {},
            audit: {},
            standards: {},
            training: {},
            ppe: {}
        };
        let incidentTrendChart = null;
        let editingCell = null;
        let editingStandardIndex = -1;
        let currentChartType = 'line';
        let locations = [
            { name: "Cape Town HQ", country: "South Africa" },
            { name: "Cosco Durban", country: "South Africa" },
            { name: "AGL Durban", country: "South Africa" },
            { name: "Impala Dar", country: "Tanzania" },
            { name: "Polytra Dar", country: "Tanzania" },
            { name: "Access Dar", country: "Tanzania" },
            { name: "WBCT Bulk Shed", country: "Namibia" },
            { name: "WBCT Quay Side Shed", country: "Namibia" },
            { name: "Bridge Walvis Bay", country: "Namibia" },
            { name: "Pindulo Walvis Bay", country: "Namibia" },
            { name: "Reload Giga Terminal", country: "Zambia" },
            { name: "AGL Chingola Hub", country: "Zambia" },
            { name: "Polytra Kitwe", country: "Zambia" },
            { name: "Impala Ndola", country: "Zambia" },
            { name: "SLS Ndola", country: "Zambia" },
            { name: "Poseidon Zambia", country: "Zambia" },
            { name: "Polytra Kapiri Mposhi", country: "Zambia" }
        ];

        // Initialize Application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            loadAllData();
            initializeCharts();
            loadAllTables();
            loadStandards();
            loadRiskMatrix();
            setupEventListeners();
            updateStatistics();
            populateEmployeeSelects();
            
            // Set default dates for chart
            const endDate = new Date();
            const startDate = new Date();
            startDate.setMonth(startDate.getMonth() - 6);
            
            document.getElementById('startDate').valueAsDate = startDate;
            document.getElementById('endDate').valueAsDate = endDate;
            
            // Set current date/time for incident report
            const now = new Date();
            const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000)
                .toISOString()
                .slice(0, 16);
            document.getElementById('incidentDateTime').value = localDateTime;
            
            // Load settings
            loadSettings();
        }

        function loadAllData() {
            // Load incidents
            const savedIncidents = localStorage.getItem('mmsIncidents');
            incidents = savedIncidents ? JSON.parse(savedIncidents) : getDefaultIncidents();
            
            // Load PPE items
            const savedPPE = localStorage.getItem('mmsPPEItems');
            ppeItems = savedPPE ? JSON.parse(savedPPE) : getDefaultPPE();
            
            // Load PPE issuance
            const savedPPEIssuance = localStorage.getItem('mmsPPEIssuance');
            ppeIssuance = savedPPEIssuance ? JSON.parse(savedPPEIssuance) : [];
            
            // Load health records
            const savedHealth = localStorage.getItem('mmsHealthRecords');
            healthRecords = savedHealth ? JSON.parse(savedHealth) : getDefaultHealth();
            
            // Load contractors
            const savedContractors = localStorage.getItem('mmsContractors');
            contractors = savedContractors ? JSON.parse(savedContractors) : getDefaultContractors();
            
            // Load contractor permits
            const savedPermits = localStorage.getItem('mmsContractorPermits');
            contractorPermits = savedPermits ? JSON.parse(savedPermits) : [];
            
            // Load audits
            const savedAudits = localStorage.getItem('mmsAudits');
            audits = savedAudits ? JSON.parse(savedAudits) : getDefaultAudits();
            
            // Load audit schedule
            const savedAuditSchedule = localStorage.getItem('mmsAuditSchedule');
            auditSchedule = savedAuditSchedule ? JSON.parse(savedAuditSchedule) : [];
            
            // Load standards
            const savedStandards = localStorage.getItem('mmsStandards');
            standards = savedStandards ? JSON.parse(savedStandards) : getDefaultStandards();
            
            // Load training records
            const savedTraining = localStorage.getItem('mmsTraining');
            trainingRecords = savedTraining ? JSON.parse(savedTraining) : getDefaultTraining();
            
            // Load attachments
            const savedAttachments = localStorage.getItem('mmsAttachments');
            attachments = savedAttachments ? JSON.parse(savedAttachments) : {
                incidents: {},
                health: {},
                contractor: {},
                audit: {},
                standards: {},
                training: {},
                ppe: {}
            };
            
            // Populate dropdowns
            populateHealthEmployeeSelect();
            populateContractorSelect();
            populateAuditSelect();
            populateTrainingEmployeeSelect();
            populatePPEItemSelect();
            populateIncidentSelect();
            populateStandardSelect();
        }

        function getDefaultIncidents() {
            return [
                {
                    id: 'INC-2024-001',
                    type: 'Near Miss',
                    severity: 'Minor',
                    location: 'Cape Town HQ',
                    reportedBy: 'Cephas Gideon Mkama',
                    department: 'Inventory Control',
                    date: '2024-01-15T10:30',
                    status: 'Resolved',
                    description: 'Forklift almost collided with pedestrian in warehouse aisle.',
                    actions: 'Area cordoned off, safety briefing conducted.',
                    recommendations: 'Improve pedestrian walkway markings and install warning signs.',
                    createdAt: new Date().toISOString()
                }
            ];
        }

        function getDefaultPPE() {
            return [
                {
                    id: 'PPE-001',
                    type: 'Safety Helmet',
                    size: 'M',
                    brand: '3M',
                    quantity: 50,
                    location: 'Cape Town HQ',
                    status: 'In Stock',
                    lastInspection: '2024-01-15',
                    nextInspection: '2024-07-15',
                    condition: 'Good'
                },
                {
                    id: 'PPE-002',
                    type: 'Safety Boots',
                    size: '42',
                    brand: 'Steel Blue',
                    quantity: 30,
                    location: 'Impala Dar',
                    status: 'In Stock',
                    lastInspection: '2024-02-01',
                    nextInspection: '2024-08-01',
                    condition: 'Good'
                }
            ];
        }

        function getDefaultHealth() {
            return [
                // Tanzania
                {
                    id: 'EMP-TZ-001',
                    name: 'Cephas Gideon Mkama',
                    location: 'Tanzania',
                    position: 'Inventory Control Specialist',
                    lastMedical: '2024-01-15',
                    nextDue: '2025-01-15',
                    bloodGroup: 'O+',
                    allergies: 'None',
                    medicalStatus: 'Fit',
                    emergencyContact: '+255 789 456 123'
                },
                {
                    id: 'EMP-TZ-002',
                    name: 'Salman Esmail',
                    location: 'Tanzania',
                    position: 'Inventory Control Specialist',
                    lastMedical: '2024-02-01',
                    nextDue: '2025-02-01',
                    bloodGroup: 'A+',
                    allergies: 'Penicillin',
                    medicalStatus: 'Fit',
                    emergencyContact: '+255 789 456 124'
                },
                // Namibia
                {
                    id: 'EMP-NA-001',
                    name: 'Leon Fourie',
                    location: 'Namibia',
                    position: 'Inventory Control Specialist',
                    lastMedical: '2024-01-20',
                    nextDue: '2025-01-20',
                    bloodGroup: 'B+',
                    allergies: 'None',
                    medicalStatus: 'Fit',
                    emergencyContact: '+264 81 123 4567'
                },
                {
                    id: 'EMP-NA-002',
                    name: 'Salomon Iyambo',
                    location: 'Namibia',
                    position: 'Inventory Control Specialist',
                    lastMedical: '2024-02-15',
                    nextDue: '2025-02-15',
                    bloodGroup: 'AB+',
                    allergies: 'Dust',
                    medicalStatus: 'Fit',
                    emergencyContact: '+264 81 123 4568'
                },
                {
                    id: 'EMP-NA-003',
                    name: 'Sakeus Iyambo',
                    location: 'Namibia',
                    position: 'Inventory Control Specialist',
                    lastMedical: '2024-03-01',
                    nextDue: '2025-03-01',
                    bloodGroup: 'O+',
                    allergies: 'None',
                    medicalStatus: 'Fit',
                    emergencyContact: '+264 81 123 4569'
                },
                // Zambia (partial list - add more as needed)
                {
                    id: 'EMP-ZM-001',
                    name: 'Alick Banda',
                    location: 'Zambia',
                    position: '',
                    lastMedical: '',
                    nextDue: '',
                    bloodGroup: '',
                    allergies: '',
                    medicalStatus: 'Pending',
                    emergencyContact: ''
                },
                {
                    id: 'EMP-ZM-002',
                    name: 'Alinaswe Mwanamoonga',
                    location: 'Zambia',
                    position: '',
                    lastMedical: '',
                    nextDue: '',
                    bloodGroup: '',
                    allergies: '',
                    medicalStatus: 'Pending',
                    emergencyContact: ''
                },
                // South Africa
                {
                    id: 'EMP-ZA-001',
                    name: 'Katlego Matsane',
                    location: 'South Africa',
                    position: 'Inventory Control Specialist - Durban',
                    lastMedical: '2024-01-10',
                    nextDue: '2025-01-10',
                    bloodGroup: 'O-',
                    allergies: 'None',
                    medicalStatus: 'Fit',
                    emergencyContact: '+27 82 123 4567'
                },
                {
                    id: 'EMP-ZA-002',
                    name: 'Bonnie Sibande',
                    location: 'South Africa',
                    position: 'Inventory Control Specialist - Durban',
                    lastMedical: '2024-02-05',
                    nextDue: '2025-02-05',
                    bloodGroup: 'A+',
                    allergies: 'Bee stings',
                    medicalStatus: 'Fit',
                    emergencyContact: '+27 82 123 4568'
                }
            ];
        }

        function getDefaultContractors() {
            return [
                {
                    id: 'CTR-001',
                    company: 'ABC Construction Ltd',
                    contactPerson: 'John Smith',
                    phone: '+27 21 123 4567',
                    email: 'john@abcconstruction.co.za',
                    workType: 'Building Maintenance',
                    location: 'Cape Town HQ',
                    startDate: '2024-01-01',
                    endDate: '2024-12-31',
                    safetyRating: 'A',
                    status: 'Active'
                }
            ];
        }

        function getDefaultAudits() {
            return [
                {
                    id: 'AUD-001',
                    type: 'Safety Audit',
                    location: 'Cape Town HQ',
                    auditDate: '2024-02-15',
                    auditor: 'Safety Officer',
                    score: '92%',
                    status: 'Completed',
                    findings: 'Minor issues with fire extinguisher placement',
                    correctiveActions: 'Fire extinguishers relocated to accessible locations',
                    nextAudit: '2024-08-15'
                }
            ];
        }

        function getDefaultStandards() {
            return [
                {
                    id: 'STD-001',
                    name: 'ISO 45001:2018',
                    code: 'ISO45001',
                    type: 'International',
                    country: '',
                    description: 'Occupational health and safety management systems - Requirements with guidance for use.',
                    status: 'In Progress',
                    effectiveDate: '2024-01-01',
                    remarks: 'Implementation across all locations'
                },
                {
                    id: 'STD-002',
                    name: 'OSHA Tanzania Regulations',
                    code: 'OSHA-TZ',
                    type: 'National',
                    country: 'Tanzania',
                    description: 'Occupational Safety and Health Administration regulations for Tanzania.',
                    status: 'Compliant',
                    effectiveDate: '2024-01-01',
                    remarks: 'Regular audits conducted'
                },
                {
                    id: 'STD-003',
                    name: 'NOSHC1 & NOSHC2',
                    code: 'NOSHC',
                    type: 'National',
                    country: 'Tanzania',
                    description: 'National Occupational Safety and Health Certificate levels 1 & 2.',
                    status: 'Compliant',
                    effectiveDate: '2024-01-01',
                    remarks: 'Cephas Gideon Mkama certified'
                },
                {
                    id: 'STD-004',
                    name: 'NEBOSH International General Certificate',
                    code: 'NEBOSH-IGC',
                    type: 'International',
                    country: '',
                    description: 'Internationally recognized health and safety qualification.',
                    status: 'In Progress',
                    effectiveDate: '2024-03-01',
                    remarks: 'Cephas Gideon Mkama currently training'
                }
            ];
        }

        function getDefaultTraining() {
            return [
                {
                    id: 'TRN-001',
                    employee: 'Cephas Gideon Mkama',
                    trainingType: 'NOSHC1&2',
                    provider: 'OSHA Tanzania',
                    startDate: '2023-09-01',
                    endDate: '2023-12-15',
                    status: 'Completed',
                    score: '95%',
                    expiryDate: '2026-12-15',
                    notes: 'National Occupational Safety and Health Certificate'
                },
                {
                    id: 'TRN-002',
                    employee: 'Cephas Gideon Mkama',
                    trainingType: 'NEBOSH International General Certificate',
                    provider: 'NEBOSH',
                    startDate: '2024-01-15',
                    endDate: '',
                    status: 'In Progress',
                    score: '',
                    expiryDate: '',
                    notes: 'Currently undergoing training'
                }
            ];
        }

        function populateEmployeeSelects() {
            const select = document.getElementById('reportedBy');
            if (!select) return;
            
            select.innerHTML = '<option value="">Select employee</option>';
            
            healthRecords.forEach(employee => {
                const option = document.createElement('option');
                option.value = employee.name;
                option.textContent = `${employee.name} - ${employee.position}`;
                select.appendChild(option);
            });
        }

        function loadSettings() {
            const savedSettings = localStorage.getItem('mmsSettings');
            settings = savedSettings ? JSON.parse(savedSettings) : {
                companyName: 'Metal Management Solutions',
                website: 'https://www.metalmanagementsolutions.com/',
                emailNotifications: true,
                incidentAlerts: true,
                trainingReminders: true,
                auditReminders: true,
                backupFrequency: 'weekly',
                autoExport: 'monthly'
            };
            
            // Apply settings to form
            if (document.getElementById('companyName')) {
                document.getElementById('companyName').value = settings.companyName;
                document.getElementById('companyWebsite').value = settings.website;
                document.getElementById('emailNotifications').checked = settings.emailNotifications;
                document.getElementById('incidentAlerts').checked = settings.incidentAlerts;
                document.getElementById('trainingReminders').checked = settings.trainingReminders;
                document.getElementById('auditReminders').checked = settings.auditReminders;
                document.getElementById('backupFrequency').value = settings.backupFrequency;
                document.getElementById('autoExport').value = settings.autoExport;
            }
            
            // Load locations list
            loadLocationsList();
        }

        function saveSettings() {
            settings = {
                companyName: document.getElementById('companyName').value,
                website: document.getElementById('companyWebsite').value,
                emailNotifications: document.getElementById('emailNotifications').checked,
                incidentAlerts: document.getElementById('incidentAlerts').checked,
                trainingReminders: document.getElementById('trainingReminders').checked,
                auditReminders: document.getElementById('auditReminders').checked,
                backupFrequency: document.getElementById('backupFrequency').value,
                autoExport: document.getElementById('autoExport').value
            };
            
            localStorage.setItem('mmsSettings', JSON.stringify(settings));
            showToast('Success', 'Settings saved successfully!', 'success');
        }

        function loadLocationsList() {
            const container = document.getElementById('locationsList');
            if (!container) return;
            
            container.innerHTML = '';
            
            locations.forEach((location, index) => {
                const div = document.createElement('div');
                div.className = 'file-item';
                div.innerHTML = `
                    <div>
                        <div style="font-weight: 500;">${location.name}</div>
                        <div style="font-size: 0.75rem; color: var(--text-light);">${location.country}</div>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="deleteLocation(${index})">Delete</button>
                `;
                container.appendChild(div);
            });
        }

        function addLocation() {
            const name = document.getElementById('newLocationName').value;
            const country = document.getElementById('newLocationCountry').value;
            
            if (!name || !country) {
                showToast('Error', 'Please enter location name and select country', 'error');
                return;
            }
            
            locations.push({ name, country });
            document.getElementById('newLocationName').value = '';
            document.getElementById('newLocationCountry').value = '';
            
            loadLocationsList();
            showToast('Success', 'Location added successfully', 'success');
        }

        function deleteLocation(index) {
            locations.splice(index, 1);
            loadLocationsList();
            showToast('Success', 'Location deleted', 'success');
        }

        function backupData() {
            const backup = {
                incidents,
                ppeItems,
                ppeIssuance,
                healthRecords,
                contractors,
                contractorPermits,
                audits,
                auditSchedule,
                standards,
                trainingRecords,
                attachments,
                settings,
                timestamp: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mms-safety-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('Success', 'Backup created successfully', 'success');
        }

        function exportAllData() {
            const data = {
                incidents,
                ppeItems,
                healthRecords,
                contractors,
                audits,
                standards,
                trainingRecords
            };
            
            // Create PDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            let y = 20;
            doc.setFontSize(20);
            doc.text('Metal Management Solutions', 20, y);
            doc.setFontSize(16);
            doc.text('Health & Safety Data Export', 20, y + 10);
            doc.setFontSize(12);
            doc.text(`Generated: ${new Date().toLocaleDateString()}`, 20, y + 20);
            
            y = 40;
            
            // Add each section
            const sections = [
                { title: 'Incidents', data: incidents },
                { title: 'PPE Items', data: ppeItems },
                { title: 'Employee Health Records', data: healthRecords },
                { title: 'Contractors', data: contractors },
                { title: 'Audits', data: audits },
                { title: 'Standards', data: standards },
                { title: 'Training Records', data: trainingRecords }
            ];
            
            sections.forEach(section => {
                if (y > 270) {
                    doc.addPage();
                    y = 20;
                }
                
                doc.setFontSize(14);
                doc.text(section.title, 20, y);
                y += 10;
                
                if (section.data.length === 0) {
                    doc.setFontSize(10);
                    doc.text('No data available', 20, y);
                    y += 10;
                } else {
                    section.data.forEach(item => {
                        if (y > 270) {
                            doc.addPage();
                            y = 20;
                        }
                        doc.setFontSize(10);
                        doc.text(JSON.stringify(item, null, 2), 20, y, { maxWidth: 170 });
                        y += 40;
                    });
                }
                
                y += 10;
            });
            
            doc.save(`mms-safety-export-${new Date().toISOString().split('T')[0]}.pdf`);
            showToast('Success', 'All data exported to PDF', 'success');
        }

        function resetData() {
            showConfirmDialog('Reset System', 'Are you sure you want to reset all data? This cannot be undone.', function() {
                localStorage.clear();
                showToast('Success', 'System reset. Reloading page...', 'success');
                setTimeout(() => location.reload(), 2000);
            });
        }

        // Update statistics
        function updateStatistics() {
            // Update Lost Time Injuries
            const ltiCount = incidents.filter(i => i.type === 'Lost Time Injury').length;
            document.getElementById('lostTimeInjuries').textContent = ltiCount;
            
            // Update Safety Trainings
            const trainingCount = trainingRecords.length;
            document.getElementById('safetyTrainings').textContent = trainingCount;
            
            // Update Compliance Rate
            const compliantStandards = standards.filter(s => s.status === 'Compliant').length;
            const complianceRate = standards.length > 0 ? Math.round((compliantStandards / standards.length) * 100) : 0;
            document.getElementById('complianceRate').textContent = complianceRate + '%';
            
            // Update Active Audits
            const activeAuditsCount = audits.filter(a => a.status === 'In Progress' || a.status === 'Scheduled').length;
            document.getElementById('activeAudits').textContent = activeAuditsCount;
        }

        function saveAllData() {
            localStorage.setItem('mmsIncidents', JSON.stringify(incidents));
            localStorage.setItem('mmsPPEItems', JSON.stringify(ppeItems));
            localStorage.setItem('mmsPPEIssuance', JSON.stringify(ppeIssuance));
            localStorage.setItem('mmsHealthRecords', JSON.stringify(healthRecords));
            localStorage.setItem('mmsContractors', JSON.stringify(contractors));
            localStorage.setItem('mmsContractorPermits', JSON.stringify(contractorPermits));
            localStorage.setItem('mmsAudits', JSON.stringify(audits));
            localStorage.setItem('mmsAuditSchedule', JSON.stringify(auditSchedule));
            localStorage.setItem('mmsStandards', JSON.stringify(standards));
            localStorage.setItem('mmsTraining', JSON.stringify(trainingRecords));
            localStorage.setItem('mmsAttachments', JSON.stringify(attachments));
        }

        // Chart Functions
        function initializeCharts() {
            const ctx = document.getElementById('incidentTrendChart').getContext('2d');
            
            // Generate data for the last 6 months
            const months = [];
            const incidentData = [];
            const nearMissData = [];
            const firstAidData = [];
            
            const endDate = new Date();
            const startDate = new Date();
            startDate.setMonth(startDate.getMonth() - 6);
            
            // Generate month labels and sample data
            let currentDate = new Date(startDate);
            while (currentDate <= endDate) {
                const monthName = currentDate.toLocaleString('default', { month: 'short' });
                months.push(monthName);
                
                // Generate sample data
                incidentData.push(Math.floor(Math.random() * 5) + 1);
                nearMissData.push(Math.floor(Math.random() * 8) + 2);
                firstAidData.push(Math.floor(Math.random() * 4) + 1);
                
                currentDate.setMonth(currentDate.getMonth() + 1);
            }
            
            incidentTrendChart = new Chart(ctx, {
                type: currentChartType,
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Incidents',
                            data: incidentData,
                            borderColor: '#ef4444',
                            backgroundColor: currentChartType === 'line' ? 'rgba(239, 68, 68, 0.1)' : '#ef4444',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: currentChartType === 'line',
                            pointBackgroundColor: '#ef4444',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        },
                        {
                            label: 'Near Misses',
                            data: nearMissData,
                            borderColor: '#f59e0b',
                            backgroundColor: currentChartType === 'line' ? 'rgba(245, 158, 11, 0.1)' : '#f59e0b',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: currentChartType === 'line',
                            pointBackgroundColor: '#f59e0b',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        },
                        {
                            label: 'First Aid Cases',
                            data: firstAidData,
                            borderColor: '#10b981',
                            backgroundColor: currentChartType === 'line' ? 'rgba(16, 185, 129, 0.1)' : '#10b981',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: currentChartType === 'line',
                            pointBackgroundColor: '#10b981',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }
                    ]
                },
                options: getChartOptions(currentChartType)
            });
        }

        function getChartOptions(chartType) {
            const baseOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 10,
                            font: {
                                size: 12
                            }
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(30, 41, 59, 0.9)',
                        titleFont: {
                            size: 12
                        },
                        bodyFont: {
                            size: 11
                        },
                        padding: 10
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                layout: {
                    padding: {
                        top: 10,
                        bottom: 10
                    }
                }
            };

            if (chartType === 'line' || chartType === 'bar') {
                return {
                    ...baseOptions,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                drawBorder: false,
                                color: 'rgba(226, 232, 240, 0.5)'
                            },
                            ticks: {
                                font: {
                                    size: 11
                                },
                                stepSize: 2
                            },
                            title: {
                                display: true,
                                text: 'Number of Cases',
                                font: {
                                    size: 11
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: chartType === 'bar'
                            },
                            ticks: {
                                font: {
                                    size: 11
                                }
                            }
                        }
                    }
                };
            } else {
                return baseOptions;
            }
        }

        function changeChartType(type) {
            currentChartType = type;
            
            // Update button states
            document.querySelectorAll('.chart-type-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update chart type
            incidentTrendChart.destroy();
            initializeCharts();
        }

        function updateChartWithCustomRange() {
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            
            if (!startDateInput.value || !endDateInput.value) {
                showToast('Warning', 'Please select both start and end dates', 'warning');
                return;
            }
            
            const startDate = new Date(startDateInput.value);
            const endDate = new Date(endDateInput.value);
            
            if (startDate > endDate) {
                showToast('Error', 'Start date cannot be after end date', 'error');
                return;
            }
            
            showToast('Success', `Chart updated for selected period`, 'success');
        }

        // Risk Matrix Functions
        function loadRiskMatrix() {
            const matrixContainer = document.getElementById('riskMatrix');
            const modalMatrixContainer = document.getElementById('modalRiskMatrix');
            
            const matrixData = [
                { riskLevel: 'Low Risk', department: 'Admin', colorClass: 'risk-low' },
                { riskLevel: 'Medium Risk', department: 'Sales Office', colorClass: 'risk-medium' },
                { riskLevel: 'High Risk', department: 'Warehouse', colorClass: 'risk-high' },
                { riskLevel: 'Very High Risk', department: 'Manufacturing', colorClass: 'risk-very-high' },
                { riskLevel: 'Extreme Risk', department: 'Construction Site', colorClass: 'risk-extreme' }
            ];
            
            [matrixContainer, modalMatrixContainer].forEach(container => {
                if (!container) return;
                
                container.innerHTML = '';
                
                matrixData.forEach((item, index) => {
                    const cell = document.createElement('div');
                    cell.className = `matrix-cell ${item.colorClass}`;
                    cell.innerHTML = `
                        <div>${item.riskLevel}</div>
                        <div>${item.department}</div>
                    `;
                    cell.onclick = function() { editRiskCell(this); };
                    container.appendChild(cell);
                });
            });
        }

        function editRiskCell(cell) {
            if (editingCell) return;
            
            editingCell = cell;
            const originalContent = cell.innerHTML;
            
            // Get current values
            const lines = cell.textContent.split('\n').map(line => line.trim()).filter(line => line);
            const riskLevel = lines[0] || 'Low Risk';
            const department = lines[1] || 'Department';
            
            // Create edit form
            cell.innerHTML = `
                <input type="text" class="edit-input mb-1" value="${riskLevel}" placeholder="Risk Level">
                <input type="text" class="edit-input mb-1" value="${department}" placeholder="Department">
                <select class="edit-select mb-1" id="riskColor">
                    <option value="risk-low" ${cell.classList.contains('risk-low') ? 'selected' : ''}>Low Risk</option>
                    <option value="risk-medium" ${cell.classList.contains('risk-medium') ? 'selected' : ''}>Medium Risk</option>
                    <option value="risk-high" ${cell.classList.contains('risk-high') ? 'selected' : ''}>High Risk</option>
                    <option value="risk-very-high" ${cell.classList.contains('risk-very-high') ? 'selected' : ''}>Very High Risk</option>
                    <option value="risk-extreme" ${cell.classList.contains('risk-extreme') ? 'selected' : ''}>Extreme Risk</option>
                </select>
                <div class="mt-1">
                    <button class="btn btn-sm btn-success" onclick="saveRiskCellEdit(this)">Save</button>
                    <button class="btn btn-sm btn-outline" onclick="cancelRiskCellEdit(this, '${originalContent.replace(/'/g, "\\'")}')">Cancel</button>
                </div>
            `;
            
            cell.classList.add('editing');
            cell.querySelector('input').focus();
        }

        function saveRiskCellEdit(button) {
            const cell = button.closest('.matrix-cell');
            const inputs = cell.querySelectorAll('input, select');
            
            const riskLevel = inputs[0].value;
            const department = inputs[1].value;
            const colorClass = inputs[2].value;
            
            // Update cell
            cell.className = `matrix-cell ${colorClass}`;
            cell.innerHTML = `
                <div>${riskLevel}</div>
                <div>${department}</div>
            `;
            
            // Restore click handler
            cell.onclick = function() { editRiskCell(this); };
            
            editingCell = null;
            showToast('Success', 'Risk cell updated!', 'success');
        }

        function cancelRiskCellEdit(button, originalContent) {
            const cell = button.closest('.matrix-cell');
            cell.innerHTML = originalContent;
            cell.classList.remove('editing');
            cell.onclick = function() { editRiskCell(this); };
            editingCell = null;
        }

        function saveRiskMatrix() {
            showToast('Success', 'Risk matrix saved successfully!', 'success');
        }

        function exportRiskMatrixToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(20);
            doc.text('Risk Assessment Matrix', 20, 20);
            doc.setFontSize(12);
            doc.text('Metal Management Solutions', 20, 30);
            doc.text(`Generated: ${new Date().toLocaleDateString()}`, 20, 40);
            
            const matrixData = [
                { risk: 'Low Risk', department: 'Admin', color: '#dcfce7' },
                { risk: 'Medium Risk', department: 'Sales Office', color: '#fef3c7' },
                { risk: 'High Risk', department: 'Warehouse', color: '#fed7aa' },
                { risk: 'Very High Risk', department: 'Manufacturing', color: '#fecaca' },
                { risk: 'Extreme Risk', department: 'Construction Site', color: '#fca5a5' }
            ];
            
            let y = 60;
            matrixData.forEach((item, index) => {
                doc.setFillColor(item.color);
                doc.rect(20, y, 170, 15, 'F');
                doc.setTextColor(0);
                doc.text(`${item.risk} - ${item.department}`, 25, y + 10);
                y += 20;
            });
            
            doc.save(`risk-matrix-${new Date().toISOString().split('T')[0]}.pdf`);
            showToast('Success', 'Risk matrix exported to PDF', 'success');
        }

        // Table Loading Functions
        function loadAllTables() {
            loadIncidentsTable();
            loadPPETable();
            loadHealthTable();
            loadContractorTable();
            loadAuditTable();
            loadTrainingTable();
            loadPPEIssuanceTable();
            loadAuditScheduleTable();
            loadContractorPermitsTable();
        }

        function loadIncidentsTable() {
            const mainTable = document.getElementById('allIncidentsTableBody');
            const modalTable = document.getElementById('modalIncidentsTableBody');
            
            const tables = [mainTable, modalTable].filter(table => table);
            
            tables.forEach(table => {
                if (!table) return;
                
                table.innerHTML = '';
                
                incidents.forEach((incident, index) => {
                    const row = document.createElement('tr');
                    const date = new Date(incident.date);
                    const formattedDate = date.toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric'
                    });
                    
                    row.innerHTML = `
                        <td class="editable" onclick="editTableCell(this, 'incidents', ${index}, 'id')">${incident.id}</td>
                        <td class="editable" onclick="editTableCell(this, 'incidents', ${index}, 'type')">${incident.type}</td>
                        <td class="editable" onclick="editTableCell(this, 'incidents', ${index}, 'date')">${formattedDate}</td>
                        <td class="editable" onclick="editTableCell(this, 'incidents', ${index}, 'location')">${incident.location}</td>
                        <td class="editable" onclick="editTableCell(this, 'incidents', ${index}, 'reportedBy')">${incident.reportedBy}</td>
                        <td class="editable" onclick="editTableCell(this, 'incidents', ${index}, 'severity')">${incident.severity}</td>
                        <td class="editable" onclick="editTableCell(this, 'incidents', ${index}, 'status')">${incident.status}</td>
                        <td class="editable" onclick="editTableCell(this, 'incidents', ${index}, 'description')">${incident.description}</td>
                        <td class="editable" onclick="editTableCell(this, 'incidents', ${index}, 'actions')">${incident.actions}</td>
                        <td class="editable" onclick="editTableCell(this, 'incidents', ${index}, 'recommendations')">${incident.recommendations}</td>
                        <td>
                            <button class="btn btn-sm btn-outline" onclick="deleteItem('incidents', ${index})">Delete</button>
                        </td>
                    `;
                    table.appendChild(row);
                });
            });
        }

        function loadTrainingTable() {
            const table = document.getElementById('trainingTableBody');
            if (!table) return;
            
            table.innerHTML = '';
            
            trainingRecords.forEach((record, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="editable" onclick="editTableCell(this, 'trainingRecords', ${index}, 'id')">${record.id}</td>
                    <td class="editable" onclick="editTableCell(this, 'trainingRecords', ${index}, 'employee')">${record.employee}</td>
                    <td class="editable" onclick="editTableCell(this, 'trainingRecords', ${index}, 'trainingType')">${record.trainingType}</td>
                    <td class="editable" onclick="editTableCell(this, 'trainingRecords', ${index}, 'provider')">${record.provider}</td>
                    <td class="editable" onclick="editTableCell(this, 'trainingRecords', ${index}, 'startDate')">${record.startDate}</td>
                    <td class="editable" onclick="editTableCell(this, 'trainingRecords', ${index}, 'endDate')">${record.endDate}</td>
                    <td class="editable" onclick="editTableCell(this, 'trainingRecords', ${index}, 'status')">${record.status}</td>
                    <td class="editable" onclick="editTableCell(this, 'trainingRecords', ${index}, 'score')">${record.score}</td>
                    <td class="editable" onclick="editTableCell(this, 'trainingRecords', ${index}, 'expiryDate')">${record.expiryDate}</td>
                    <td class="editable" onclick="editTableCell(this, 'trainingRecords', ${index}, 'notes')">${record.notes}</td>
                    <td>
                        <button class="btn btn-sm btn-outline" onclick="deleteItem('trainingRecords', ${index})">Delete</button>
                    </td>
                `;
                table.appendChild(row);
            });
        }

        function loadPPETable() {
            const table = document.getElementById('ppeTableBody');
            if (!table) return;
            
            table.innerHTML = '';
            
            ppeItems.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="editable" onclick="editTableCell(this, 'ppeItems', ${index}, 'id')">${item.id}</td>
                    <td class="editable" onclick="editTableCell(this, 'ppeItems', ${index}, 'type')">${item.type}</td>
                    <td class="editable" onclick="editTableCell(this, 'ppeItems', ${index}, 'size')">${item.size}</td>
                    <td class="editable" onclick="editTableCell(this, 'ppeItems', ${index}, 'brand')">${item.brand}</td>
                    <td class="editable" onclick="editTableCell(this, 'ppeItems', ${index}, 'quantity')">${item.quantity}</td>
                    <td class="editable" onclick="editTableCell(this, 'ppeItems', ${index}, 'location')">${item.location}</td>
                    <td class="editable" onclick="editTableCell(this, 'ppeItems', ${index}, 'status')">${item.status}</td>
                    <td class="editable" onclick="editTableCell(this, 'ppeItems', ${index}, 'lastInspection')">${item.lastInspection}</td>
                    <td class="editable" onclick="editTableCell(this, 'ppeItems', ${index}, 'nextInspection')">${item.nextInspection}</td>
                    <td class="editable" onclick="editTableCell(this, 'ppeItems', ${index}, 'condition')">${item.condition}</td>
                    <td>
                        <button class="btn btn-sm btn-outline" onclick="deleteItem('ppeItems', ${index})">Delete</button>
                    </td>
                `;
                table.appendChild(row);
            });
        }

        function loadPPEIssuanceTable() {
            const table = document.getElementById('ppeIssuanceTableBody');
            if (!table) return;
            
            table.innerHTML = '';
            
            ppeIssuance.forEach((record, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="editable" onclick="editTableCell(this, 'ppeIssuance', ${index}, 'id')">${record.id}</td>
                    <td class="editable" onclick="editTableCell(this, 'ppeIssuance', ${index}, 'ppeId')">${record.ppeId}</td>
                    <td class="editable" onclick="editTableCell(this, 'ppeIssuance', ${index}, 'employee')">${record.employee}</td>
                    <td class="editable" onclick="editTableCell(this, 'ppeIssuance', ${index}, 'issueDate')">${record.issueDate}</td>
                    <td class="editable" onclick="editTableCell(this, 'ppeIssuance', ${index}, 'expiryDate')">${record.expiryDate}</td>
                    <td class="editable" onclick="editTableCell(this, 'ppeIssuance', ${index}, 'issuedBy')">${record.issuedBy}</td>
                    <td class="editable" onclick="editTableCell(this, 'ppeIssuance', ${index}, 'returnDate')">${record.returnDate}</td>
                    <td class="editable" onclick="editTableCell(this, 'ppeIssuance', ${index}, 'status')">${record.status}</td>
                    <td>
                        <button class="btn btn-sm btn-outline" onclick="deleteItem('ppeIssuance', ${index})">Delete</button>
                    </td>
                `;
                table.appendChild(row);
            });
        }

        function loadHealthTable() {
            const table = document.getElementById('healthTableBody');
            if (!table) return;
            
            table.innerHTML = '';
            
            healthRecords.forEach((record, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="editable" onclick="editTableCell(this, 'healthRecords', ${index}, 'id')">${record.id}</td>
                    <td class="editable" onclick="editTableCell(this, 'healthRecords', ${index}, 'name')">${record.name}</td>
                    <td class="editable" onclick="editTableCell(this, 'healthRecords', ${index}, 'location')">${record.location}</td>
                    <td class="editable" onclick="editTableCell(this, 'healthRecords', ${index}, 'position')">${record.position}</td>
                    <td class="editable" onclick="editTableCell(this, 'healthRecords', ${index}, 'lastMedical')">${record.lastMedical}</td>
                    <td class="editable" onclick="editTableCell(this, 'healthRecords', ${index}, 'nextDue')">${record.nextDue}</td>
                    <td class="editable" onclick="editTableCell(this, 'healthRecords', ${index}, 'bloodGroup')">${record.bloodGroup}</td>
                    <td class="editable" onclick="editTableCell(this, 'healthRecords', ${index}, 'allergies')">${record.allergies}</td>
                    <td class="editable" onclick="editTableCell(this, 'healthRecords', ${index}, 'medicalStatus')">${record.medicalStatus}</td>
                    <td class="editable" onclick="editTableCell(this, 'healthRecords', ${index}, 'emergencyContact')">${record.emergencyContact}</td>
                    <td>
                        <button class="btn btn-sm btn-outline" onclick="deleteItem('healthRecords', ${index})">Delete</button>
                    </td>
                `;
                table.appendChild(row);
            });
        }

        function loadContractorTable() {
            const table = document.getElementById('contractorTableBody');
            if (!table) return;
            
            table.innerHTML = '';
            
            contractors.forEach((contractor, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="editable" onclick="editTableCell(this, 'contractors', ${index}, 'id')">${contractor.id}</td>
                    <td class="editable" onclick="editTableCell(this, 'contractors', ${index}, 'company')">${contractor.company}</td>
                    <td class="editable" onclick="editTableCell(this, 'contractors', ${index}, 'contactPerson')">${contractor.contactPerson}</td>
                    <td class="editable" onclick="editTableCell(this, 'contractors', ${index}, 'phone')">${contractor.phone}</td>
                    <td class="editable" onclick="editTableCell(this, 'contractors', ${index}, 'email')">${contractor.email}</td>
                    <td class="editable" onclick="editTableCell(this, 'contractors', ${index}, 'workType')">${contractor.workType}</td>
                    <td class="editable" onclick="editTableCell(this, 'contractors', ${index}, 'location')">${contractor.location}</td>
                    <td class="editable" onclick="editTableCell(this, 'contractors', ${index}, 'startDate')">${contractor.startDate}</td>
                    <td class="editable" onclick="editTableCell(this, 'contractors', ${index}, 'endDate')">${contractor.endDate}</td>
                    <td class="editable" onclick="editTableCell(this, 'contractors', ${index}, 'safetyRating')">${contractor.safetyRating}</td>
                    <td class="editable" onclick="editTableCell(this, 'contractors', ${index}, 'status')">${contractor.status}</td>
                    <td>
                        <button class="btn btn-sm btn-outline" onclick="deleteItem('contractors', ${index})">Delete</button>
                    </td>
                `;
                table.appendChild(row);
            });
        }

        function loadContractorPermitsTable() {
            const table = document.getElementById('contractorPermitsTableBody');
            if (!table) return;
            
            table.innerHTML = '';
            
            contractorPermits.forEach((permit, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="editable" onclick="editTableCell(this, 'contractorPermits', ${index}, 'id')">${permit.id}</td>
                    <td class="editable" onclick="editTableCell(this, 'contractorPermits', ${index}, 'contractor')">${permit.contractor}</td>
                    <td class="editable" onclick="editTableCell(this, 'contractorPermits', ${index}, 'workType')">${permit.workType}</td>
                    <td class="editable" onclick="editTableCell(this, 'contractorPermits', ${index}, 'location')">${permit.location}</td>
                    <td class="editable" onclick="editTableCell(this, 'contractorPermits', ${index}, 'issuedDate')">${permit.issuedDate}</td>
                    <td class="editable" onclick="editTableCell(this, 'contractorPermits', ${index}, 'expiryDate')">${permit.expiryDate}</td>
                    <td class="editable" onclick="editTableCell(this, 'contractorPermits', ${index}, 'issuedBy')">${permit.issuedBy}</td>
                    <td class="editable" onclick="editTableCell(this, 'contractorPermits', ${index}, 'status')">${permit.status}</td>
                    <td>
                        <button class="btn btn-sm btn-outline" onclick="deleteItem('contractorPermits', ${index})">Delete</button>
                    </td>
                `;
                table.appendChild(row);
            });
        }

        function loadAuditTable() {
            const table = document.getElementById('auditTableBody');
            if (!table) return;
            
            table.innerHTML = '';
            
            audits.forEach((audit, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="editable" onclick="editTableCell(this, 'audits', ${index}, 'id')">${audit.id}</td>
                    <td class="editable" onclick="editTableCell(this, 'audits', ${index}, 'type')">${audit.type}</td>
                    <td class="editable" onclick="editTableCell(this, 'audits', ${index}, 'location')">${audit.location}</td>
                    <td class="editable" onclick="editTableCell(this, 'audits', ${index}, 'auditDate')">${audit.auditDate}</td>
                    <td class="editable" onclick="editTableCell(this, 'audits', ${index}, 'auditor')">${audit.auditor}</td>
                    <td class="editable" onclick="editTableCell(this, 'audits', ${index}, 'score')">${audit.score}</td>
                    <td class="editable" onclick="editTableCell(this, 'audits', ${index}, 'status')">${audit.status}</td>
                    <td class="editable" onclick="editTableCell(this, 'audits', ${index}, 'findings')">${audit.findings}</td>
                    <td class="editable" onclick="editTableCell(this, 'audits', ${index}, 'correctiveActions')">${audit.correctiveActions}</td>
                    <td class="editable" onclick="editTableCell(this, 'audits', ${index}, 'nextAudit')">${audit.nextAudit}</td>
                    <td>
                        <button class="btn btn-sm btn-outline" onclick="deleteItem('audits', ${index})">Delete</button>
                    </td>
                `;
                table.appendChild(row);
            });
        }

        function loadAuditScheduleTable() {
            const table = document.getElementById('auditScheduleTableBody');
            if (!table) return;
            
            table.innerHTML = '';
            
            auditSchedule.forEach((schedule, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="editable" onclick="editTableCell(this, 'auditSchedule', ${index}, 'id')">${schedule.id}</td>
                    <td class="editable" onclick="editTableCell(this, 'auditSchedule', ${index}, 'auditType')">${schedule.auditType}</td>
                    <td class="editable" onclick="editTableCell(this, 'auditSchedule', ${index}, 'location')">${schedule.location}</td>
                    <td class="editable" onclick="editTableCell(this, 'auditSchedule', ${index}, 'scheduledDate')">${schedule.scheduledDate}</td>
                    <td class="editable" onclick="editTableCell(this, 'auditSchedule', ${index}, 'frequency')">${schedule.frequency}</td>
                    <td class="editable" onclick="editTableCell(this, 'auditSchedule', ${index}, 'assignedTo')">${schedule.assignedTo}</td>
                    <td class="editable" onclick="editTableCell(this, 'auditSchedule', ${index}, 'status')">${schedule.status}</td>
                    <td class="editable" onclick="editTableCell(this, 'auditSchedule', ${index}, 'priority')">${schedule.priority}</td>
                    <td>
                        <button class="btn btn-sm btn-outline" onclick="deleteItem('auditSchedule', ${index})">Delete</button>
                    </td>
                `;
                table.appendChild(row);
            });
        }

        // Standards Management
        function loadStandards() {
            const grid = document.getElementById('standardsGrid');
            if (!grid) return;
            
            grid.innerHTML = '';
            
            standards.forEach((standard, index) => {
                const card = document.createElement('div');
                card.className = 'standard-card';
                
                let statusClass = 'status-pending';
                if (standard.status === 'Compliant') statusClass = 'status-compliant';
                else if (standard.status === 'Non-Compliant') statusClass = 'status-noncompliant';
                else if (standard.status === 'In Progress') statusClass = 'status-inprogress';
                
                card.innerHTML = `
                    <div class="standard-badge ${standard.type === 'International' ? 'badge-international' : 'badge-national'}">
                        ${standard.type}
                    </div>
                    <h3>${standard.name}</h3>
                    <div class="standard-code">${standard.code}</div>
                    <div class="standard-industry">${standard.country || 'All Countries'}</div>
                    <div class="standard-status ${statusClass}">${standard.status}</div>
                    <p style="font-size: 0.9rem; margin-bottom: 1rem; color: var(--text-light);">
                        ${standard.description.substring(0, 150)}...
                    </p>
                    <div style="font-size: 0.8rem; color: var(--text-light); margin-bottom: 1rem;">
                        <strong>Effective:</strong> ${standard.effectiveDate || 'N/A'}
                    </div>
                    <div style="font-size: 0.8rem; color: var(--text-light); margin-bottom: 1rem;">
                        <strong>Remarks:</strong> ${standard.remarks || 'No remarks'}
                    </div>
                    <div class="standard-actions">
                        <button class="btn btn-sm btn-outline" onclick="editStandard(${index})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteStandard(${index})">Delete</button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function addStandard() {
            editingStandardIndex = -1;
            document.getElementById('standardModalTitle').textContent = 'Add New Standard';
            document.getElementById('deleteStandardBtn').style.display = 'none';
            document.getElementById('standardSuccess').style.display = 'none';
            document.getElementById('standardError').style.display = 'none';
            
            // Clear form
            document.getElementById('standardName').value = '';
            document.getElementById('standardCode').value = '';
            document.getElementById('standardType').value = '';
            document.getElementById('standardCountry').value = '';
            document.getElementById('standardDescription').value = '';
            document.getElementById('standardStatus').value = '';
            document.getElementById('standardEffectiveDate').value = '';
            document.getElementById('standardRemarks').value = '';
            document.getElementById('standardFormFilesList').innerHTML = '';
            
            openModal('standardModal');
        }

        function editStandard(index) {
            editingStandardIndex = index;
            const standard = standards[index];
            
            document.getElementById('standardModalTitle').textContent = 'Edit Standard';
            document.getElementById('deleteStandardBtn').style.display = 'inline-flex';
            document.getElementById('standardSuccess').style.display = 'none';
            document.getElementById('standardError').style.display = 'none';
            
            // Fill form
            document.getElementById('standardName').value = standard.name;
            document.getElementById('standardCode').value = standard.code;
            document.getElementById('standardType').value = standard.type;
            document.getElementById('standardCountry').value = standard.country || '';
            document.getElementById('standardDescription').value = standard.description;
            document.getElementById('standardStatus').value = standard.status;
            document.getElementById('standardEffectiveDate').value = standard.effectiveDate || '';
            document.getElementById('standardRemarks').value = standard.remarks || '';
            
            openModal('standardModal');
        }

        function saveStandard() {
            // Get form values
            const name = document.getElementById('standardName').value;
            const code = document.getElementById('standardCode').value;
            const type = document.getElementById('standardType').value;
            const country = document.getElementById('standardCountry').value;
            const description = document.getElementById('standardDescription').value;
            const status = document.getElementById('standardStatus').value;
            const effectiveDate = document.getElementById('standardEffectiveDate').value;
            const remarks = document.getElementById('standardRemarks').value;
            
            // Validation
            if (!name || !code || !type || !description || !status) {
                document.getElementById('standardError').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('standardError').style.display = 'none';
                }, 3000);
                return;
            }
            
            if (editingStandardIndex >= 0) {
                // Update existing standard
                standards[editingStandardIndex] = {
                    ...standards[editingStandardIndex],
                    name,
                    code,
                    type,
                    country,
                    description,
                    status,
                    effectiveDate,
                    remarks,
                    updatedAt: new Date().toISOString()
                };
            } else {
                // Add new standard
                const newStandard = {
                    id: `STD-${new Date().getFullYear()}-${(standards.length + 1).toString().padStart(3, '0')}`,
                    name,
                    code,
                    type,
                    country,
                    description,
                    status,
                    effectiveDate,
                    remarks,
                    createdAt: new Date().toISOString()
                };
                standards.push(newStandard);
            }
            
            saveAllData();
            loadStandards();
            updateStatistics();
            
            // Show success message
            document.getElementById('standardSuccess').style.display = 'block';
            
            // Close modal after delay
            setTimeout(() => {
                closeModal('standardModal');
                document.getElementById('standardSuccess').style.display = 'none';
            }, 2000);
        }

        function deleteStandard(index) {
            showConfirmDialog('Delete Standard', 'Are you sure you want to delete this standard?', function() {
                standards.splice(index, 1);
                saveAllData();
                loadStandards();
                updateStatistics();
                showToast('Deleted', 'Standard deleted successfully!', 'success');
            });
        }

        // Attachment Functions
        function populateDropdowns() {
            populateHealthEmployeeSelect();
            populateContractorSelect();
            populateAuditSelect();
            populateTrainingEmployeeSelect();
            populatePPEItemSelect();
            populateIncidentSelect();
            populateStandardSelect();
        }

        function populateHealthEmployeeSelect() {
            const select = document.getElementById('healthEmployeeSelect');
            if (!select) return;
            
            select.innerHTML = '<option value="">Select employee</option>';
            healthRecords.forEach(record => {
                const option = document.createElement('option');
                option.value = record.id;
                option.textContent = `${record.name} (${record.id})`;
                select.appendChild(option);
            });
        }

        function populateTrainingEmployeeSelect() {
            const select = document.getElementById('trainingEmployeeSelect');
            if (!select) return;
            
            select.innerHTML = '<option value="">Select employee</option>';
            healthRecords.forEach(record => {
                const option = document.createElement('option');
                option.value = record.id;
                option.textContent = `${record.name}`;
                select.appendChild(option);
            });
        }

        function populateContractorSelect() {
            const select = document.getElementById('contractorSelect');
            if (!select) return;
            
            select.innerHTML = '<option value="">Select contractor</option>';
            contractors.forEach(contractor => {
                const option = document.createElement('option');
                option.value = contractor.id;
                option.textContent = `${contractor.company} (${contractor.id})`;
                select.appendChild(option);
            });
        }

        function populateAuditSelect() {
            const select = document.getElementById('auditSelect');
            if (!select) return;
            
            select.innerHTML = '<option value="">Select audit</option>';
            audits.forEach(audit => {
                const option = document.createElement('option');
                option.value = audit.id;
                option.textContent = `${audit.type} - ${audit.location} (${audit.id})`;
                select.appendChild(option);
            });
        }

        function populatePPEItemSelect() {
            const select = document.getElementById('ppeItemSelect');
            if (!select) return;
            
            select.innerHTML = '<option value="">Select PPE item</option>';
            ppeItems.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = `${item.type} - ${item.location} (${item.id})`;
                select.appendChild(option);
            });
        }

        function populateIncidentSelect() {
            const select = document.getElementById('incidentSelect');
            if (!select) return;
            
            select.innerHTML = '<option value="">Select incident</option>';
            incidents.forEach(incident => {
                const option = document.createElement('option');
                option.value = incident.id;
                option.textContent = `${incident.type} - ${incident.location} (${incident.id})`;
                select.appendChild(option);
            });
        }

        function populateStandardSelect() {
            const select = document.getElementById('standardSelect');
            if (!select) return;
            
            select.innerHTML = '<option value="">Select standard</option>';
            standards.forEach(standard => {
                const option = document.createElement('option');
                option.value = standard.id;
                option.textContent = `${standard.name} (${standard.code})`;
                select.appendChild(option);
            });
        }

        function switchTab(tabName, modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            
            // Update tab buttons
            modal.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update tab content
            modal.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            modal.querySelector(`#${tabName}`).classList.add('active');
        }

        function loadAttachments(attachmentType, selectId, listId) {
            const select = document.getElementById(selectId);
            const list = document.getElementById(listId);
            
            if (!select || !list) return;
            
            const selectedId = select.value;
            if (!selectedId) {
                list.innerHTML = '<div style="text-align: center; color: var(--text-light); padding: 2rem;">Select an item to view attachments</div>';
                return;
            }
            
            const itemAttachments = attachments[attachmentType][selectedId] || [];
            
            if (itemAttachments.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: var(--text-light); padding: 2rem;">No attachments found</div>';
                return;
            }
            
            list.innerHTML = '';
            itemAttachments.forEach((attachment, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div>
                        <div style="font-weight: 500;">${attachment.name}</div>
                        <div style="font-size: 0.75rem; color: var(--text-light);">${attachment.type} ‚Ä¢ ${attachment.size} ‚Ä¢ ${new Date(attachment.uploaded).toLocaleDateString()}</div>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="deleteAttachment('${attachmentType}', '${selectedId}', ${index})">Delete</button>
                `;
                list.appendChild(fileItem);
            });
        }

        function uploadAttachment(attachmentType, selectId, fileInputId) {
            const select = document.getElementById(selectId);
            const fileInput = document.getElementById(fileInputId);
            
            if (!select || !fileInput) return;
            
            const selectedId = select.value;
            if (!selectedId) {
                showToast('Error', 'Please select an item first', 'error');
                return;
            }
            
            if (fileInput.files.length === 0) return;
            
            const files = Array.from(fileInput.files);
            files.forEach(file => {
                const attachment = {
                    name: file.name,
                    type: file.type,
                    size: formatFileSize(file.size),
                    uploaded: new Date().toISOString()
                };
                
                if (!attachments[attachmentType][selectedId]) {
                    attachments[attachmentType][selectedId] = [];
                }
                
                attachments[attachmentType][selectedId].push(attachment);
            });
            
            saveAllData();
            loadAttachments(attachmentType, selectId, `${attachmentType}AttachmentsList`);
            showToast('Success', `${files.length} file(s) uploaded successfully`, 'success');
            
            // Clear file input
            fileInput.value = '';
        }

        function deleteAttachment(attachmentType, itemId, index) {
            if (attachments[attachmentType][itemId]) {
                attachments[attachmentType][itemId].splice(index, 1);
                saveAllData();
                loadAttachments(attachmentType, `${attachmentType}Select`, `${attachmentType}AttachmentsList`);
                showToast('Success', 'Attachment deleted successfully', 'success');
            }
        }

        // Specific attachment functions for each module
        function loadHealthAttachments() {
            loadAttachments('health', 'healthEmployeeSelect', 'healthAttachmentsList');
        }

        function uploadHealthAttachment() {
            uploadAttachment('health', 'healthEmployeeSelect', 'healthFileInput');
        }

        function loadContractorAttachments() {
            loadAttachments('contractor', 'contractorSelect', 'contractorAttachmentsList');
        }

        function uploadContractorAttachment() {
            uploadAttachment('contractor', 'contractorSelect', 'contractorFileInput');
        }

        function loadAuditAttachments() {
            loadAttachments('audit', 'auditSelect', 'auditAttachmentsList');
        }

        function uploadAuditAttachment() {
            uploadAttachment('audit', 'auditSelect', 'auditFileInput');
        }

        function loadTrainingCertificates() {
            loadAttachments('training', 'trainingEmployeeSelect', 'trainingCertificatesList');
        }

        function uploadTrainingCertificate() {
            uploadAttachment('training', 'trainingEmployeeSelect', 'trainingFileInput');
        }

        function loadPPEDocuments() {
            loadAttachments('ppe', 'ppeItemSelect', 'ppeDocumentsList');
        }

        function uploadPPEDocument() {
            uploadAttachment('ppe', 'ppeItemSelect', 'ppeFileInput');
        }

        function loadIncidentAttachments() {
            loadAttachments('incidents', 'incidentSelect', 'incidentAttachmentsList');
        }

        function uploadIncidentAttachment() {
            uploadAttachment('incidents', 'incidentSelect', 'incidentModalFileInput');
        }

        function loadStandardAttachments() {
            loadAttachments('standards', 'standardSelect', 'standardAttachmentsList');
        }

        function uploadStandardAttachment() {
            uploadAttachment('standards', 'standardSelect', 'standardFileInput');
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Add New Items Functions
        function addTrainingRecord() {
            const newRecord = {
                id: `TRN-${new Date().getFullYear()}-${(trainingRecords.length + 1).toString().padStart(3, '0')}`,
                employee: 'Cephas Gideon Mkama',
                trainingType: 'New Training',
                provider: 'Training Provider',
                startDate: new Date().toISOString().split('T')[0],
                endDate: '',
                status: 'Scheduled',
                score: '',
                expiryDate: '',
                notes: ''
            };
            
            trainingRecords.push(newRecord);
            saveAllData();
            loadTrainingTable();
            showToast('Success', 'New training record added!', 'success');
        }

        function addPPEItem() {
            const newItem = {
                id: `PPE-${new Date().getFullYear()}-${(ppeItems.length + 1).toString().padStart(3, '0')}`,
                type: 'New Equipment',
                size: 'M',
                brand: 'Brand',
                quantity: 10,
                location: 'Cape Town HQ',
                status: 'In Stock',
                lastInspection: new Date().toISOString().split('T')[0],
                nextInspection: new Date(new Date().setFullYear(new Date().getFullYear() + 1)).toISOString().split('T')[0],
                condition: 'New'
            };
            
            ppeItems.push(newItem);
            saveAllData();
            loadPPETable();
            populatePPEItemSelect();
            showToast('Success', 'New PPE item added!', 'success');
        }

        function issuePPE() {
            const newIssuance = {
                id: `ISS-${new Date().getFullYear()}-${(ppeIssuance.length + 1).toString().padStart(3, '0')}`,
                ppeId: 'PPE-001',
                employee: 'Select Employee',
                issueDate: new Date().toISOString().split('T')[0],
                expiryDate: new Date(new Date().setFullYear(new Date().getFullYear() + 1)).toISOString().split('T')[0],
                issuedBy: 'Safety Officer',
                returnDate: '',
                status: 'Issued'
            };
            
            ppeIssuance.push(newIssuance);
            saveAllData();
            loadPPEIssuanceTable();
            showToast('Success', 'PPE issued successfully!', 'success');
        }

        function addHealthRecord() {
            const newRecord = {
                id: `EMP-NEW-${(healthRecords.length + 1).toString().padStart(3, '0')}`,
                name: 'New Employee',
                location: 'Select Location',
                position: '',
                lastMedical: '',
                nextDue: '',
                bloodGroup: '',
                allergies: '',
                medicalStatus: 'Pending',
                emergencyContact: ''
            };
            
            healthRecords.push(newRecord);
            saveAllData();
            loadHealthTable();
            populateHealthEmployeeSelect();
            populateTrainingEmployeeSelect();
            populateEmployeeSelects();
            showToast('Success', 'New health record added!', 'success');
        }

        function addContractor() {
            const newContractor = {
                id: `CTR-${new Date().getFullYear()}-${(contractors.length + 1).toString().padStart(3, '0')}`,
                company: 'New Contractor Company',
                contactPerson: 'Contact Name',
                phone: '',
                email: '',
                workType: 'Construction',
                location: 'Cape Town HQ',
                startDate: new Date().toISOString().split('T')[0],
                endDate: new Date(new Date().setFullYear(new Date().getFullYear() + 1)).toISOString().split('T')[0],
                safetyRating: 'B',
                status: 'Pending Approval'
            };
            
            contractors.push(newContractor);
            saveAllData();
            loadContractorTable();
            populateContractorSelect();
            showToast('Success', 'New contractor added!', 'success');
        }

        function issuePermit() {
            const newPermit = {
                id: `PER-${new Date().getFullYear()}-${(contractorPermits.length + 1).toString().padStart(3, '0')}`,
                contractor: 'Select Contractor',
                workType: 'Construction',
                location: 'Cape Town HQ',
                issuedDate: new Date().toISOString().split('T')[0],
                expiryDate: new Date(new Date().setMonth(new Date().getMonth() + 3)).toISOString().split('T')[0],
                issuedBy: 'Safety Officer',
                status: 'Active'
            };
            
            contractorPermits.push(newPermit);
            saveAllData();
            loadContractorPermitsTable();
            showToast('Success', 'Permit issued successfully!', 'success');
        }

        function addAudit() {
            const newAudit = {
                id: `AUD-${new Date().getFullYear()}-${(audits.length + 1).toString().padStart(3, '0')}`,
                type: 'Safety Audit',
                location: 'Cape Town HQ',
                auditDate: new Date().toISOString().split('T')[0],
                auditor: 'Safety Officer',
                score: '0%',
                status: 'Scheduled',
                findings: '',
                correctiveActions: '',
                nextAudit: new Date(new Date().setMonth(new Date().getMonth() + 6)).toISOString().split('T')[0]
            };
            
            audits.push(newAudit);
            saveAllData();
            loadAuditTable();
            populateAuditSelect();
            updateStatistics();
            showToast('Success', 'New audit added!', 'success');
        }

        function scheduleAudit() {
            const newSchedule = {
                id: `SCH-${new Date().getFullYear()}-${(auditSchedule.length + 1).toString().padStart(3, '0')}`,
                auditType: 'Safety Audit',
                location: 'Cape Town HQ',
                scheduledDate: new Date(new Date().setMonth(new Date().getMonth() + 1)).toISOString().split('T')[0],
                frequency: 'Monthly',
                assignedTo: 'Safety Officer',
                status: 'Scheduled',
                priority: 'Medium'
            };
            
            auditSchedule.push(newSchedule);
            saveAllData();
            loadAuditScheduleTable();
            showToast('Success', 'Audit scheduled!', 'success');
        }

        // Table Cell Editing
        function editTableCell(cell, dataType, index, field) {
            if (editingCell) return;
            
            editingCell = cell;
            const originalValue = cell.textContent;
            
            // Determine input type based on field
            let inputType = 'text';
            let options = [];
            
            if (field === 'severity') {
                options = ['Minor', 'Moderate', 'Serious', 'Critical'];
                inputType = 'select';
            } else if (field === 'status') {
                if (dataType === 'incidents') options = ['Reported', 'Under Investigation', 'Resolved', 'Closed'];
                else if (dataType === 'trainingRecords') options = ['Scheduled', 'In Progress', 'Completed', 'Cancelled'];
                else if (dataType === 'ppeItems') options = ['In Stock', 'Issued', 'Damaged', 'Expired'];
                else if (dataType === 'healthRecords') options = ['Fit', 'Pending', 'Unfit', 'Restricted'];
                else if (dataType === 'contractors') options = ['Active', 'Pending Approval', 'Suspended', 'Terminated'];
                else if (dataType === 'audits') options = ['Scheduled', 'In Progress', 'Completed', 'Cancelled'];
                inputType = 'select';
            } else if (field === 'type' && dataType === 'incidents') {
                options = ['Near Miss', 'First Aid', 'Medical Treatment', 'Lost Time Injury', 'Property Damage', 'Environmental Incident'];
                inputType = 'select';
            } else if (field === 'location') {
                options = locations.map(l => l.name);
                inputType = 'select';
            } else if (field === 'date' || field.includes('Date')) {
                inputType = 'date';
            }
            
            cell.classList.add('editing');
            cell.innerHTML = '';
            
            if (inputType === 'select') {
                const select = document.createElement('select');
                select.className = 'edit-select';
                select.style.width = '100%';
                
                options.forEach(option => {
                    const opt = document.createElement('option');
                    opt.value = option;
                    opt.textContent = option;
                    if (option === originalValue) opt.selected = true;
                    select.appendChild(opt);
                });
                
                select.onblur = function() {
                    saveTableCell(dataType, index, field, this.value, cell);
                };
                
                select.onkeypress = function(e) {
                    if (e.key === 'Enter') {
                        saveTableCell(dataType, index, field, this.value, cell);
                    }
                };
                
                cell.appendChild(select);
                select.focus();
            } else if (inputType === 'date') {
                const input = document.createElement('input');
                input.type = 'date';
                input.className = 'edit-input';
                input.value = originalValue;
                
                input.onblur = function() {
                    saveTableCell(dataType, index, field, this.value, cell);
                };
                
                input.onkeypress = function(e) {
                    if (e.key === 'Enter') {
                        saveTableCell(dataType, index, field, this.value, cell);
                    }
                };
                
                cell.appendChild(input);
                input.focus();
            } else {
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'edit-input';
                input.value = originalValue;
                
                input.onblur = function() {
                    saveTableCell(dataType, index, field, this.value, cell);
                };
                
                input.onkeypress = function(e) {
                    if (e.key === 'Enter') {
                        saveTableCell(dataType, index, field, this.value, cell);
                    }
                };
                
                cell.appendChild(input);
                input.focus();
                input.select();
            }
        }

        function saveTableCell(dataType, index, field, value, cell) {
            // Get the appropriate data array
            let dataArray;
            switch(dataType) {
                case 'incidents': dataArray = incidents; break;
                case 'ppeItems': dataArray = ppeItems; break;
                case 'ppeIssuance': dataArray = ppeIssuance; break;
                case 'healthRecords': dataArray = healthRecords; break;
                case 'contractors': dataArray = contractors; break;
                case 'contractorPermits': dataArray = contractorPermits; break;
                case 'audits': dataArray = audits; break;
                case 'auditSchedule': dataArray = auditSchedule; break;
                case 'standards': dataArray = standards; break;
                case 'trainingRecords': dataArray = trainingRecords; break;
                default: return;
            }
            
            // Update the data
            if (dataArray[index]) {
                dataArray[index][field] = value;
                
                // Format display value for dates
                let displayValue = value;
                if (field === 'date' || field.includes('Date')) {
                    const date = new Date(value);
                    if (!isNaN(date.getTime())) {
                        displayValue = date.toLocaleDateString('en-US', {
                            month: 'short',
                            day: 'numeric',
                            year: 'numeric'
                        });
                    }
                }
                
                // Update cell display
                cell.textContent = displayValue;
                cell.classList.remove('editing');
                
                // Save data and reload tables
                saveAllData();
                loadAllTables();
                updateStatistics();
                
                showToast('Success', `${field} updated successfully!`, 'success');
            }
            
            editingCell = null;
        }

        // Delete Item Function
        function deleteItem(dataType, index) {
            let dataArray;
            let itemName;
            
            switch(dataType) {
                case 'incidents': 
                    dataArray = incidents;
                    itemName = incidents[index]?.id || 'incident';
                    break;
                case 'ppeItems':
                    dataArray = ppeItems;
                    itemName = ppeItems[index]?.id || 'PPE item';
                    break;
                case 'ppeIssuance':
                    dataArray = ppeIssuance;
                    itemName = ppeIssuance[index]?.id || 'PPE issuance';
                    break;
                case 'healthRecords':
                    dataArray = healthRecords;
                    itemName = healthRecords[index]?.id || 'health record';
                    break;
                case 'contractors':
                    dataArray = contractors;
                    itemName = contractors[index]?.id || 'contractor';
                    break;
                case 'contractorPermits':
                    dataArray = contractorPermits;
                    itemName = contractorPermits[index]?.id || 'permit';
                    break;
                case 'audits':
                    dataArray = audits;
                    itemName = audits[index]?.id || 'audit';
                    break;
                case 'auditSchedule':
                    dataArray = auditSchedule;
                    itemName = auditSchedule[index]?.id || 'audit schedule';
                    break;
                case 'standards':
                    dataArray = standards;
                    itemName = standards[index]?.id || 'standard';
                    break;
                case 'trainingRecords':
                    dataArray = trainingRecords;
                    itemName = trainingRecords[index]?.id || 'training record';
                    break;
                default: return;
            }
            
            showConfirmDialog('Delete Item', `Are you sure you want to delete ${itemName}?`, function() {
                dataArray.splice(index, 1);
                saveAllData();
                loadAllTables();
                updateStatistics();
                populateDropdowns();
                showToast('Deleted', `${itemName} deleted successfully!`, 'success');
            });
        }

        // Incident Report Function
        function submitIncidentReport() {
            // Get form values
            const type = document.getElementById('incidentType').value;
            const severity = document.getElementById('incidentSeverity').value;
            const dateTime = document.getElementById('incidentDateTime').value;
            const location = document.getElementById('incidentLocation').value;
            const reportedBy = document.getElementById('reportedBy').value;
            const department = document.getElementById('incidentDepartment').value;
            const description = document.getElementById('incidentDescription').value;
            const actions = document.getElementById('immediateActions').value;
            const recommendations = document.getElementById('recommendations').value;
            
            // Validation
            if (!type || !severity || !dateTime || !location || !reportedBy || !department || !description) {
                document.getElementById('reportError').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('reportError').style.display = 'none';
                }, 3000);
                return;
            }
            
            // Create new incident
            const newIncident = {
                id: `INC-${new Date().getFullYear()}-${(incidents.length + 1).toString().padStart(3, '0')}`,
                type: type,
                severity: severity,
                location: location,
                reportedBy: reportedBy,
                department: department,
                date: dateTime,
                status: 'Reported',
                description: description,
                actions: actions,
                recommendations: recommendations,
                createdAt: new Date().toISOString()
            };
            
            incidents.unshift(newIncident);
            saveAllData();
            
            // Show success message
            document.getElementById('reportSuccess').style.display = 'block';
            
            // Clear form
            document.getElementById('incidentType').value = '';
            document.getElementById('incidentSeverity').value = '';
            document.getElementById('incidentDateTime').value = '';
            document.getElementById('incidentLocation').value = '';
            document.getElementById('reportedBy').value = '';
            document.getElementById('incidentDepartment').value = '';
            document.getElementById('incidentDescription').value = '';
            document.getElementById('immediateActions').value = '';
            document.getElementById('recommendations').value = '';
            
            // Update UI
            loadAllTables();
            updateStatistics();
            populateIncidentSelect();
            
            // Close modal after delay
            setTimeout(() => {
                closeModal('reportIncidentModal');
                document.getElementById('reportSuccess').style.display = 'none';
            }, 2000);
        }

        // Export Functions
        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(20);
            doc.text('Metal Management Solutions', 20, 20);
            doc.setFontSize(16);
            doc.text('Health & Safety Dashboard Report', 20, 30);
            doc.setFontSize(12);
            doc.text(`Generated: ${new Date().toLocaleDateString()}`, 20, 40);
            
            // Add statistics
            doc.setFontSize(14);
            doc.text('Safety Statistics', 20, 55);
            doc.setFontSize(10);
            doc.text(`Lost Time Injuries: ${document.getElementById('lostTimeInjuries').textContent}`, 20, 65);
            doc.text(`Safety Trainings: ${document.getElementById('safetyTrainings').textContent}`, 20, 72);
            doc.text(`Compliance Rate: ${document.getElementById('complianceRate').textContent}`, 20, 79);
            doc.text(`Active Audits: ${document.getElementById('activeAudits').textContent}`, 20, 86);
            
            doc.save(`mms-safety-dashboard-${new Date().toISOString().split('T')[0]}.pdf`);
            showToast('Success', 'Dashboard exported to PDF', 'success');
        }

        function exportTableToPDF(tableId) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(20);
            doc.text('Metal Management Solutions', 20, 20);
            doc.setFontSize(16);
            doc.text('Safety Data Export', 20, 30);
            doc.setFontSize(12);
            doc.text(`Generated: ${new Date().toLocaleDateString()}`, 20, 40);
            
            // Get table data based on tableId
            let data = [];
            let title = '';
            
            switch(tableId) {
                case 'incidentsTable':
                    data = incidents;
                    title = 'Incidents Report';
                    break;
                case 'trainingTable':
                    data = trainingRecords;
                    title = 'Training Records';
                    break;
                case 'ppeTable':
                    data = ppeItems;
                    title = 'PPE Inventory';
                    break;
                case 'healthTable':
                    data = healthRecords;
                    title = 'Employee Health Records';
                    break;
                case 'contractorTable':
                    data = contractors;
                    title = 'Contractor Safety';
                    break;
                case 'auditTable':
                    data = audits;
                    title = 'Audit Reports';
                    break;
            }
            
            doc.setFontSize(14);
            doc.text(title, 20, 55);
            
            let y = 65;
            data.forEach((item, index) => {
                if (y > 270) {
                    doc.addPage();
                    y = 20;
                }
                doc.setFontSize(10);
                doc.text(JSON.stringify(item, null, 2), 20, y, { maxWidth: 170 });
                y += 40;
            });
            
            doc.save(`mms-${tableId}-${new Date().toISOString().split('T')[0]}.pdf`);
            showToast('Success', `${title} exported to PDF`, 'success');
        }

        function exportStandardsToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(20);
            doc.text('Metal Management Solutions', 20, 20);
            doc.setFontSize(16);
            doc.text('Standards Compliance Report', 20, 30);
            doc.setFontSize(12);
            doc.text(`Generated: ${new Date().toLocaleDateString()}`, 20, 40);
            
            let y = 55;
            standards.forEach((standard, index) => {
                if (y > 270) {
                    doc.addPage();
                    y = 20;
                }
                
                doc.setFontSize(12);
                doc.text(`${standard.name} (${standard.code})`, 20, y);
                y += 7;
                
                doc.setFontSize(10);
                doc.text(`Type: ${standard.type} | Status: ${standard.status}`, 20, y);
                y += 5;
                doc.text(`Country: ${standard.country || 'All'} | Effective: ${standard.effectiveDate || 'N/A'}`, 20, y);
                y += 5;
                doc.text(`Description: ${standard.description.substring(0, 100)}...`, 20, y, { maxWidth: 170 });
                y += 10;
                doc.text(`Remarks: ${standard.remarks || 'None'}`, 20, y, { maxWidth: 170 });
                y += 15;
            });
            
            doc.save(`mms-standards-${new Date().toISOString().split('T')[0]}.pdf`);
            showToast('Success', 'Standards exported to PDF', 'success');
        }

        // Toast Notification Functions
        function showToast(title, message, type) {
            const toast = document.getElementById('toast');
            const toastTitle = toast.querySelector('.toast-title');
            const toastMessage = toast.querySelector('.toast-message');
            const toastIcon = toast.querySelector('.toast-icon');
            
            toast.className = `toast toast-${type}`;
            toastTitle.textContent = title;
            toastMessage.textContent = message;
            toastIcon.textContent = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ö†Ô∏è';
            
            toast.classList.add('show');
            
            setTimeout(() => {
                hideToast();
            }, 3000);
        }

        function hideToast() {
            const toast = document.getElementById('toast');
            toast.classList.remove('show');
        }

        // Confirm Dialog Functions
        function showConfirmDialog(title, message, onConfirm) {
            const dialog = document.getElementById('confirmDialog');
            const dialogTitle = document.getElementById('confirmTitle');
            const dialogMessage = document.getElementById('confirmMessage');
            const confirmBtn = document.getElementById('confirmDeleteBtn');
            
            dialogTitle.textContent = title;
            dialogMessage.textContent = message;
            
            confirmBtn.onclick = function() {
                hideConfirmDialog();
                if (onConfirm) onConfirm();
            };
            
            dialog.classList.add('show');
        }

        function hideConfirmDialog() {
            const dialog = document.getElementById('confirmDialog');
            dialog.classList.remove('show');
        }

        // Modal Functions
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
            document.body.style.overflow = 'hidden';
            
            // Reload data for the modal
            switch(modalId) {
                case 'incidentsModal':
                    loadIncidentsTable();
                    break;
                case 'trainingModal':
                    loadTrainingTable();
                    break;
                case 'ppeModal':
                    loadPPETable();
                    loadPPEIssuanceTable();
                    break;
                case 'healthModal':
                    loadHealthTable();
                    break;
                case 'contractorModal':
                    loadContractorTable();
                    loadContractorPermitsTable();
                    break;
                case 'auditModal':
                    loadAuditTable();
                    loadAuditScheduleTable();
                    break;
                case 'standardsModal':
                    loadStandards();
                    break;
                case 'riskModal':
                    loadRiskMatrix();
                    break;
                case 'settingsModal':
                    loadSettings();
                    break;
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // Utility Functions
        function showDashboard() {
            // This would navigate to a dashboard page in a real application
            showToast('Info', 'Dashboard functionality would be implemented here', 'warning');
        }

        function setupEventListeners() {
            // Close modal when clicking outside
            window.onclick = function(event) {
                if (event.target.classList.contains('modal')) {
                    event.target.style.display = 'none';
                    document.body.style.overflow = 'auto';
                }
            };
            
            // Escape key to close modal
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    const modals = document.querySelectorAll('.modal');
                    modals.forEach(modal => {
                        if (modal.style.display === 'block') {
                            modal.style.display = 'none';
                            document.body.style.overflow = 'auto';
                        }
                    });
                }
            });
        }
    </script>
</body>
</html>
